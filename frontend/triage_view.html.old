<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†è¯Šå®¡æ ¸é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¾½ç« åŒºåŸŸ */
        .header {
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .urgency-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .urgency-badge.urgent {
            background: #ef4444;
            color: white;
        }

        .urgency-badge.attention {
            background: #f59e0b;
            color: white;
        }

        .urgency-badge.nonurgent {
            background: #10b981;
            color: white;
        }

        .esi-level {
            display: inline-block;
            margin-left: 15px;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 12px;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #4f46e5;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .section-content {
            color: #4b5563;
        }

        /* è·¯å¾„åˆ†æ”¯æç¤º */
        .path-indicator {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .path-indicator.immediate {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .path-indicator.home {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        /* æ‚£è€…ä¿¡æ¯ */
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .info-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }

        /* ç”¨è¯åˆ—è¡¨ */
        .meds-list {
            list-style: none;
            margin-top: 10px;
        }

        .med-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #4f46e5;
        }

        /* å»ºè®®å¡ç‰‡ */
        .suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .suggestion-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .suggestion-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 10px;
        }

        .suggestion-content {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.8;
        }

        /* å¯èƒ½åŸå› åˆ—è¡¨ */
        .causes-list {
            list-style: none;
            margin-top: 10px;
        }

        .cause-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: white;
            border-radius: 6px;
            display: inline-block;
            margin-right: 8px;
            font-size: 14px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é”™è¯¯æç¤º */
        .error {
            padding: 20px;
            background: #fee2e2;
            color: #991b1b;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¾½ç«  -->
        <div class="header">
            <div id="urgencyBadge" class="urgency-badge hidden"></div>
            <span id="esiLevel" class="esi-level hidden"></span>
            <h1 id="pageTitle" style="margin-top: 15px;">åˆ†è¯Šå®¡æ ¸</h1>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½åˆ†è¯Šæ•°æ®...</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error" class="error hidden"></div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div id="content" class="content hidden">
            <!-- è·¯å¾„åˆ†æ”¯æŒ‡ç¤º -->
            <div id="pathIndicator" class="path-indicator hidden"></div>

            <!-- åˆ†è¯Šç»“è®º -->
            <div class="section">
                <div class="section-title">ğŸ“‹ åˆ†è¯Šç»“è®º</div>
                <div class="section-content">
                    <div style="margin-bottom: 15px;">
                        <strong>ä¸‹ä¸€æ­¥æ“ä½œï¼š</strong>
                        <span id="nextOperation"></span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>åˆ¤æ–­ç†ç”±ï¼š</strong>
                        <span id="rationale"></span>
                    </div>
                    <div>
                        <strong>å¯èƒ½åŸå› ï¼š</strong>
                        <ul id="likelyCauses" class="causes-list"></ul>
                    </div>
                </div>
            </div>

            <!-- æ‚£è€…ä¿¡æ¯ -->
            <div class="section">
                <div class="section-title">ğŸ‘¤ æ‚£è€…ä¿¡æ¯</div>
                <div class="section-content">
                    <div id="demographics" class="patient-info"></div>
                    <div style="margin-top: 20px;">
                        <strong>å½“å‰ç”¨è¯ï¼š</strong>
                        <ul id="medsList" class="meds-list"></ul>
                    </div>
                    <div id="baselineVitals" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- ä¿¡å·æ‘˜è¦ -->
            <div id="signalsSection" class="section hidden">
                <div class="section-title">ğŸ“Š ä¿¡å·æ‘˜è¦</div>
                <div class="section-content">
                    <p id="summaryText"></p>
                </div>
            </div>

            <!-- å»ºè®® -->
            <div class="section">
                <div class="section-title">ğŸ’¡ å»ºè®®</div>
                <div id="suggestions" class="suggestions"></div>
            </div>

            <!-- åŒ»ç”Ÿå®¡æ ¸åŒºåŸŸ -->
            <div class="section" style="margin-top: 40px; border-left-color: #10b981;">
                <div class="section-title">âœï¸ åŒ»ç”Ÿå®¡æ ¸</div>
                <div class="section-content">
                    <div style="margin-bottom: 20px;">
                        <label for="doctorComment" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            å®¡æ ¸æ„è§ï¼š
                        </label>
                        <textarea 
                            id="doctorComment" 
                            placeholder="è¯·è¾“å…¥å®¡æ ¸æ„è§..."
                            style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                        ></textarea>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            æ˜¯å¦åŒæ„ç³»ç»Ÿåˆ†è¯Šç»“è®ºï¼š
                        </label>
                        <select id="doctorAgree" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            <option value="true">åŒæ„</option>
                            <option value="false">ä¸åŒæ„</option>
                        </select>
                    </div>
                    <button 
                        id="submitBtn" 
                        onclick="submitReview()"
                        style="width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(16, 185, 129, 0.3)'"
                        onmouseout="this.style.transform=''; this.style.boxShadow=''"
                    >
                        <span id="submitBtnText">æäº¤å®¡æ ¸</span>
                        <span id="submitBtnSpinner" style="display: none;">â³ æäº¤ä¸­...</span>
                    </button>
                    <div id="submitMessage" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä»URLè·å–task_id
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('task_id');
        const portNumber = window.location.port || '5001';

        // è·å–ç´§æ€¥å¾½ç« é¢œè‰²ç±»
        function getUrgencyBadgeClass(urgencyLevel) {
            const level = (urgencyLevel || '').toLowerCase();
            if (level.includes('ç´§æ€¥') || level.includes('urgent') || level.includes('emergent')) {
                return 'urgent';
            } else if (level.includes('å…³æ³¨')) {
                return 'attention';
            } else {
                return 'nonurgent';
            }
        }

        // æ¸²æŸ“æ•°æ®
        function renderViewModel(data) {
            const triage = data.triage || {};
            const patient = data.patient || {};
            const signals = data.signals || {};
            const suggestions = data.suggestions || {};

            // æ˜¾ç¤ºé¡¶éƒ¨å¾½ç« 
            const urgencyLevel = triage.urgency_level || '';
            const esiLevel = triage.esi_level;
            const path = triage.path || 'home';

            if (urgencyLevel) {
                const badge = document.getElementById('urgencyBadge');
                badge.textContent = urgencyLevel;
                badge.className = `urgency-badge ${getUrgencyBadgeClass(urgencyLevel)}`;
                badge.classList.remove('hidden');
            }

            if (esiLevel !== null && esiLevel !== undefined) {
                const esi = document.getElementById('esiLevel');
                esi.textContent = `ESI ${esiLevel}`;
                esi.classList.remove('hidden');
            }

            // æ˜¾ç¤ºè·¯å¾„åˆ†æ”¯
            const pathIndicator = document.getElementById('pathIndicator');
            if (path === 'immediate') {
                pathIndicator.textContent = 'ğŸš¨ å»ºè®®ç«‹å³å°±åŒ»/æ€¥è¯Šå¤„ç†';
                pathIndicator.className = 'path-indicator immediate';
            } else {
                pathIndicator.textContent = 'ğŸ  å±…å®¶è§‚å¯Ÿ/å¤æŸ¥å»ºè®®';
                pathIndicator.className = 'path-indicator home';
            }
            pathIndicator.classList.remove('hidden');

            // åˆ†è¯Šç»“è®º
            document.getElementById('nextOperation').textContent = triage.next_operation || 'æš‚æ— ';
            document.getElementById('rationale').textContent = triage.rationale || 'æš‚æ— ';

            // å¯èƒ½åŸå› 
            const causesList = document.getElementById('likelyCauses');
            causesList.innerHTML = '';
            if (triage.likely_causes && triage.likely_causes.length > 0) {
                triage.likely_causes.forEach(cause => {
                    const li = document.createElement('li');
                    li.className = 'cause-item';
                    li.textContent = cause;
                    causesList.appendChild(li);
                });
            } else {
                causesList.innerHTML = '<li class="cause-item">æš‚æ— </li>';
            }

            // æ‚£è€…ä¿¡æ¯
            const demographics = document.getElementById('demographics');
            demographics.innerHTML = '';
            const demo = patient.demographics || {};
            if (demo.name) {
                demographics.innerHTML += `<div class="info-item"><div class="info-label">å§“å</div><div class="info-value">${demo.name}</div></div>`;
            }
            if (demo.age) {
                demographics.innerHTML += `<div class="info-item"><div class="info-label">å¹´é¾„</div><div class="info-value">${demo.age}å²</div></div>`;
            }
            if (demo.sex) {
                demographics.innerHTML += `<div class="info-item"><div class="info-label">æ€§åˆ«</div><div class="info-value">${demo.sex}</div></div>`;
            }

            // ç”¨è¯åˆ—è¡¨
            const medsList = document.getElementById('medsList');
            medsList.innerHTML = '';
            if (patient.meds && patient.meds.length > 0) {
                patient.meds.forEach(med => {
                    const li = document.createElement('li');
                    li.className = 'med-item';
                    const medText = med.name || med.drug_name || '';
                    const medDose = med.dose || '';
                    li.textContent = medText + (medDose ? ` - ${medDose}` : '');
                    medsList.appendChild(li);
                });
            } else {
                medsList.innerHTML = '<li class="med-item">æš‚æ— ç”¨è¯è®°å½•</li>';
            }

            // åŸºçº¿ç”Ÿå‘½ä½“å¾
            const baselineVitals = document.getElementById('baselineVitals');
            baselineVitals.innerHTML = '';
            const vitals = patient.baseline_vitals || {};
            if (Object.keys(vitals).length > 0) {
                let vitalsHtml = '<strong>åŸºçº¿ç”Ÿå‘½ä½“å¾ï¼š</strong><div class="patient-info" style="margin-top: 10px;">';
                for (const [key, value] of Object.entries(vitals)) {
                    vitalsHtml += `<div class="info-item"><div class="info-label">${key}</div><div class="info-value">${value}</div></div>`;
                }
                vitalsHtml += '</div>';
                baselineVitals.innerHTML = vitalsHtml;
            }

            // ä¿¡å·æ‘˜è¦
            const signalsSection = document.getElementById('signalsSection');
            const summaryText = document.getElementById('summaryText');
            if (signals.summary_text) {
                summaryText.textContent = signals.summary_text;
                signalsSection.classList.remove('hidden');
            } else {
                signalsSection.classList.add('hidden');
            }

            // å»ºè®®
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.innerHTML = '';

            // æ ¹æ®pathå†³å®šæ˜¾ç¤ºå“ªä¸ªå»ºè®®
            const suggestionsToShow = path === 'immediate' 
                ? (suggestions.doctor || [])
                : (suggestions.patient || []);

            if (suggestionsToShow.length > 0) {
                suggestionsToShow.forEach((suggestion, index) => {
                    const card = document.createElement('div');
                    card.className = 'suggestion-card';
                    
                    const title = document.createElement('div');
                    title.className = 'suggestion-card-title';
                    title.textContent = path === 'immediate' ? `åŒ»ç”Ÿå»ºè®® ${index + 1}` : `æ‚£è€…å»ºè®® ${index + 1}`;
                    
                    const content = document.createElement('div');
                    content.className = 'suggestion-content';
                    
                    const outputJson = suggestion.output_json || '';
                    if (typeof outputJson === 'string') {
                        content.textContent = outputJson;
                    } else if (Array.isArray(outputJson)) {
                        outputJson.forEach(item => {
                            if (typeof item === 'string') {
                                content.innerHTML += `<p>${item}</p>`;
                            } else if (item.advice) {
                                item.advice.forEach(advice => {
                                    content.innerHTML += `<p><strong>${item.category || ''}</strong>: ${advice}</p>`;
                                });
                            }
                        });
                    }
                    
                    card.appendChild(title);
                    card.appendChild(content);
                    suggestionsContainer.appendChild(card);
                });
            } else {
                suggestionsContainer.innerHTML = '<div class="suggestion-card"><div class="suggestion-content">æš‚æ— å»ºè®®</div></div>';
            }

            // æ˜¾ç¤ºå†…å®¹åŒºåŸŸ
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        // åŠ è½½æ•°æ®
        async function loadTriageView() {
            if (!taskId) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').textContent = 'ç¼ºå°‘task_idå‚æ•°';
                document.getElementById('error').classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(
                    `http://localhost:${portNumber}/api/diagnosis-system/triage-view/by-task?task_id=${taskId}`
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'è·å–æ•°æ®å¤±è´¥');
                }

                renderViewModel(result.data);

            } catch (error) {
                console.error('åŠ è½½åˆ†è¯Šè§†å›¾å¤±è´¥:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                document.getElementById('error').classList.remove('hidden');
            }
        }

        // å­˜å‚¨å½“å‰view modelæ•°æ®ï¼ˆç”¨äºæäº¤ï¼‰
        let currentViewModel = null;

        // ä¿®æ”¹ renderViewModel å‡½æ•°ï¼Œä¿å­˜æ•°æ®
        const originalRenderViewModel = renderViewModel;
        renderViewModel = function(data) {
            currentViewModel = data;
            originalRenderViewModel(data);
        };

        // æäº¤å®¡æ ¸
        async function submitReview() {
            if (!taskId) {
                alert('ç¼ºå°‘task_idå‚æ•°');
                return;
            }

            if (!currentViewModel) {
                alert('æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™å†è¯•');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitBtnSpinner = document.getElementById('submitBtnSpinner');
            const submitMessage = document.getElementById('submitMessage');
            const doctorComment = document.getElementById('doctorComment').value.trim();
            const doctorAgree = document.getElementById('doctorAgree').value === 'true';

            // ç¦ç”¨æŒ‰é’®
            submitBtn.disabled = true;
            submitBtnText.style.display = 'none';
            submitBtnSpinner.style.display = 'inline';

            try {
                const response = await fetch(`http://localhost:${portNumber}/api/diagnosis-system/triage-review/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        decision: {
                            final_path: currentViewModel.triage?.path || 'home',
                            final_esi_level: currentViewModel.triage?.esi_level || null,
                            doctor_agree_with_system: doctorAgree,
                            doctor_comment: doctorComment || 'æ— '
                        },
                        annotations: []
                    })
                });

                const result = await response.json();

                if (result.success) {
                    submitMessage.style.display = 'block';
                    submitMessage.style.background = '#d1fae5';
                    submitMessage.style.color = '#065f46';
                    submitMessage.style.border = '1px solid #10b981';
                    submitMessage.textContent = 'âœ… å®¡æ ¸æäº¤æˆåŠŸï¼';
                    
                    // ç¦ç”¨è¡¨å•
                    document.getElementById('doctorComment').disabled = true;
                    document.getElementById('doctorAgree').disabled = true;
                } else {
                    throw new Error(result.error || 'æäº¤å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å®¡æ ¸å¤±è´¥:', error);
                submitMessage.style.display = 'block';
                submitMessage.style.background = '#fee2e2';
                submitMessage.style.color = '#991b1b';
                submitMessage.style.border = '1px solid #ef4444';
                submitMessage.textContent = `âŒ æäº¤å¤±è´¥: ${error.message}`;
                
                // æ¢å¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtnText.style.display = 'inline';
                submitBtnSpinner.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadTriageView);
    </script>
</body>
</html>

