<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分诊审核 - MediAssist</title>

    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- 引入 Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 引入 Chart.js 用于图表可视化 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- 字体配置 -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }

        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* 模拟手写签名 */
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');

        .font-handwriting {
            font-family: 'Dancing Script', cursive;
        }

        /* 对话侧边栏展开动画 */
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-in {
            animation: slideInFromRight 0.3s ease-in-out;
        }

        .slide-in-from-right {
            animation: slideInFromRight 0.3s ease-in-out;
        }
    </style>
</head>

<body class="bg-slate-50/50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ========== 多语言配置 ==========
        const LANGUAGE_CONFIG = {
            zh: {
                // 页面基础信息
                pageTitle: "分诊审核 - MediAssist",
                htmlLang: "zh-CN",

                // 头部导航
                headerTriageReview: "分诊审核",
                headerReviewer: "审核医师",
                viewModeShorthand: "视图: 速记",
                viewModeFull: "视图: 完整",

                // Triage相关
                triageTitle: "分诊建议 (Triage)",
                urgencyLabel: "紧急程度:",
                urgencyPlaceholder: "请选择紧急程度",
                urgencySystemPrefix: "（系统:",
                urgencyNotSet: "未设置",
                urgencyOptions: {
                    "non-urgent": "一般 (non-urgent)",
                    "urgent": "危险 (urgent)",
                    "emergent": "致命 (emergent)"
                },
                urgencyLevels: {
                    critical: "危急",
                    urgent: "紧急",
                    subUrgent: "次紧急",
                    nonUrgent: "非紧急",
                    normal: "一般"
                },

                // Next Operation相关
                nextOperationLabel: "建议措施:",
                nextOperationPlaceholder: "请选择建议措施",
                nextOperationSystemPrefix: "（系统:",
                nextOperationNotSet: "未设置",
                nextOperationOptions: {
                    "建议生成": "建议生成",
                    "门诊随访": "门诊随访",
                    "紧急联络": "紧急联络",
                    "急诊检查": "急诊检查",
                    "居家观察": "居家观察"
                },

                // 其他UI文本
                annotated: "已批注",
                noData: "暂无",
                noSignalData: "暂无信号数据",
                noRawSignalData: "暂无原始信号数据",
                noSymptoms: "暂无症状识别信息",
                noChiefComplaint: "暂无主诉信息",
                noRationale: "暂无判断理由",
                noPatientRecommendations: "暂无患者建议",
                noDoctorRecommendations: "暂无医生建议",
                noDialogue: "暂无对话记录",
                systemIdentifiedSymptoms: "系统预估症状",
                triggerSource: "触发来源",
                anomalyInfo: "异常原因",
                triggerMethod: "触发方式",
                modelInquiry: "模型主动询问",
                patientInquiry: "患者主动咨询",
                triggerReason: "触发原因",
                patientFeedback: "患者反馈",
                aiReasoningDetails: "AI 推理详情",
                excludedSymptoms: "排除症状",
                riskFactors: "风险因素",
                exclusionRef: "参考",
                patientRecommendations: "建议病人 (Patient Recommendations)",
                doctorRecommendations: "建议医生 (Doctor Recommendations)",
                recommendedAction: "建议措施:",
                rationale: "判断理由 (Rationale)",

                // 患者信息相关
                patient: "患者",
                patientIcon: "患",
                yearsOld: "岁",
                medicalHistory: "病史",
                diseases: "疾病：",
                currentMedications: "当前用药：",
                allergies: "过敏：",

                // 信号和可视化相关
                signalDetectionVisualization: "信号检测可视化",
                aiPhysiologicalSignalAnalysis: "AI生理信号状态分析",
                aiClinicalAnalysisReport: "AI 临床分析报告",
                signalObservation: "信号观察",
                timePeriodArchiveInference: "时段与档案推理",
                comprehensiveJudgment: "综合判断",

                // 症状相关
                symptomRecognition: "可能原因 (Likely Causes)",
                patientSelfReport: "患者自述",
                chiefComplaintSummary: "主诉摘要 (Chief Complaint)",
                items: "项",

                // 生理指标相关
                bloodPressure: "血压",
                heartRate: "心率",
                bloodOxygen: "血氧",
                temperature: "体温",
                patientBaseline: "患者基线",

                // 时间相关
                time: "时间",
                eventDetails: "事件详情 (1小时)",
                longTermTrend: "长期趋势 (30天)",

                // 图表标签相关
                heartRateLabel: "心率 (bpm)",
                bloodPressureLabel: "血压 (mmHg)",
                temperatureLabel: "体温 (°C)",
                systolicPressure: "收缩压",
                diastolicPressure: "舒张压",
                baselineDiastolic: "基线（舒张压）",
                baselineSystolic: "基线（收缩压）",
                baselineSystolicPressure: "收缩压基线",
                baselineDiastolicPressure: "舒张压基线",
                normalRange: "正常范围上限",
                normalRangeText: "正常范围 (60-100 bpm)",
                systolicNormalRangeUpper: "收缩压正常范围上限",
                diastolicNormalRangeUpper: "舒张压正常范围上限",

                // 图表数据标签
                minValue: "最小值",
                fluctuationRange: "波动范围",
                baselineValue: "基线值",
                baselineText: "基线",
                normalRangeLower: "正常范围下限",
                systolicNormalRangeLower: "收缩压正常范围下限",
                diastolicNormalRangeLower: "舒张压正常范围下限",
                lowestValue: "最低值",
                heartRateTooltip: "心率",
                rangeTooltip: "范围",
                belowNormalWarning: " ⚠️ 低于正常值",
                averageTooltip: "平均",
                temperatureTooltip: "体温",

                // 表格列标题
                indicator: "指标",
                triggerTime: "触发时刻",
                previous1hRange: "前1h范围",
                baselineValueColumn: "基线值",
                trend: "趋势",

                // 图表相关
                spO2Label: "血氧饱和度 (%)",
                spO2ShortLabel: "血氧 (%)",
                averageSpO2Label: "平均血氧 (%)",
                stepsLabel: "步数 (步/分钟)",
                stepsPerMinute: "步/分钟",

                // 性别
                male: "男",
                female: "女",

                // 批注相关
                doctorAnnotation: "医生批注：",
                inputAnnotation: "输入批注...",
                cancel: "取消",
                delete: "删除",
                save: "保存",
                editAnnotation: "编辑批注",
                addAnnotation: "添加批注",

                // 审核相关
                reviewComment: "审核意见：",
                reviewCommentPlaceholder: "请输入审核意见...",
                agreeWithTriage: "是否同意系统分诊结论：",
                agree: "同意",
                disagree: "不同意",
                reset: "重置",
                submitting: "提交中...",
                confirmSubmit: "确认并提交",
                submitSuccess: "✅ 审核提交成功！",
                submitError: "❌ 提交失败:",
                loadingTriageData: "正在加载分诊数据...",

                // 对话相关
                dialogueHistory: "对话实录",
                addAnnotationTitle: "添加批注",
                editAnnotationTitle: "编辑",
                deleteAnnotationTitle: "删除",

                // 错误信息
                missingTaskId: "缺少task_id参数",
                missingUserIdOrScenario: "缺少user_id或scenario_id参数",
                loadTriageViewFailed: "加载分诊视图失败:",
                submitReviewFailed: "提交审核失败:",

                // 日期格式
                dateFormat: { year: 'numeric', month: '2-digit', day: '2-digit' },
                dateLocale: 'zh-CN'
            },
            en: {
                // 页面基础信息
                pageTitle: "Triage Review - MediAssist",
                htmlLang: "en-US",

                // 头部导航
                headerTriageReview: "Triage Review",
                headerReviewer: "Reviewer",
                viewModeShorthand: "View: Shorthand",
                viewModeFull: "View: Full",

                // Triage相关
                triageTitle: "Triage Recommendation",
                urgencyLabel: "Urgency Level:",
                urgencyPlaceholder: "Please select urgency level",
                urgencySystemPrefix: "(System:",
                urgencyNotSet: "Not set",
                urgencyOptions: {
                    "non-urgent": "Non-urgent",
                    "urgent": "Urgent",
                    "emergent": "Emergent"
                },
                urgencyLevels: {
                    critical: "Critical",
                    urgent: "Urgent",
                    subUrgent: "Sub-urgent",
                    nonUrgent: "Non-urgent",
                    normal: "Normal"
                },

                // Next Operation相关
                nextOperationLabel: "Recommended Action:",
                nextOperationPlaceholder: "Please select recommended action",
                nextOperationSystemPrefix: "(System:",
                nextOperationNotSet: "Not set",
                nextOperationOptions: {
                    "suggestion_generated": "Suggestion Generated",
                    "outpatient_followup": "Outpatient Follow-up",
                    "emergency_contact": "Emergency Contact",
                    "emergency_examination": "Emergency Examination",
                    "home_observation": "Home Observation"
                },

                // 其他UI文本
                annotated: "Annotated",
                noData: "No data",
                noSignalData: "No signal data",
                noRawSignalData: "No raw signal data",
                noSymptoms: "No symptom identification information",
                noChiefComplaint: "No chief complaint information",
                noRationale: "No rationale",
                noPatientRecommendations: "No patient recommendations",
                noDoctorRecommendations: "No doctor recommendations",
                noDialogue: "No dialogue records",
                systemIdentifiedSymptoms: "Estimated Symptoms",
                triggerSource: "Trigger Source",
                anomalyInfo: "Anomaly Info",
                triggerMethod: "Trigger Method",
                modelInquiry: "Model Inquiry",
                patientInquiry: "Patient Inquiry",
                triggerReason: "Trigger Reason",
                patientFeedback: "Patient Feedback",
                aiReasoningDetails: "AI Reasoning Details",
                excludedSymptoms: "Excluded Symptoms",
                riskFactors: "Risk Factors",
                exclusionRef: "Reference",
                patientRecommendations: "Patient Recommendations",
                doctorRecommendations: "Doctor Recommendations",
                recommendedAction: "Recommended Action:",
                rationale: "Rationale",

                // 患者信息相关
                patient: "Patient",
                patientIcon: "P",
                yearsOld: "y/o",
                medicalHistory: "Medical History",
                diseases: "Diseases:",
                currentMedications: "Current Medications:",
                allergies: "Allergies:",

                // 信号和可视化相关
                signalDetectionVisualization: "Signal Detection Visualization",
                aiPhysiologicalSignalAnalysis: "AI Physiological Signal Status Analysis",
                aiClinicalAnalysisReport: "AI Clinical Analysis Report",
                signalObservation: "Signal Observation",
                timePeriodArchiveInference: "Time Period & Archive Inference",
                comprehensiveJudgment: "Comprehensive Judgment",

                // 症状相关
                symptomRecognition: "Likely Causes",
                patientSelfReport: "Patient Self-Report",
                chiefComplaintSummary: "Chief Complaint Summary",
                items: "items",

                // 生理指标相关
                bloodPressure: "Blood Pressure",
                heartRate: "Heart Rate",
                bloodOxygen: "SpO2",
                temperature: "Temperature",
                patientBaseline: "Patient Baseline",

                // 时间相关
                time: "Time",
                eventDetails: "Event Details (1 hour)",
                longTermTrend: "Long-term Trend (30 days)",

                // 图表标签相关
                heartRateLabel: "Heart Rate (bpm)",
                bloodPressureLabel: "Blood Pressure (mmHg)",
                temperatureLabel: "Temperature (°C)",
                systolicPressure: "Systolic Pressure",
                diastolicPressure: "Diastolic Pressure",
                baselineDiastolic: "Baseline (Diastolic)",
                baselineSystolic: "Baseline (Systolic)",
                baselineSystolicPressure: "Systolic Baseline",
                baselineDiastolicPressure: "Diastolic Baseline",
                normalRange: "Normal Range Upper Limit",
                normalRangeText: "Normal Range (60-100 bpm)",
                systolicNormalRangeUpper: "Systolic Normal Range Upper Limit",
                diastolicNormalRangeUpper: "Diastolic Normal Range Upper Limit",

                // 表格列标题
                indicator: "Indicator",
                triggerTime: "Trigger Time",
                previous1hRange: "Previous 1h Range",
                baselineValueColumn: "Baseline Value",
                baselineText: "Baseline",
                trend: "Trend",

                // 图表相关
                spO2Label: "SpO2 (%)",
                spO2ShortLabel: "SpO2 (%)",
                averageSpO2Label: "Average SpO2 (%)",
                stepsLabel: "Steps (steps/min)",
                stepsPerMinute: "steps/min",

                // 性别
                male: "Male",
                female: "Female",

                // 图表数据标签
                minValue: "Min Value",
                fluctuationRange: "Fluctuation Range",
                baselineValue: "Baseline Value",
                normalRangeLower: "Normal Range Lower Limit",
                systolicNormalRangeLower: "Systolic Normal Range Lower Limit",
                diastolicNormalRangeLower: "Diastolic Normal Range Lower Limit",
                lowestValue: "Lowest Value",
                heartRateTooltip: "Heart Rate",
                rangeTooltip: "Range",
                belowNormalWarning: " ⚠️ Below Normal",
                averageTooltip: "Average",
                temperatureTooltip: "Temperature",

                // 批注相关
                doctorAnnotation: "Doctor Annotation:",
                inputAnnotation: "Enter annotation...",
                cancel: "Cancel",
                delete: "Delete",
                save: "Save",
                editAnnotation: "Edit Annotation",
                addAnnotation: "Add Annotation",

                // 审核相关
                reviewComment: "Review Comment:",
                reviewCommentPlaceholder: "Please enter review comment...",
                agreeWithTriage: "Do you agree with the system's triage conclusion:",
                agree: "Agree",
                disagree: "Disagree",
                reset: "Reset",
                submitting: "Submitting...",
                confirmSubmit: "Confirm and Submit",
                submitSuccess: "✅ Review submitted successfully!",
                submitError: "❌ Submit failed:",
                loadingTriageData: "Loading triage data...",

                // 对话相关
                dialogueHistory: "Dialogue History",
                addAnnotationTitle: "Add Annotation",
                editAnnotationTitle: "Edit",
                deleteAnnotationTitle: "Delete",

                // 错误信息
                missingTaskId: "Missing task_id parameter",
                missingUserIdOrScenario: "Missing user_id or scenario_id parameter",
                loadTriageViewFailed: "Failed to load triage view:",
                submitReviewFailed: "Failed to submit review:",

                // 日期格式
                dateFormat: { year: 'numeric', month: '2-digit', day: '2-digit' },
                dateLocale: 'en-US'
            }
        };

        // 语言检测函数（URL参数优先，支持手动切换）
        const getLanguage = () => {
            // 方法1: 从URL参数获取（优先级最高，支持手动切换）
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            if (lang === 'en' || lang === 'zh') {
                return lang;
            }

            // 方法2: 从文件名获取（如果将来重命名文件）
            const filename = window.location.pathname.split('/').pop();
            if (filename.includes('_en')) return 'en';
            if (filename.includes('_zh')) return 'zh';

            // 默认：中文（保持向后兼容）
            return 'zh';
        };

        // 语言切换函数
        const switchLanguage = (targetLang) => {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('lang', targetLang);
            // 刷新页面，使用新的语言参数
            window.location.search = urlParams.toString();
        };

        // 当前语言和翻译函数
        const currentLang = getLanguage();
        const t = LANGUAGE_CONFIG[currentLang];

        // 动态设置HTML lang和title
        document.documentElement.lang = t.htmlLang;
        document.title = t.pageTitle;

        // next_operation 映射辅助函数（用于显示后端返回的英文值）
        const mapNextOperation = (rawValue) => {
            if (currentLang === 'zh') {
                // 英文值转中文显示
                const nextOpMapping = {
                    'suggestion_generated': '建议生成',
                    'outpatient_followup': '门诊随访',
                    'emergency_contact': '紧急联络',
                    'emergency_examination': '急诊检查',
                    'home_observation': '居家观察'
                };
                return nextOpMapping[rawValue] || rawValue;
            } else {
                // 英文版本直接使用原值
                return rawValue;
            }
        };
        // ========== 多语言配置结束 ==========

        // --- 图标组件定义 (Lucide Icons) ---
        const IconWrapper = ({ size = 24, className, children, ...props }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
                {...props}
            >
                {children}
            </svg>
        );

        const Activity = (props) => <IconWrapper {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></IconWrapper>;
        const User = (props) => <IconWrapper {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconWrapper>;
        const Bot = (props) => <IconWrapper {...props}><rect x="4" y="4" width="16" height="16" rx="2" /><rect x="9" y="9" width="6" height="6" /><path d="M9 1v3" /><path d="M15 1v3" /><path d="M9 20v3" /><path d="M15 20v3" /><path d="M20 9h3" /><path d="M20 14h3" /><path d="M1 9h3" /><path d="M1 14h3" /></IconWrapper>;
        const XCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><path d="m15 9-6 6" /><path d="m9 9 6 6" /></IconWrapper>;
        const AlertTriangle = (props) => <IconWrapper {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><path d="M12 9v4" /><path d="M12 17h.01" /></IconWrapper>;
        const FileText = (props) => <IconWrapper {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></IconWrapper>;
        const MessageSquare = (props) => <IconWrapper {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></IconWrapper>;
        const AlertCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></IconWrapper>;
        const CheckCircle2 = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></IconWrapper>;
        const Edit3 = (props) => <IconWrapper {...props}><path d="M12 20h9" /><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" /></IconWrapper>;
        const Stethoscope = (props) => <IconWrapper {...props}><path d="M4.8 2.3A.3.3 0 0 0 5 2.5h3.5a.3.3 0 0 0 .2-.2l.1-1a.3.3 0 0 0-.3-.3H5.1a.3.3 0 0 0-.3.3l0 1ZM6.5 2.5V7a5.5 5.5 0 0 0 10.8 2l.2-1a.3.3 0 0 0-.3-.3h-3.5a.3.3 0 0 0-.3.3l.1 1a3.5 3.5 0 0 1-6.8 0V2.5" /><path d="M12 19.5v-7" /><path d="M9 19.5a3 3 0 1 0 6 0" /></IconWrapper>;
        const ChevronRight = (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6" /></IconWrapper>;
        const Clock = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></IconWrapper>;
        const Heart = (props) => <IconWrapper {...props}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" /></IconWrapper>;
        const Pill = (props) => <IconWrapper {...props}><rect x="8" y="2" width="8" height="20" rx="4" /><path d="M8 12h8" /></IconWrapper>;
        const TrendingUp = (props) => <IconWrapper {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></IconWrapper>;
        const Maximize2 = (props) => <IconWrapper {...props}><polyline points="15 3 21 3 21 9" /><polyline points="9 21 3 21 3 15" /><line x1="21" x2="14" y1="3" y2="10" /><line x1="3" x2="10" y1="21" y2="14" /></IconWrapper>;

        // --- 触发信息展示组件 ---
        const TriggerInfoBlock = ({ data, t, fullMode = false }) => {
            const context = data?.trigger_context;
            if (!context) return null;

            const isModel = context.trigger_type === 'model_inquiry';

            return (
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col mb-4">
                    {/* 头部区域（带下划线） */}
                    <div className="px-4 py-2.5 border-b border-slate-100 flex justify-between items-center bg-slate-50/30">
                        <div className="flex items-center gap-2">
                            <div className="bg-red-100 p-1 rounded text-red-600">
                                <AlertTriangle size={16} />
                            </div>
                            <h3 className="font-bold text-slate-800 text-sm">
                                {t.anomalyInfo}
                            </h3>
                        </div>
                    </div>

                    {/* 内容区域 */}
                    <div className="p-4">
                        {/* 触发方式 */}
                        <div className="mb-2">
                            <span className="text-sm text-slate-500">{t.triggerMethod}:</span>
                            <span className="ml-1.5 text-sm font-medium text-slate-700">
                                {isModel ? t.modelInquiry : t.patientInquiry}
                            </span>
                        </div>

                        {/* 触发原因 (Signals) */}
                        {context.trigger_reason && context.trigger_reason.length > 0 && (
                            <div className="mb-2">
                                <div className="text-xs text-slate-500 mb-1">{t.triggerReason}:</div>
                                <div className="flex flex-wrap gap-1.5">
                                    {context.trigger_reason.map((reason, idx) => (
                                        <span key={idx} className="px-2 py-0.5 bg-white border border-red-200 text-red-700 text-xs rounded shadow-sm">
                                            {reason}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 患者反馈 */}
                        {context.patient_feedback && (
                            <div className="mb-1">
                                <div className="text-xs text-slate-500 mb-0.5">{t.patientFeedback}:</div>
                                <div className="text-sm text-slate-700 font-medium bg-white/60 p-1.5 rounded border border-slate-100">
                                    "{context.patient_feedback}"
                                </div>
                            </div>
                        )}

                        {/* Full Mode: AI 推理详情 */}
                        {fullMode && (
                            <div className="mt-3 pt-3 border-t border-slate-200">
                                <h4 className="text-xs font-bold text-slate-600 mb-2 flex items-center gap-1.5">
                                    <Bot size={14} /> {t.aiReasoningDetails}
                                </h4>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {/* Exclusions - 显示 ref */}
                                    {context.ai_exclusions && context.ai_exclusions.length > 0 && (
                                        <div className="bg-slate-50 rounded p-2 border border-slate-100">
                                            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5">{t.excludedSymptoms}</div>
                                            <ul className="space-y-2">
                                                {context.ai_exclusions.map((item, idx) => (
                                                    <li key={idx} className="text-xs text-slate-600">
                                                        <div className="flex items-start gap-1.5">
                                                            <XCircle size={12} className="text-slate-400 mt-0.5 shrink-0" />
                                                            <div className="flex flex-col">
                                                                <span>
                                                                    <span className="font-medium text-slate-700">{item.symptom}</span>
                                                                    {item.reason_code && (
                                                                        <span className="text-slate-400 ml-1">- {item.reason_code}</span>
                                                                    )}
                                                                </span>
                                                                {item.ref && (
                                                                    <span className="text-[10px] text-slate-400 mt-0.5 leading-tight">
                                                                        {t.exclusionRef}: {item.ref}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {/* Risks - 完整显示 */}
                                    {context.ai_risks && context.ai_risks.length > 0 && (
                                        <div className="bg-rose-50 rounded p-2 border border-rose-100">
                                            <div className="text-[10px] font-bold text-rose-400 uppercase tracking-wider mb-1.5">{t.riskFactors}</div>
                                            <ul className="space-y-1.5">
                                                {context.ai_risks.map((risk, idx) => (
                                                    <li key={idx} className="text-xs text-rose-700 flex items-start gap-1.5">
                                                        <AlertTriangle size={12} className="text-rose-400 mt-0.5 shrink-0" />
                                                        <span className="break-words leading-relaxed">{risk}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 消息文本格式化函数（将编号列表和问句加粗） ---
        const formatMessageText = (text) => {
            if (!text) return null;
            const lines = text.split('\n');
            return lines.map((line, index) => {
                const trimmedLine = line.trim();
                // 检测以数字+点开头的行（如 "1. Headache"）
                const isNumberedItem = /^\d+\.\s/.test(trimmedLine);
                // 检测症状询问问句
                const isSymptomQuestion = trimmedLine.toLowerCase().includes('do you currently have any of the following');
                const shouldBold = isNumberedItem || isSymptomQuestion;
                return (
                    <React.Fragment key={index}>
                        {shouldBold ? <strong>{line}</strong> : line}
                        {index < lines.length - 1 && '\n'}
                    </React.Fragment>
                );
            });
        };

        // --- 顶部导航栏 ---
        const Header = ({ taskId, viewMode, onViewModeChange, doctorInfo }) => {
            const currentLang = getLanguage();
            return (
                <header className="h-16 bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                    <div className="max-w-[1600px] mx-auto h-full px-6 flex items-center justify-between">
                        {/* 左侧：Logo 与 面包屑 */}
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-2.5">
                                <div className="bg-blue-600 p-1.5 rounded-lg text-white shadow-md shadow-blue-600/20">
                                    <Activity size={20} />
                                </div>
                                <span className="font-bold text-slate-800 text-lg tracking-tight">MediAssist</span>
                            </div>

                            <div className="h-6 w-px bg-slate-200"></div>

                            <div className="flex items-center gap-2 text-sm text-slate-500">
                                <span className="px-2 py-1 bg-slate-100 rounded text-slate-600 font-medium">{t.headerTriageReview}</span>
                                {taskId && (
                                    <>
                                        <ChevronRight size={14} className="text-slate-300" />
                                        <span className="font-mono text-slate-400">{taskId}</span>
                                    </>
                                )}
                            </div>
                        </div>

                        {/* 右侧：视图切换、语言切换与用户信息 */}
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-1 bg-slate-50 p-1 rounded-lg border border-slate-200">
                                <button
                                    onClick={() => onViewModeChange('shorthand')}
                                    className={`px-3 py-1 text-xs font-medium rounded border transition-all ${viewMode === 'shorthand'
                                        ? 'bg-white shadow-sm text-slate-700 border-slate-100'
                                        : 'text-slate-500 hover:text-slate-700 border-transparent'
                                        }`}
                                >
                                    {t.viewModeShorthand}
                                </button>
                                <button
                                    onClick={() => onViewModeChange('full')}
                                    className={`px-3 py-1 text-xs font-medium rounded border transition-all ${viewMode === 'full'
                                        ? 'bg-white shadow-sm text-slate-700 border-slate-100'
                                        : 'text-slate-500 hover:text-slate-700 border-transparent'
                                        }`}
                                >
                                    {t.viewModeFull}
                                </button>
                            </div>

                            {/* 语言切换按钮 */}
                            <div className="flex items-center gap-1 bg-slate-50 p-1 rounded-lg border border-slate-200">
                                <button
                                    onClick={() => switchLanguage('zh')}
                                    className={`px-3 py-1 text-xs font-medium rounded transition-all ${currentLang === 'zh'
                                        ? 'bg-white shadow-sm text-slate-700 border border-slate-200'
                                        : 'text-slate-500 hover:text-slate-700 border border-transparent'
                                        }`}
                                >
                                    中文
                                </button>
                                <button
                                    onClick={() => switchLanguage('en')}
                                    className={`px-3 py-1 text-xs font-medium rounded transition-all ${currentLang === 'en'
                                        ? 'bg-white shadow-sm text-slate-700 border border-slate-200'
                                        : 'text-slate-500 hover:text-slate-700 border border-transparent'
                                        }`}
                                >
                                    English
                                </button>
                            </div>

                            <div className="h-6 w-px bg-slate-200 mx-1"></div>

                            <div className="flex items-center gap-3 pl-2">
                                <div className="text-right hidden sm:block">
                                    <p className="text-xs font-bold text-slate-700">{t.headerReviewer}</p>
                                    <p className="text-[10px] text-slate-400 uppercase">{doctorInfo?.name || 'Reviewer'}</p>
                                </div>
                                <div className="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center text-xs font-bold">
                                    {doctorInfo?.name ? doctorInfo.name.charAt(0) : 'DR'}
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        // --- 生理指标表格组件（紧凑版） ---
        const VitalSignsTable = ({ vitals, signals, isUrgent }) => {
            // 获取当前语言配置
            const currentLang = getLanguage();
            const t = LANGUAGE_CONFIG[currentLang];
            // 格式化血压
            const formatBloodPressure = (bp) => {
                if (typeof bp === 'object' && bp !== null) {
                    const systolic = bp['收缩压'] || bp['systolic'] || bp['收缩'];
                    const diastolic = bp['舒张压'] || bp['diastolic'] || bp['舒张'];
                    if (systolic && diastolic) {
                        return `${systolic}/${diastolic}`;
                    }
                }
                return bp || '--';
            };

            // 获取范围数据
            const ranges = vitals?.ranges || {};
            const baselines = vitals?.baselines || {};

            // 格式化范围值
            const formatRange = (range) => {
                if (!range || range.min == null || range.max == null) return '--';
                if (range.min === range.max) return `${range.min}`;
                return `${range.min}-${range.max}`;
            };

            // 格式化血压范围
            const formatBpRange = (systolic, diastolic) => {
                if (!systolic && !diastolic) return '--';
                const sysRange = formatRange(systolic);
                const diaRange = formatRange(diastolic);
                if (sysRange === '--' && diaRange === '--') return '--';
                return `${sysRange}/${diaRange}`;
            };

            // 获取当前值和基线值
            const getCurrentValue = (key, signalsKey) => {
                if (signalsKey && signals.metrics && signals.metrics[signalsKey]) {
                    const val = signals.metrics[signalsKey].mean || signals.metrics[signalsKey];
                    return typeof val === 'number' ? Math.round(val * 10) / 10 : val;
                }
                return vitals[key] || vitals[signalsKey] || '--';
            };

            // 计算趋势
            const getTrend = (current, baseline) => {
                if (!current || !baseline || current === '--' || baseline === '--') return null;
                const curr = typeof current === 'number' ? current : parseFloat(current);
                const base = typeof baseline === 'number' ? baseline : parseFloat(baseline);
                if (isNaN(curr) || isNaN(base)) return null;
                const change = Math.abs((curr - base) / base);
                if (change < 0.05) return 'stable';
                return curr > base ? 'up' : 'down';
            };

            // 检查是否超出安全范围或超过基线值
            const isAbnormal = (label, currentValue, baselineValue) => {
                if (!currentValue || currentValue === '--') return false;

                // 获取语言配置（在函数开始时获取一次）
                const currentLang = getLanguage();
                const t = LANGUAGE_CONFIG[currentLang];

                // 血压：收缩压 ≥ 140 或 舒张压 ≥ 90，或超过基线值
                if (label === t.bloodPressure) {
                    // 如果是字符串格式 "145/91"，需要解析
                    if (typeof currentValue === 'string' && currentValue.includes('/')) {
                        const parts = currentValue.split('/');
                        const systolic = parseFloat(parts[0]);
                        const diastolic = parseFloat(parts[1]);

                        // 检查是否超出安全值
                        if (systolic >= 140 || diastolic >= 90) return true;

                        // 检查是否超过基线值
                        if (baselineValue && typeof baselineValue === 'string' && baselineValue.includes('/')) {
                            const baseParts = baselineValue.split('/');
                            const baseSystolic = parseFloat(baseParts[0]);
                            const baseDiastolic = parseFloat(baseParts[1]);
                            if (systolic > baseSystolic || diastolic > baseDiastolic) return true;
                        }
                    }
                    return false;
                }

                const curr = typeof currentValue === 'number' ? currentValue : parseFloat(currentValue);
                if (isNaN(curr)) return false;

                // 心率：< 60 或 > 100，或超过基线值
                if (label === t.heartRate) {
                    if (curr < 60 || curr > 100) return true;
                    if (baselineValue) {
                        const base = typeof baselineValue === 'number' ? baselineValue : parseFloat(baselineValue);
                        if (!isNaN(base) && curr > base) return true;
                    }
                    return false;
                }

                // 血氧：< 95%，或超过基线值（血氧下降是异常）
                if (label === t.bloodOxygen) {
                    if (curr < 95) return true;
                    if (baselineValue) {
                        const base = typeof baselineValue === 'number' ? baselineValue : parseFloat(baselineValue);
                        if (!isNaN(base) && curr < base) return true; // 血氧下降是异常
                    }
                    return false;
                }

                // 体温：< 36.1 或 > 37.2，或超过基线值
                if (label === t.temperature) {
                    if (curr < 36.1 || curr > 37.2) return true;
                    if (baselineValue) {
                        const base = typeof baselineValue === 'number' ? baselineValue : parseFloat(baselineValue);
                        if (!isNaN(base) && curr > base) return true;
                    }
                    return false;
                }

                return false;
            };

            const indicators = [
                {
                    label: t.bloodPressure,
                    current: (vitals.sbp && vitals.dbp) ? `${vitals.sbp}/${vitals.dbp}`
                        : (signals.metrics?.blood_pressure
                            ? `${Math.round(signals.metrics.blood_pressure.systolic?.mean || signals.metrics.blood_pressure.systolic)}/${Math.round(signals.metrics.blood_pressure.diastolic?.mean || signals.metrics.blood_pressure.diastolic)}`
                            : formatBloodPressure(vitals['血压'] || vitals['blood_pressure'])),
                    range: formatBpRange(ranges.blood_pressure?.systolic, ranges.blood_pressure?.diastolic),
                    baseline: (baselines.blood_pressure?.systolic && baselines.blood_pressure?.diastolic)
                        ? `${baselines.blood_pressure.systolic}/${baselines.blood_pressure.diastolic}`
                        : formatBloodPressure(vitals['血压'] || vitals['blood_pressure']),
                    unit: 'mmHg',
                    trend: getTrend(
                        vitals.sbp || signals.metrics?.blood_pressure?.systolic?.mean || signals.metrics?.blood_pressure?.systolic,
                        baselines.blood_pressure?.systolic || vitals['血压']?.['收缩压'] || vitals['血压']?.['systolic']
                    )
                },
                {
                    label: t.heartRate,
                    current: vitals.heartrate || getCurrentValue('心率', 'heart_rate') || '--',
                    range: formatRange(ranges.heart_rate),
                    baseline: baselines.heart_rate || vitals['心率'] || '--',
                    unit: 'bpm',
                    trend: getTrend(
                        vitals.heartrate || signals.metrics?.heart_rate?.mean,
                        baselines.heart_rate || vitals['心率']
                    )
                },
                {
                    label: t.bloodOxygen,
                    current: vitals.o2sat || signals.metrics?.spo2?.mean || vitals['血氧'] || '--',
                    range: formatRange(ranges.spo2),
                    baseline: '--',
                    unit: '%',
                    trend: (vitals.o2sat && vitals.o2sat >= 95) ? 'stable' : (vitals.o2sat ? 'down' : null)
                },
                {
                    label: t.temperature,
                    current: vitals.temperature || vitals['体温'] || '--',
                    range: formatRange(ranges.temperature),
                    baseline: baselines.temperature || vitals['体温'] || '--',
                    unit: '℃',
                    trend: getTrend(vitals.temperature, baselines.temperature || vitals['体温'])
                }
            ].filter(ind => ind.current !== '--' || ind.range !== '--' || ind.baseline !== '--');

            return (
                <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <table className="w-full text-xs">
                        <thead className="bg-slate-50">
                            <tr>
                                <th className="px-2 py-1.5 text-left font-semibold text-slate-600 text-[10px] uppercase">{t.indicator}</th>
                                <th className="px-2 py-1.5 text-right font-semibold text-slate-600 text-[10px] uppercase">{t.triggerTime}</th>
                                <th className="px-2 py-1.5 text-right font-semibold text-slate-600 text-[10px] uppercase">{t.previous1hRange}</th>
                                <th className="px-2 py-1.5 text-right font-semibold text-slate-600 text-[10px] uppercase">{t.baselineValueColumn}</th>
                                <th className="px-2 py-1.5 text-center font-semibold text-slate-600 text-[10px] uppercase">{t.trend}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {indicators.map((ind, idx) => {
                                const trendIcon = ind.trend === 'up' ? '↑' : ind.trend === 'down' ? '↓' : '→';
                                const trendColor = ind.trend === 'up' ? 'text-red-500' : ind.trend === 'down' ? 'text-blue-500' : 'text-slate-400';

                                // 检查是否超出安全值或基线值
                                const isAbnormalValue = isAbnormal(ind.label, ind.current, ind.baseline);

                                return (
                                    <tr key={idx} className="border-t border-slate-100 hover:bg-slate-50/50">
                                        <td className="px-2 py-2 font-medium text-slate-700">{ind.label}</td>
                                        <td className={`px-2 py-2 text-right font-semibold ${isAbnormalValue ? 'text-red-600' : 'text-slate-900'}`}>
                                            {ind.current}{ind.current !== '--' && ind.unit}
                                        </td>
                                        <td className="px-2 py-2 text-right text-slate-500 text-[10px]">
                                            {ind.range || '--'}{ind.range && ind.range !== '--' && ind.unit}
                                        </td>
                                        <td className="px-2 py-2 text-right text-slate-500">
                                            {ind.baseline}{ind.baseline !== '--' && ind.unit}
                                        </td>
                                        <td className="px-2 py-2 text-center">
                                            {ind.trend && (
                                                <span className={`font-bold ${trendColor}`} title={ind.trend === 'up' ? '上升' : ind.trend === 'down' ? '下降' : '稳定'}>
                                                    {trendIcon}
                                                </span>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- Signal 可视化组件（Chart.js 图表版，参考模板风格） ---
        const SignalVisualization = ({ signals, data, viewMode }) => {
            // 获取当前语言配置
            const currentLang = getLanguage();
            const t = LANGUAGE_CONFIG[currentLang];
            const hrChartRef = React.useRef(null);
            const spo2ChartRef = React.useRef(null);
            const tempChartRef = React.useRef(null);
            const bpChartRef = React.useRef(null);
            const hrChartInstance = React.useRef(null);
            const spo2ChartInstance = React.useRef(null);
            const tempChartInstance = React.useRef(null);
            const bpChartInstance = React.useRef(null);

            // 提取signal数据 - 尝试多个可能的数据路径（使用 useMemo 缓存）
            const signalsList = React.useMemo(() => {
                return signals?.data ||
                    signals?.signals ||
                    signals?.signals_list ||
                    data?.signals?.data ||
                    data?.signals?.signals ||
                    [];
            }, [signals, data]);

            // 提取患者基线值（使用 useMemo 缓存）
            const { baselineHR, baselineSpo2, baselineTemp, baselineSBP, baselineDBP } = React.useMemo(() => {
                const patient = data?.patient || {};
                const baselineVitals = patient.baseline_vitals || {};
                const baselineHR = baselineVitals['心率'] || baselineVitals.heart_rate || null;
                const baselineSpo2 = baselineVitals['血氧'] || baselineVitals.spo2 || null;
                const baselineTemp = baselineVitals['体温'] || baselineVitals.temperature || null;
                const baselineBP = baselineVitals['血压'] || baselineVitals.blood_pressure || null;
                const baselineSBP = baselineBP?.收缩压 || baselineBP?.systolic || null;
                const baselineDBP = baselineBP?.舒张压 || baselineBP?.diastolic || null;
                return { baselineHR, baselineSpo2, baselineTemp, baselineSBP, baselineDBP };
            }, [data]);

            if (!signalsList || signalsList.length === 0) {
                return (
                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <p className="text-xs text-slate-400 text-center">暂无信号数据</p>
                    </div>
                );
            }

            // 提取最近的几个signal用于可视化（取最近10个用于画图）
            const recentSignals = React.useMemo(() => {
                return signalsList.slice(0, 10).reverse(); // 取最近10个，倒序显示
            }, [signalsList]);

            // 格式化时间
            const formatTime = (ts) => {
                if (!ts) return '';
                try {
                    const date = new Date(ts);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                } catch {
                    return ts;
                }
            };

            // 获取指标值（支持 min, max, mean）
            const getMetricValue = (signal, metricKey) => {
                try {
                    const metrics = signal?.metrics_json?.output_json?.metrics_json || {};
                    if (metricKey === 'blood_pressure') {
                        const bp = metrics.blood_pressure;
                        if (bp && bp.systolic && bp.diastolic) {
                            return {
                                systolic: {
                                    mean: bp.systolic.mean || bp.systolic,
                                    min: bp.systolic.min,
                                    max: bp.systolic.max
                                },
                                diastolic: {
                                    mean: bp.diastolic.mean || bp.diastolic,
                                    min: bp.diastolic.min,
                                    max: bp.diastolic.max
                                },
                                unit: 'mmHg'
                            };
                        }
                    } else {
                        const metric = metrics[metricKey];
                        if (metric) {
                            return {
                                mean: metric.mean || metric,
                                min: metric.min,
                                max: metric.max,
                                unit: metric.unit || ''
                            };
                        }
                    }
                } catch (e) {
                    console.error('Error extracting metric:', e);
                }
                return null;
            };

            // 准备图表数据（包含 min, max, mean）- 使用 useMemo 缓存，只在 recentSignals 变化时重新计算
            const chartData = React.useMemo(() => {
                // 格式化时间
                const formatTime = (ts) => {
                    if (!ts) return '';
                    try {
                        const date = new Date(ts);
                        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    } catch {
                        return ts;
                    }
                };

                // 获取指标值（支持 min, max, mean）
                const getMetricValue = (signal, metricKey) => {
                    try {
                        const metrics = signal?.metrics_json?.output_json?.metrics_json || {};
                        if (metricKey === 'blood_pressure') {
                            const bp = metrics.blood_pressure;
                            if (bp && bp.systolic && bp.diastolic) {
                                return {
                                    systolic: {
                                        mean: bp.systolic.mean || bp.systolic,
                                        min: bp.systolic.min,
                                        max: bp.systolic.max
                                    },
                                    diastolic: {
                                        mean: bp.diastolic.mean || bp.diastolic,
                                        min: bp.diastolic.min,
                                        max: bp.diastolic.max
                                    },
                                    unit: 'mmHg'
                                };
                            }
                        } else {
                            const metric = metrics[metricKey];
                            if (metric) {
                                return {
                                    mean: metric.mean || metric,
                                    min: metric.min,
                                    max: metric.max,
                                    unit: metric.unit || ''
                                };
                            }
                        }
                    } catch (e) {
                        console.error('Error extracting metric:', e);
                    }
                    return null;
                };

                return {
                    labels: recentSignals.map((s, idx) => formatTime(s.start_ts) || `窗口${idx + 1}`),
                    heartRate: {
                        mean: recentSignals.map(s => {
                            const hr = getMetricValue(s, 'heart_rate');
                            return hr?.mean || null;
                        }),
                        min: recentSignals.map(s => {
                            const hr = getMetricValue(s, 'heart_rate');
                            return hr?.min || null;
                        }),
                        max: recentSignals.map(s => {
                            const hr = getMetricValue(s, 'heart_rate');
                            return hr?.max || null;
                        })
                    },
                    spo2: {
                        mean: recentSignals.map(s => {
                            const sp = getMetricValue(s, 'spo2');
                            return sp?.mean || null;
                        }),
                        min: recentSignals.map(s => {
                            const sp = getMetricValue(s, 'spo2');
                            return sp?.min || null;
                        }),
                        max: recentSignals.map(s => {
                            const sp = getMetricValue(s, 'spo2');
                            return sp?.max || null;
                        })
                    },
                    temperature: {
                        mean: recentSignals.map(s => {
                            const temp = getMetricValue(s, 'temperature');
                            return temp?.mean || null;
                        }),
                        min: recentSignals.map(s => {
                            const temp = getMetricValue(s, 'temperature');
                            return temp?.min || null;
                        }),
                        max: recentSignals.map(s => {
                            const temp = getMetricValue(s, 'temperature');
                            return temp?.max || null;
                        })
                    },
                    bloodPressure: {
                        systolic: {
                            mean: recentSignals.map(s => {
                                const bp = getMetricValue(s, 'blood_pressure');
                                return bp?.systolic?.mean || null;
                            }),
                            min: recentSignals.map(s => {
                                const bp = getMetricValue(s, 'blood_pressure');
                                return bp?.systolic?.min || null;
                            }),
                            max: recentSignals.map(s => {
                                const bp = getMetricValue(s, 'blood_pressure');
                                return bp?.systolic?.max || null;
                            })
                        },
                        diastolic: {
                            mean: recentSignals.map(s => {
                                const bp = getMetricValue(s, 'blood_pressure');
                                return bp?.diastolic?.mean || null;
                            }),
                            min: recentSignals.map(s => {
                                const bp = getMetricValue(s, 'blood_pressure');
                                return bp?.diastolic?.min || null;
                            }),
                            max: recentSignals.map(s => {
                                const bp = getMetricValue(s, 'blood_pressure');
                                return bp?.diastolic?.max || null;
                            })
                        }
                    }
                };
            }, [recentSignals]); // 只在 recentSignals 变化时重新计算

            // 使用 useEffect 初始化 Chart.js 图表
            React.useEffect(() => {
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js 未加载');
                    return;
                }

                // 清理之前的图表实例
                const cleanup = () => {
                    if (hrChartInstance.current) {
                        hrChartInstance.current.destroy();
                        hrChartInstance.current = null;
                    }
                    if (spo2ChartInstance.current) {
                        spo2ChartInstance.current.destroy();
                        spo2ChartInstance.current = null;
                    }
                    if (tempChartInstance.current) {
                        tempChartInstance.current.destroy();
                        tempChartInstance.current = null;
                    }
                    if (bpChartInstance.current) {
                        bpChartInstance.current.destroy();
                        bpChartInstance.current = null;
                    }
                };

                cleanup();

                // 心率图表
                if (hrChartRef.current && chartData.heartRate.mean.some(v => v !== null)) {
                    const hrMean = chartData.heartRate.mean;
                    const hrMin = chartData.heartRate.min;
                    const hrMax = chartData.heartRate.max;
                    // 收集所有需要显示的值（包括数据和基线）
                    const allDisplayValues = [
                        ...hrMean,
                        ...hrMin,
                        ...hrMax,
                        ...(baselineHR !== null ? [baselineHR] : [])
                    ].filter(v => v !== null);
                    if (allDisplayValues.length > 0) {
                        const displayMin = Math.min(...allDisplayValues);
                        const displayMax = Math.max(...allDisplayValues);
                        const range = displayMax - displayMin;
                        const margin = Math.max(range * 0.1, 5); // 至少5的边距
                        const yMin = Math.max(40, Math.floor(displayMin - margin));
                        const yMax = Math.min(120, Math.ceil(displayMax + margin));

                        hrChartInstance.current = new Chart(hrChartRef.current, {
                            type: 'line',
                            data: {
                                labels: chartData.labels,
                                datasets: [
                                    {
                                        label: '最小值',
                                        data: hrMin,
                                        borderColor: 'transparent',
                                        backgroundColor: 'transparent',
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    {
                                        label: t.fluctuationRange,
                                        data: hrMax,
                                        borderColor: 'rgba(239, 68, 68, 0.2)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.12)',
                                        pointRadius: 0,
                                        fill: '-1',
                                        tension: 0.4,
                                        order: 2
                                    },
                                    {
                                        label: t.heartRateLabel,
                                        data: hrMean,
                                        borderColor: '#ef4444',
                                        backgroundColor: 'transparent',
                                        borderWidth: 3,
                                        tension: 0.4,
                                        pointRadius: 2,
                                        pointHoverRadius: 4,
                                        pointBackgroundColor: '#ef4444',
                                        fill: false,
                                        order: 1
                                    },
                                    {
                                        label: t.normalRange,
                                        data: new Array(chartData.labels.length).fill(100),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    {
                                        label: t.normalRangeLower,
                                        data: new Array(chartData.labels.length).fill(60),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    // 患者基线 - 灰色细实线
                                    ...(baselineHR !== null ? [{
                                        label: t.patientBaseline,
                                        data: new Array(chartData.labels.length).fill(baselineHR),
                                        borderColor: '#B0B0B0',
                                        borderDash: [],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 2
                                    }] : [])
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: { intersect: false, mode: 'index' },
                                plugins: {
                                    title: { display: false },
                                    legend: {
                                        display: true,
                                        filter: (legendItem) => {
                                            const text = legendItem.text;
                                            return text === t.heartRateLabel ||
                                                text === t.normalRange ||
                                                (text === t.patientBaseline && baselineHR !== null);
                                        },
                                        labels: {
                                            generateLabels: (chart) => {
                                                const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                                const filtered = original.filter((label) => {
                                                    const text = label.text;
                                                    return text === t.heartRateLabel ||
                                                        text === t.normalRange ||
                                                        (text === t.patientBaseline && baselineHR !== null);
                                                });
                                                return filtered.map((label) => {
                                                    if (label.text === t.normalRange) {
                                                        return { ...label, text: t.normalRangeText, fontColor: '#6b7280' };
                                                    } else if (label.text === t.patientBaseline) {
                                                        return { ...label, text: `${t.baselineText} (${baselineHR} bpm)`, fontColor: '#9ca3af' };
                                                    }
                                                    return label;
                                                });
                                            },
                                            usePointStyle: false,
                                            padding: 8,
                                            font: { size: 11 }
                                        }
                                    },
                                    tooltip: {
                                        filter: (tooltipItem) => tooltipItem.datasetIndex === 0 || tooltipItem.datasetIndex === 2,
                                        callbacks: {
                                            title: (context) => context[0].label,
                                            label: (context) => {
                                                const index = context.dataIndex;
                                                if (context.datasetIndex === 0) {
                                                    const minVal = hrMin[index];
                                                    const warning = minVal < 60 ? t.belowNormalWarning : '';
                                                    return `${t.lowestValue}: ${minVal}${warning}`;
                                                } else if (context.datasetIndex === 2) {
                                                    return `${t.heartRateTooltip}: ${hrMean[index]} bpm (${t.rangeTooltip}: ${hrMin[index]}-${hrMax[index]} bpm)`;
                                                }
                                                return null;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: false, min: yMin, max: yMax },
                                    x: { ticks: { maxRotation: 0, minRotation: 0, font: { size: 10 } } }
                                }
                            }
                        });
                    }
                }

                // 血氧图表
                if (spo2ChartRef.current && chartData.spo2.mean.some(v => v !== null)) {
                    const spo2Mean = chartData.spo2.mean;
                    const spo2Min = chartData.spo2.min;
                    const spo2Max = chartData.spo2.max;
                    // 收集所有需要显示的值（包括数据和基线）
                    const allDisplayValues = [
                        ...spo2Mean,
                        ...spo2Min,
                        ...spo2Max,
                        ...(baselineSpo2 !== null ? [baselineSpo2] : [])
                    ].filter(v => v !== null);
                    if (allDisplayValues.length > 0) {
                        const displayMin = Math.min(...allDisplayValues);
                        const displayMax = Math.max(...allDisplayValues);
                        const range = displayMax - displayMin;
                        const margin = Math.max(range * 0.1, 1); // 至少1的边距
                        const yMin = Math.max(85, Math.floor((displayMin - margin) * 10) / 10);
                        const yMax = Math.min(100, Math.ceil((displayMax + margin) * 10) / 10);

                        spo2ChartInstance.current = new Chart(spo2ChartRef.current, {
                            type: 'line',
                            data: {
                                labels: chartData.labels,
                                datasets: [
                                    {
                                        label: t.lowestValue,
                                        data: spo2Min,
                                        borderColor: 'transparent',
                                        backgroundColor: 'transparent',
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    {
                                        label: t.fluctuationRange,
                                        data: spo2Max,
                                        borderColor: 'rgba(59, 130, 246, 0.2)',
                                        backgroundColor: 'rgba(59, 130, 246, 0.12)',
                                        pointRadius: 0,
                                        fill: '-1',
                                        tension: 0.4,
                                        order: 2
                                    },
                                    {
                                        label: t.averageSpO2Label,
                                        data: spo2Mean,
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'transparent',
                                        borderWidth: 3,
                                        tension: 0.4,
                                        pointRadius: 2,
                                        pointHoverRadius: 4,
                                        pointBackgroundColor: '#3b82f6',
                                        fill: false,
                                        order: 1
                                    },
                                    {
                                        label: '正常范围',
                                        data: new Array(chartData.labels.length).fill(95),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    // 患者基线 - 灰色细实线
                                    ...(baselineSpo2 !== null ? [{
                                        label: t.patientBaseline,
                                        data: new Array(chartData.labels.length).fill(baselineSpo2),
                                        borderColor: '#B0B0B0',
                                        borderDash: [],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 2
                                    }] : [])
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: { intersect: false, mode: 'index' },
                                plugins: {
                                    title: { display: false },
                                    legend: {
                                        display: true,
                                        filter: (legendItem) => {
                                            const text = legendItem.text;
                                            return text === t.averageSpO2Label ||
                                                text === t.normalRange ||
                                                (text === t.patientBaseline && baselineSpo2 !== null);
                                        },
                                        labels: {
                                            generateLabels: (chart) => {
                                                const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                                const filtered = original.filter((label) => {
                                                    const text = label.text;
                                                    return text === t.averageSpO2Label ||
                                                        text === t.normalRange ||
                                                        (text === t.patientBaseline && baselineSpo2 !== null);
                                                });
                                                return filtered.map((label) => {
                                                    if (label.text === '正常范围') {
                                                        return { ...label, text: '正常范围 (≥95%)', fontColor: '#6b7280' };
                                                    } else if (label.text === t.patientBaseline) {
                                                        return { ...label, text: `${t.baselineText} (${baselineSpo2}%)`, fontColor: '#9ca3af' };
                                                    }
                                                    return label;
                                                });
                                            },
                                            usePointStyle: false,
                                            padding: 8,
                                            font: { size: 11 }
                                        }
                                    },
                                    tooltip: {
                                        filter: (tooltipItem) => tooltipItem.datasetIndex === 0 || tooltipItem.datasetIndex === 2,
                                        callbacks: {
                                            title: (context) => context[0].label,
                                            label: (context) => {
                                                const index = context.dataIndex;
                                                if (context.datasetIndex === 0) {
                                                    const minVal = spo2Min[index];
                                                    const warning = minVal < 95 ? t.belowNormalWarning : '';
                                                    return `${t.lowestValue}: ${minVal}%${warning}`;
                                                } else if (context.datasetIndex === 2) {
                                                    return `${t.averageTooltip}: ${spo2Mean[index]}% (${t.rangeTooltip}: ${spo2Min[index]}-${spo2Max[index]}%)`;
                                                }
                                                return null;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: false, min: yMin, max: yMax },
                                    x: { ticks: { maxRotation: 0, minRotation: 0, font: { size: 10 } } }
                                }
                            }
                        });
                    }
                }

                // 体温图表
                if (tempChartRef.current && chartData.temperature.mean.some(v => v !== null)) {
                    const tempMean = chartData.temperature.mean;
                    const tempMin = chartData.temperature.min;
                    const tempMax = chartData.temperature.max;
                    // 收集所有需要显示的值（包括数据和基线）
                    const allDisplayValues = [
                        ...tempMean,
                        ...tempMin,
                        ...tempMax,
                        ...(baselineTemp !== null ? [baselineTemp] : [])
                    ].filter(v => v !== null);
                    if (allDisplayValues.length > 0) {
                        const displayMin = Math.min(...allDisplayValues);
                        const displayMax = Math.max(...allDisplayValues);
                        const range = displayMax - displayMin;
                        const margin = Math.max(range * 0.1, 0.2); // 至少0.2的边距
                        const yMin = Math.max(35.5, Math.floor((displayMin - margin) * 10) / 10);
                        const yMax = Math.min(38.0, Math.ceil((displayMax + margin) * 10) / 10);

                        tempChartInstance.current = new Chart(tempChartRef.current, {
                            type: 'line',
                            data: {
                                labels: chartData.labels,
                                datasets: [
                                    {
                                        label: t.lowestValue,
                                        data: tempMin,
                                        borderColor: 'transparent',
                                        backgroundColor: 'transparent',
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    {
                                        label: t.fluctuationRange,
                                        data: tempMax,
                                        borderColor: 'rgba(245, 158, 11, 0.2)',
                                        backgroundColor: 'rgba(245, 158, 11, 0.12)',
                                        pointRadius: 0,
                                        fill: '-1',
                                        tension: 0.4,
                                        order: 2
                                    },
                                    {
                                        label: t.temperatureLabel,
                                        data: tempMean,
                                        borderColor: '#f59e0b',
                                        backgroundColor: 'transparent',
                                        borderWidth: 3,
                                        tension: 0.4,
                                        pointRadius: 2,
                                        pointHoverRadius: 4,
                                        pointBackgroundColor: '#f59e0b',
                                        fill: false,
                                        order: 1
                                    },
                                    {
                                        label: t.normalRange,
                                        data: new Array(chartData.labels.length).fill(37.2),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    {
                                        label: t.normalRangeLower,
                                        data: new Array(chartData.labels.length).fill(36.1),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    // 患者基线 - 灰色细实线
                                    ...(baselineTemp !== null ? [{
                                        label: t.patientBaseline,
                                        data: new Array(chartData.labels.length).fill(baselineTemp),
                                        borderColor: '#B0B0B0',
                                        borderDash: [],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 2
                                    }] : [])
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: { intersect: false, mode: 'index' },
                                plugins: {
                                    title: { display: false },
                                    legend: {
                                        display: true,
                                        filter: (legendItem) => {
                                            const text = legendItem.text;
                                            return text === t.temperatureLabel ||
                                                text === t.normalRange ||
                                                (text === t.patientBaseline && baselineTemp !== null);
                                        },
                                        labels: {
                                            generateLabels: (chart) => {
                                                const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                                const filtered = original.filter((label) => {
                                                    const text = label.text;
                                                    return text === t.temperatureLabel ||
                                                        text === t.normalRange ||
                                                        (text === t.patientBaseline && baselineTemp !== null);
                                                });
                                                return filtered.map((label) => {
                                                    if (label.text === t.normalRange) {
                                                        return { ...label, text: '正常范围 (36.1-37.2°C)', fontColor: '#6b7280' };
                                                    } else if (label.text === t.patientBaseline) {
                                                        return { ...label, text: `${t.baselineText} (${baselineTemp}°C)`, fontColor: '#9ca3af' };
                                                    }
                                                    return label;
                                                });
                                            },
                                            usePointStyle: false,
                                            padding: 8,
                                            font: { size: 11 }
                                        }
                                    },
                                    tooltip: {
                                        filter: (tooltipItem) => tooltipItem.datasetIndex === 2,
                                        callbacks: {
                                            title: (context) => context[0].label,
                                            label: (context) => {
                                                const index = context.dataIndex;
                                                return `${t.temperatureTooltip}: ${tempMean[index]} °C (${t.rangeTooltip}: ${tempMin[index]}-${tempMax[index]} °C)`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: false, min: yMin, max: yMax },
                                    x: { ticks: { maxRotation: 0, minRotation: 0, font: { size: 10 } } }
                                }
                            }
                        });
                    }
                }

                // 血压图表
                if (bpChartRef.current && (chartData.bloodPressure.systolic.mean.some(v => v !== null) || chartData.bloodPressure.diastolic.mean.some(v => v !== null))) {
                    const sbpMean = chartData.bloodPressure.systolic.mean;
                    const dbpMean = chartData.bloodPressure.diastolic.mean;
                    // 收集所有需要显示的值（包括数据和基线）
                    const allDisplayValues = [
                        ...sbpMean,
                        ...dbpMean,
                        ...(baselineSBP !== null ? [baselineSBP] : []),
                        ...(baselineDBP !== null ? [baselineDBP] : [])
                    ].filter(v => v !== null);
                    if (allDisplayValues.length > 0) {
                        const displayMin = Math.min(...allDisplayValues);
                        const displayMax = Math.max(...allDisplayValues);
                        const range = displayMax - displayMin;
                        const margin = Math.max(range * 0.1, 10); // 至少10的边距
                        const yMin = Math.max(40, Math.floor(displayMin - margin));
                        const yMax = Math.min(180, Math.ceil(displayMax + margin));

                        bpChartInstance.current = new Chart(bpChartRef.current, {
                            type: 'line',
                            data: {
                                labels: chartData.labels,
                                datasets: [
                                    {
                                        label: t.systolicPressure,
                                        data: sbpMean,
                                        borderColor: '#dc2626',
                                        backgroundColor: 'transparent',
                                        borderWidth: 3,
                                        tension: 0.4,
                                        pointRadius: 2,
                                        pointHoverRadius: 4,
                                        pointBackgroundColor: '#dc2626',
                                        fill: false,
                                        order: 1
                                    },
                                    {
                                        label: t.diastolicPressure,
                                        data: dbpMean,
                                        borderColor: '#f59e0b',
                                        backgroundColor: 'transparent',
                                        borderWidth: 3,
                                        tension: 0.4,
                                        pointRadius: 2,
                                        pointHoverRadius: 4,
                                        pointBackgroundColor: '#f59e0b',
                                        fill: false,
                                        order: 1
                                    },
                                    // 收缩压正常范围虚线
                                    {
                                        label: t.systolicNormalRangeUpper,
                                        data: new Array(chartData.labels.length).fill(140),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    {
                                        label: t.systolicNormalRangeLower,
                                        data: new Array(chartData.labels.length).fill(90),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    // 舒张压正常范围虚线
                                    {
                                        label: t.diastolicNormalRangeUpper,
                                        data: new Array(chartData.labels.length).fill(90),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    {
                                        label: t.diastolicNormalRangeLower,
                                        data: new Array(chartData.labels.length).fill(60),
                                        borderColor: 'rgba(34, 197, 94, 0.5)',
                                        borderDash: [6, 3],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 3
                                    },
                                    // 患者基线 - 灰色细实线
                                    ...(baselineSBP !== null ? [{
                                        label: t.baselineSystolicPressure,
                                        data: new Array(chartData.labels.length).fill(baselineSBP),
                                        borderColor: '#B0B0B0',
                                        borderDash: [],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 2
                                    }] : []),
                                    ...(baselineDBP !== null ? [{
                                        label: t.baselineDiastolicPressure,
                                        data: new Array(chartData.labels.length).fill(baselineDBP),
                                        borderColor: '#B0B0B0',
                                        borderDash: [],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        order: 2
                                    }] : [])
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: { intersect: false, mode: 'index' },
                                plugins: {
                                    title: { display: false },
                                    legend: {
                                        display: true,
                                        filter: (legendItem) => {
                                            const text = legendItem.text;
                                            return text === t.systolicPressure ||
                                                text === t.diastolicPressure ||
                                                text === t.systolicNormalRangeUpper ||
                                                (text === t.baselineSystolicPressure && baselineSBP !== null) ||
                                                (text === t.baselineDiastolicPressure && baselineDBP !== null);
                                        },
                                        labels: {
                                            generateLabels: (chart) => {
                                                const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                                const filtered = original.filter((label) => {
                                                    const text = label.text;
                                                    return text === t.systolicPressure ||
                                                        text === t.diastolicPressure ||
                                                        text === t.systolicNormalRangeUpper ||
                                                        (text === t.baselineSystolicPressure && baselineSBP !== null) ||
                                                        (text === t.baselineDiastolicPressure && baselineDBP !== null);
                                                });
                                                return filtered.map((label) => {
                                                    if (label.text === t.systolicNormalRangeUpper) {
                                                        return { ...label, text: '正常范围 (收缩压90-140, 舒张压60-90)', fontColor: '#6b7280' };
                                                    } else if (label.text === t.baselineSystolicPressure) {
                                                        return { ...label, text: `${t.baselineText} (${baselineSBP}/${baselineDBP !== null ? baselineDBP : '--'} mmHg)`, fontColor: '#9ca3af' };
                                                    } else if (label.text === t.baselineDiastolicPressure) {
                                                        // 已经在收缩压基线中显示了
                                                        return null;
                                                    }
                                                    return label;
                                                }).filter(label => label !== null);
                                            },
                                            usePointStyle: false,
                                            padding: 8,
                                            font: { size: 11 }
                                        }
                                    },
                                    tooltip: {
                                        filter: (tooltipItem) => tooltipItem.datasetIndex === 0 || tooltipItem.datasetIndex === 1,
                                        callbacks: {
                                            title: (context) => context[0].label,
                                            label: (context) => {
                                                const index = context.dataIndex;
                                                if (context.datasetIndex === 0) {
                                                    return `收缩压: ${sbpMean[index]} mmHg`;
                                                } else if (context.datasetIndex === 1) {
                                                    return `舒张压: ${dbpMean[index]} mmHg`;
                                                }
                                                return null;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: false, min: yMin, max: yMax },
                                    x: { ticks: { maxRotation: 0, minRotation: 0, font: { size: 10 } } }
                                }
                            }
                        });
                    }
                }

                return cleanup;
            }, [viewMode]); // 只在 viewMode 变化时重新加载图表


            return (
                <div className="grid grid-cols-2 gap-4">
                    {/* 血压图表 */}
                    {(chartData.bloodPressure.systolic.mean.some(v => v !== null) || chartData.bloodPressure.diastolic.mean.some(v => v !== null)) && (
                        <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <div className="flex items-center gap-1.5">
                                        <div className="w-2 h-2 rounded-full bg-red-600"></div>
                                        <div className="w-2 h-2 rounded-full bg-amber-500"></div>
                                    </div>
                                    <span className="text-xs font-semibold text-slate-700">{t.bloodPressureLabel}</span>
                                </div>
                            </div>
                            <div style={{ height: '180px', position: 'relative' }}>
                                <canvas ref={bpChartRef}></canvas>
                            </div>
                        </div>
                    )}

                    {/* 心率图表 */}
                    {chartData.heartRate.mean.some(v => v !== null) && (
                        <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-red-500"></div>
                                    <span className="text-xs font-semibold text-slate-700">{t.heartRateLabel}</span>
                                </div>
                            </div>
                            <div style={{ height: '180px', position: 'relative' }}>
                                <canvas ref={hrChartRef}></canvas>
                            </div>
                        </div>
                    )}

                    {/* 体温图表 */}
                    {chartData.temperature.mean.some(v => v !== null) && (
                        <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-amber-500"></div>
                                    <span className="text-xs font-semibold text-slate-700">体温 (°C)</span>
                                </div>
                            </div>
                            <div style={{ height: '180px', position: 'relative' }}>
                                <canvas ref={tempChartRef}></canvas>
                            </div>
                        </div>
                    )}

                    {/* 血氧图表 */}
                    {chartData.spo2.mean.some(v => v !== null) && (
                        <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                    <span className="text-xs font-semibold text-slate-700">{t.spO2ShortLabel}</span>
                                </div>
                            </div>
                            <div style={{ height: '180px', position: 'relative' }}>
                                <canvas ref={spo2ChartRef}></canvas>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Raw Signal 可视化组件（1小时内的原始事件时间序列数据） ---
        const RawSignalVisualization = ({ rawSignals, data, viewMode }) => {
            // 获取当前语言配置
            const currentLang = getLanguage();
            const t = LANGUAGE_CONFIG[currentLang];
            const hrChartRef = React.useRef(null);
            const spo2ChartRef = React.useRef(null);
            const bpChartRef = React.useRef(null);
            const stepChartRef = React.useRef(null);
            const hrChartInstance = React.useRef(null);
            const spo2ChartInstance = React.useRef(null);
            const bpChartInstance = React.useRef(null);
            const stepChartInstance = React.useRef(null);

            // 提取 raw_signals 数据
            const rawSignalData = React.useMemo(() => {
                // 尝试多个可能的数据路径
                const rawSignalsList = rawSignals ||
                    data?.raw_signals ||
                    data?.bundle?.data?.raw_signals ||
                    [];

                console.log('🔍 RawSignalVisualization - rawSignals:', rawSignals);
                console.log('🔍 RawSignalVisualization - data?.raw_signals:', data?.raw_signals);
                console.log('🔍 RawSignalVisualization - rawSignalsList:', rawSignalsList);

                if (!rawSignalsList || !Array.isArray(rawSignalsList) || rawSignalsList.length === 0) {
                    console.warn('⚠️ raw_signals 为空或不是数组');
                    return null;
                }

                const firstRawSignal = rawSignalsList[0];
                console.log('🔍 RawSignalVisualization - firstRawSignal:', firstRawSignal);
                console.log('🔍 RawSignalVisualization - firstRawSignal.data:', firstRawSignal?.data);

                return firstRawSignal?.data || null;
            }, [rawSignals, data]);

            // 提取对应的 summary_text（通过 signal_id 匹配）
            const summaryText = React.useMemo(() => {
                const rawSignalsList = rawSignals ||
                    data?.raw_signals ||
                    data?.bundle?.data?.raw_signals ||
                    [];

                if (!rawSignalsList || !Array.isArray(rawSignalsList) || rawSignalsList.length === 0) {
                    return null;
                }

                const firstRawSignal = rawSignalsList[0];
                const signalId = firstRawSignal?.signal_id;

                if (!signalId) {
                    return null;
                }

                // 从 bundle.data.signals 中查找对应的 signal
                // signals 可能是一个对象（包含 signals_list 和 summary_text）或数组
                const signalsData = data?.bundle?.data?.signals || data?.signals;

                // 如果 signalsData 是对象且有 summary_text，直接返回
                if (signalsData && typeof signalsData === 'object' && !Array.isArray(signalsData)) {
                    if (signalsData.summary_text) {
                        return signalsData.summary_text;
                    }
                    // 如果有 signals_list，从数组中查找
                    if (Array.isArray(signalsData.signals_list) && signalsData.signals_list.length > 0) {
                        const matchedSignal = signalsData.signals_list.find(s => s.signal_id === signalId);
                        return matchedSignal?.summary_text || null;
                    }
                }

                // 如果 signalsData 是数组，直接查找
                if (Array.isArray(signalsData) && signalsData.length > 0) {
                    const matchedSignal = signalsData.find(s => s.signal_id === signalId);
                    return matchedSignal?.summary_text || null;
                }

                return null;
            }, [rawSignals, data]);

            // 提取基线值
            const { baselineHR, baselineSpo2, baselineSBP, baselineDBP } = React.useMemo(() => {
                const patient = data?.patient || {};
                const baselineVitals = patient.baseline_vitals || {};
                const baselineHR = baselineVitals['心率'] || baselineVitals.heart_rate || null;
                const baselineSpo2 = baselineVitals['血氧'] || baselineVitals.spo2 || null;
                const baselineBP = baselineVitals['血压'] || baselineVitals.blood_pressure || null;
                const baselineSBP = baselineBP?.收缩压 || baselineBP?.systolic || null;
                const baselineDBP = baselineBP?.舒张压 || baselineBP?.diastolic || null;
                return { baselineHR, baselineSpo2, baselineSBP, baselineDBP };
            }, [data]);

            if (!rawSignalData) {
                return (
                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <p className="text-xs text-slate-400 text-center">暂无原始信号数据</p>
                    </div>
                );
            }

            // 处理原始事件数据，转换为图表格式
            const processEventData = React.useMemo(() => {
                const hrEvents = rawSignalData.hr_event || [];
                const bpEvents = rawSignalData.bp_event || [];
                const boEvents = rawSignalData.bo_event || [];
                const stepEvents = rawSignalData.step_event || [];

                return {
                    heartRate: {
                        labels: hrEvents.map(e => {
                            try {
                                const date = new Date(e.time);
                                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            } catch {
                                return e.time?.substring(11, 19) || e.time;
                            }
                        }),
                        values: hrEvents.map(e => e.event_data?.hr || null)
                    },
                    bloodPressure: {
                        labels: bpEvents.map(e => {
                            try {
                                const date = new Date(e.time);
                                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            } catch {
                                return e.time?.substring(11, 19) || e.time;
                            }
                        }),
                        systolic: bpEvents.map(e => e.event_data?.sbp || null),
                        diastolic: bpEvents.map(e => e.event_data?.dbp || null)
                    },
                    spo2: {
                        labels: boEvents.map(e => {
                            try {
                                const date = new Date(e.time);
                                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            } catch {
                                return e.time?.substring(11, 19) || e.time;
                            }
                        }),
                        values: boEvents.map(e => e.event_data?.oxygen || null)
                    },
                    steps: {
                        labels: stepEvents.map(e => {
                            try {
                                const date = new Date(e.time);
                                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            } catch {
                                return e.time?.substring(11, 19) || e.time;
                            }
                        }),
                        values: stepEvents.map(e => e.event_data?.step_count || 0)
                    }
                };
            }, [rawSignalData]);

            // 使用 useEffect 初始化 Chart.js 图表（简化版，与 diagnosis-system-review-ui 相同的逻辑）
            React.useEffect(() => {
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js 未加载');
                    return;
                }

                const cleanup = () => {
                    [hrChartInstance, spo2ChartInstance, bpChartInstance, stepChartInstance].forEach(ref => {
                        if (ref.current) {
                            ref.current.destroy();
                            ref.current = null;
                        }
                    });
                };

                cleanup();

                // 心率图表
                if (hrChartRef.current && processEventData.heartRate.values.length > 0 && processEventData.heartRate.values.some(v => v !== null)) {
                    const hrValues = processEventData.heartRate.values;
                    // 收集所有需要显示的值（包括数据和基线）
                    const allDisplayValues = [
                        ...hrValues.filter(v => v !== null),
                        ...(baselineHR !== null ? [baselineHR] : [])
                    ];
                    if (allDisplayValues.length > 0) {
                        const displayMin = Math.min(...allDisplayValues);
                        const displayMax = Math.max(...allDisplayValues);
                        const range = displayMax - displayMin;
                        const margin = Math.max(range * 0.1, 5); // 至少5的边距
                        const yMin = Math.max(40, Math.floor(displayMin - margin));
                        const yMax = Math.min(120, Math.ceil(displayMax + margin));

                        hrChartInstance.current = new Chart(hrChartRef.current, {
                            type: 'line',
                            data: {
                                labels: processEventData.heartRate.labels,
                                datasets: [
                                    {
                                        label: t.heartRateLabel,
                                        data: hrValues,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        pointRadius: 4,
                                        pointHoverRadius: 6,
                                        tension: 0.4,
                                        fill: false
                                    },
                                    ...(baselineHR ? [{
                                        label: t.baselineText,
                                        data: new Array(hrValues.length).fill(baselineHR),
                                        borderColor: 'rgb(148, 163, 184)',
                                        backgroundColor: 'transparent',
                                        borderDash: [5, 5],
                                        pointRadius: 0,
                                        fill: false
                                    }] : [])
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true, position: 'top', labels: { font: { size: 11 } } },
                                    title: { display: false }
                                },
                                scales: {
                                    y: { min: yMin, max: yMax, title: { display: true, text: 'bpm' } },
                                    x: { title: { display: true, text: t.time } }
                                }
                            }
                        });
                    }
                }

                // 血压图表
                if (bpChartRef.current && processEventData.bloodPressure.systolic.length > 0 && processEventData.bloodPressure.systolic.some(v => v !== null)) {
                    const sbpValues = processEventData.bloodPressure.systolic;
                    const dbpValues = processEventData.bloodPressure.diastolic;
                    // 收集所有需要显示的值（包括数据和基线）
                    const allDisplayValues = [
                        ...sbpValues.filter(v => v !== null),
                        ...dbpValues.filter(v => v !== null),
                        ...(baselineSBP !== null ? [baselineSBP] : []),
                        ...(baselineDBP !== null ? [baselineDBP] : [])
                    ];
                    if (allDisplayValues.length > 0) {
                        const displayMin = Math.min(...allDisplayValues);
                        const displayMax = Math.max(...allDisplayValues);
                        const range = displayMax - displayMin;
                        const margin = Math.max(range * 0.1, 10); // 至少10的边距
                        const yMin = Math.max(60, Math.floor(displayMin - margin));
                        const yMax = Math.min(180, Math.ceil(displayMax + margin));

                        bpChartInstance.current = new Chart(bpChartRef.current, {
                            type: 'line',
                            data: {
                                labels: processEventData.bloodPressure.labels,
                                datasets: [
                                    {
                                        label: `${t.systolicPressure} (mmHg)`,
                                        data: sbpValues,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        pointRadius: 4,
                                        pointHoverRadius: 6,
                                        tension: 0.4,
                                        fill: false
                                    },
                                    {
                                        label: `${t.diastolicPressure} (mmHg)`,
                                        data: dbpValues,
                                        borderColor: 'rgb(59, 130, 246)',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        pointRadius: 4,
                                        pointHoverRadius: 6,
                                        tension: 0.4,
                                        fill: false
                                    },
                                    ...(baselineSBP && baselineDBP ? [{
                                        label: t.baselineSystolic,
                                        data: new Array(sbpValues.length).fill(baselineSBP),
                                        borderColor: 'rgba(239, 68, 68, 0.3)',
                                        backgroundColor: 'transparent',
                                        borderDash: [5, 5],
                                        pointRadius: 0,
                                        fill: false
                                    }, {
                                        label: t.baselineDiastolic,
                                        data: new Array(dbpValues.length).fill(baselineDBP),
                                        borderColor: 'rgba(59, 130, 246, 0.3)',
                                        backgroundColor: 'transparent',
                                        borderDash: [5, 5],
                                        pointRadius: 0,
                                        fill: false
                                    }] : [])
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true, position: 'top', labels: { font: { size: 11 } } },
                                    title: { display: false }
                                },
                                scales: {
                                    y: { min: yMin, max: yMax, title: { display: true, text: 'mmHg' } },
                                    x: { title: { display: true, text: t.time } }
                                }
                            }
                        });
                    }
                }

                // 血氧图表
                if (spo2ChartRef.current && processEventData.spo2.values.length > 0 && processEventData.spo2.values.some(v => v !== null)) {
                    const spo2Values = processEventData.spo2.values;
                    // 收集所有需要显示的值（包括数据和基线）
                    const allDisplayValues = [
                        ...spo2Values.filter(v => v !== null),
                        ...(baselineSpo2 !== null ? [baselineSpo2] : [])
                    ];
                    if (allDisplayValues.length > 0) {
                        const displayMin = Math.min(...allDisplayValues);
                        const displayMax = Math.max(...allDisplayValues);
                        const range = displayMax - displayMin;
                        const margin = Math.max(range * 0.1, 1); // 至少1的边距
                        const yMin = Math.max(90, Math.floor(displayMin - margin));
                        const yMax = Math.min(100, Math.ceil(displayMax + margin));

                        spo2ChartInstance.current = new Chart(spo2ChartRef.current, {
                            type: 'line',
                            data: {
                                labels: processEventData.spo2.labels,
                                datasets: [
                                    {
                                        label: t.spO2Label,
                                        data: spo2Values,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        pointRadius: 3,
                                        pointHoverRadius: 5,
                                        tension: 0.4,
                                        fill: false
                                    },
                                    ...(baselineSpo2 ? [{
                                        label: t.baselineText,
                                        data: new Array(spo2Values.length).fill(baselineSpo2),
                                        borderColor: 'rgb(148, 163, 184)',
                                        backgroundColor: 'transparent',
                                        borderDash: [5, 5],
                                        pointRadius: 0,
                                        fill: false
                                    }] : [])
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true, position: 'top', labels: { font: { size: 11 } } },
                                    title: { display: false }
                                },
                                scales: {
                                    y: { min: yMin, max: yMax, title: { display: true, text: '%' } },
                                    x: { title: { display: true, text: t.time } }
                                }
                            }
                        });
                    }
                }

                // 步数图表
                if (stepChartRef.current && processEventData.steps.values.length > 0) {
                    stepChartInstance.current = new Chart(stepChartRef.current, {
                        type: 'bar',
                        data: {
                            labels: processEventData.steps.labels,
                            datasets: [{
                                label: t.stepsLabel,
                                data: processEventData.steps.values,
                                backgroundColor: 'rgba(139, 92, 246, 0.6)',
                                borderColor: 'rgb(139, 92, 246)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'top', labels: { font: { size: 11 } } },
                                title: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: t.stepsPerMinute } },
                                x: { title: { display: true, text: t.time } }
                            }
                        }
                    });
                }

                return cleanup;
            }, [processEventData, baselineHR, baselineSpo2, baselineSBP, baselineDBP, viewMode, currentLang, t]);

            return (
                <>
                    <div className="grid grid-cols-2 gap-4">
                        {/* 心率图表 */}
                        {processEventData.heartRate.values.length > 0 && (
                            <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-red-500"></div>
                                        <span className="text-xs font-semibold text-slate-700">{t.heartRateLabel}</span>
                                    </div>
                                </div>
                                <div style={{ height: '180px', position: 'relative' }}>
                                    <canvas ref={hrChartRef}></canvas>
                                </div>
                            </div>
                        )}

                        {/* 血压图表 */}
                        {processEventData.bloodPressure.systolic.length > 0 && (
                            <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <div className="flex items-center gap-1.5">
                                            <div className="w-2 h-2 rounded-full bg-red-600"></div>
                                            <div className="w-2 h-2 rounded-full bg-amber-500"></div>
                                        </div>
                                        <span className="text-xs font-semibold text-slate-700">{t.bloodPressureLabel}</span>
                                    </div>
                                </div>
                                <div style={{ height: '180px', position: 'relative' }}>
                                    <canvas ref={bpChartRef}></canvas>
                                </div>
                            </div>
                        )}

                        {/* 血氧图表 */}
                        {processEventData.spo2.values.length > 0 && (
                            <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                        <span className="text-xs font-semibold text-slate-700">{t.spO2ShortLabel}</span>
                                    </div>
                                </div>
                                <div style={{ height: '180px', position: 'relative' }}>
                                    <canvas ref={spo2ChartRef}></canvas>
                                </div>
                            </div>
                        )}

                        {/* 步数图表 */}
                        {processEventData.steps.values.length > 0 && (
                            <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-purple-500"></div>
                                        <span className="text-xs font-semibold text-slate-700">{t.stepsLabel}</span>
                                    </div>
                                </div>
                                <div style={{ height: '180px', position: 'relative' }}>
                                    <canvas ref={stepChartRef}></canvas>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* AI生理信号状态分析 */}
                    {summaryText && (() => {
                        // 解析 summary_text，按段落分割
                        const sections = summaryText.split('\n\n').filter(s => s.trim());
                        const parseSection = (text) => {
                            if (text.startsWith('信号观察：')) {
                                return { type: 'observation', title: '信号观察', content: text.replace('信号观察：', '') };
                            } else if (text.startsWith('时段与档案推理：')) {
                                return { type: 'inference', title: '时段与档案推理', content: text.replace('时段与档案推理：', '') };
                            } else if (text.startsWith('综合判断：')) {
                                return { type: 'judgment', title: '综合判断', content: text.replace('综合判断：', '') };
                            }
                            return { type: 'other', title: '', content: text };
                        };

                        const parsedSections = sections.map(parseSection);

                        return (
                            <div className="mt-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                                <div className="p-4 border-b border-slate-200">
                                    <div className="flex items-center gap-2">
                                        <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                        <h3 className="text-sm font-bold text-slate-800">
                                            {t.aiPhysiologicalSignalAnalysis}
                                        </h3>
                                    </div>
                                </div>
                                <div className="p-4 space-y-3">
                                    {parsedSections.map((section, idx) => (
                                        <div key={idx} className={idx < parsedSections.length - 1 ? 'pb-3 border-b border-slate-100' : ''}>
                                            {section.title && (
                                                <div className="flex items-center gap-2 mb-2">
                                                    <div className={`w-1 h-4 rounded ${section.type === 'observation' ? 'bg-blue-500' :
                                                        section.type === 'inference' ? 'bg-indigo-500' :
                                                            'bg-purple-500'
                                                        }`}></div>
                                                    <h4 className="text-xs font-semibold text-slate-700">
                                                        {section.title}
                                                    </h4>
                                                </div>
                                            )}
                                            <div className="text-xs text-slate-600 leading-relaxed pl-3">
                                                {section.content.split('；').map((sentence, sidx) => (
                                                    <div key={sidx} className="mb-1.5">
                                                        {sentence.trim() && (
                                                            <span className="inline-block">
                                                                {sentence.trim()}
                                                                {sidx < section.content.split('；').length - 1 && '；'}
                                                            </span>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    })()}
                </>
            );
        };

        // --- 批注输入组件 ---
        const AnnotationInput = ({ targetPath, targetId, targetKind, originalValue, existingAnnotation, onSave, onDelete, showButton = true }) => {
            const [isAnnotating, setIsAnnotating] = useState(false);
            const [annotationText, setAnnotationText] = useState('');

            React.useEffect(() => {
                if (existingAnnotation) {
                    setAnnotationText(existingAnnotation.annotation_text || '');
                }
            }, [existingAnnotation]);

            const handleSave = () => {
                if (annotationText.trim()) {
                    onSave(annotationText.trim());
                    setAnnotationText('');
                    setIsAnnotating(false);
                }
            };

            const handleCancel = () => {
                setAnnotationText(existingAnnotation?.annotation_text || '');
                setIsAnnotating(false);
            };

            return (
                <div className="mt-2">
                    {existingAnnotation?.annotation_text && !isAnnotating && (
                        <div className="mb-2 p-2 bg-blue-50 border border-blue-200 rounded text-xs">
                            <div className="text-[10px] font-semibold text-blue-700 mb-1">{t.doctorAnnotation}</div>
                            <div className="text-xs text-blue-900">{existingAnnotation.annotation_text}</div>
                        </div>
                    )}
                    {isAnnotating ? (
                        <div className="p-2 bg-slate-50 border border-slate-200 rounded">
                            <textarea
                                value={annotationText}
                                onChange={(e) => setAnnotationText(e.target.value)}
                                className="w-full text-xs p-2 bg-white border border-slate-200 rounded shadow-sm focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-100"
                                rows="2"
                                placeholder={t.inputAnnotation}
                                autoFocus
                            />
                            <div className="flex justify-end mt-2 gap-2">
                                <button onClick={handleCancel} className="text-xs px-2 py-1 text-slate-500 hover:text-slate-700">{t.cancel}</button>
                                {existingAnnotation && (
                                    <button onClick={onDelete} className="text-xs px-2 py-1 text-red-600 hover:text-red-700">{t.delete}</button>
                                )}
                                <button onClick={handleSave} className="text-xs bg-blue-600 text-white px-2.5 py-1 rounded hover:bg-blue-700 shadow-sm">{t.save}</button>
                            </div>
                        </div>
                    ) : (
                        showButton && (
                            <button
                                onClick={() => setIsAnnotating(true)}
                                className="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"
                            >
                                <Edit3 size={10} />
                                <span>{existingAnnotation ? t.editAnnotation : t.addAnnotation}</span>
                            </button>
                        )
                    )}
                </div>
            );
        };

        // --- AI 任务块组件（支持批注） ---
        const AITaskBlock = ({ title, children, urgent, targetPath, targetId, targetKind, originalValue, annotations, onAnnotationSave, onAnnotationDelete }) => {
            const existingAnnotation = annotations?.find(a => a.target_path === targetPath);

            return (
                <div className={`relative rounded-lg p-3 transition-all group ${urgent ? 'bg-rose-50/50 border border-rose-100' : 'bg-white border border-slate-200 hover:border-blue-300'}`}>
                    <div className="flex justify-between items-center mb-1.5">
                        <h4 className={`text-xs font-bold flex items-center gap-1.5 ${urgent ? 'text-rose-700' : 'text-slate-700'}`}>
                            {urgent && <AlertCircle size={12} className="text-rose-500" />}
                            {title}
                            {existingAnnotation && (
                                <span className="ml-2 px-1.5 py-0.5 bg-blue-100 text-blue-700 text-[10px] rounded">{t.annotated}</span>
                            )}
                        </h4>
                    </div>

                    <div className="text-xs text-slate-600 leading-relaxed">
                        {children}
                    </div>

                    {targetPath && (
                        <div className="group">
                            <AnnotationInput
                                targetPath={targetPath}
                                targetId={targetId}
                                targetKind={targetKind}
                                originalValue={originalValue}
                                existingAnnotation={existingAnnotation}
                                onSave={(text) => onAnnotationSave(targetPath, targetId, targetKind, originalValue, null, text)}
                                onDelete={() => onAnnotationDelete(targetPath)}
                                showButton={true}
                            />
                        </div>
                    )}
                </div>
            );
        };

        // --- 信息卡片组件（保留用于其他部分） ---
        const InfoCard = ({ title, icon: Icon, children, urgent = false }) => (
            <div className={`rounded-lg p-4 transition-all ${urgent ? 'bg-rose-50/50 border border-rose-100' : 'bg-white border border-slate-200'}`}>
                <div className="flex items-center gap-2 mb-3">
                    {Icon && <Icon size={18} className={urgent ? 'text-rose-600' : 'text-blue-600'} />}
                    <h4 className={`text-sm font-bold ${urgent ? 'text-rose-700' : 'text-slate-700'}`}>
                        {title}
                    </h4>
                </div>
                <div className="text-sm text-slate-600 leading-relaxed">
                    {children}
                </div>
            </div>
        );

        // --- 主应用组件 ---
        function TriageReviewApp() {
            // 获取当前语言配置（必须在最前面）
            const currentLang = getLanguage();
            const t = LANGUAGE_CONFIG[currentLang];

            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);
            const [doctorComment, setDoctorComment] = useState('');
            const [doctorAgree, setDoctorAgree] = useState('true');
            const [submitting, setSubmitting] = useState(false);
            const [submitMessage, setSubmitMessage] = useState(null);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(true); // 默认折叠
            const [dialogueMessages, setDialogueMessages] = useState([]); // 对话历史
            const [expandedReason, setExpandedReason] = useState(null); // 展开的AI reasoning索引
            const [viewMode, setViewMode] = useState('shorthand'); // 视图模式：'shorthand' 或 'full'
            const [signalTab, setSignalTab] = useState('event'); // 信号可视化 Tab：'event'（事件详情）或 'trend'（长期趋势）

            // 批注和修改相关state
            const [annotations, setAnnotations] = useState([]); // 所有批注和修改
            const [editingAnnotations, setEditingAnnotations] = useState({}); // 正在编辑的批注 {targetPath: true/false}
            const [annotationInputs, setAnnotationInputs] = useState({}); // 批注输入内容 {targetPath: text}
            const [originalTriage, setOriginalTriage] = useState(null); // 系统原始值
            const [doctorTriage, setDoctorTriage] = useState({}); // 医生修改后的值
            const [dataPaths, setDataPaths] = useState({}); // 数据路径映射
            const [triageId, setTriageId] = useState(null); // triage的id
            const [doctorInfo, setDoctorInfo] = useState(null); // 分配的医生信息
            const [taskInfo, setTaskInfo] = useState(null); // 任务信息

            // 从URL获取task_id, user_id, scenario_id, doctor_id
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('task_id');
            const userId = urlParams.get('user_id');
            const scenarioId = urlParams.get('scenario_id');
            const doctorId = urlParams.get('doctor_id');

            // 加载数据
            useEffect(() => {
                if (!taskId) {
                    setError(t.missingTaskId);
                    setLoading(false);
                    return;
                }

                if (!userId || !scenarioId) {
                    setError(t.missingUserIdOrScenario);
                    setLoading(false);
                    return;
                }

                // 获取端口号，如果没有则使用默认值5001
                const portNumber = window.location.port || (window.location.protocol === 'https:' ? '443' : '5001');
                // 构建API基础URL
                const apiBaseUrl = `${window.location.protocol}//${window.location.hostname}:${portNumber}`;

                const loadData = async () => {
                    try {
                        // 1. 如果有doctor_id（从URL参数或任务信息），获取医生信息
                        let finalDoctorId = doctorId;
                        console.log('🔍 从URL获取的doctor_id:', doctorId);

                        // 如果URL中没有doctor_id，尝试从5003获取任务信息
                        if (!finalDoctorId && taskId) {
                            console.log('⚠️ URL中没有doctor_id，尝试从5003获取任务信息...');
                            try {
                                // 从5003获取任务信息
                                const taskResponse = await fetch(`http://localhost:5003/api/tasks`);
                                if (taskResponse.ok) {
                                    const taskResult = await taskResponse.json();
                                    if (taskResult.success) {
                                        const task = taskResult.tasks.find(t => t.task_id === taskId);
                                        if (task && task.doctor_id) {
                                            finalDoctorId = task.doctor_id;
                                            setTaskInfo(task);
                                        }
                                    }
                                }
                            } catch (err) {
                                console.warn('从5003获取任务信息失败:', err);
                            }
                        }

                        // 获取医生信息（从5003）
                        if (finalDoctorId) {
                            console.log('📞 正在获取医生信息，doctor_id:', finalDoctorId);
                            try {
                                const doctorResponse = await fetch(`http://localhost:5003/openapi/doctor/get`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Token': 'test_key'
                                    },
                                    body: JSON.stringify({ id: finalDoctorId })
                                });
                                if (doctorResponse.ok) {
                                    const doctorResult = await doctorResponse.json();
                                    console.log('📥 医生信息API响应:', doctorResult);
                                    if (doctorResult.success && doctorResult.data && doctorResult.data.length > 0) {
                                        // 5003返回的data是数组格式，取第一个元素
                                        const doctorData = doctorResult.data[0];
                                        setDoctorInfo(doctorData);
                                        console.log('✅ 医生信息已加载:', doctorData);
                                    } else {
                                        console.warn('⚠️ 医生信息格式不正确:', doctorResult);
                                    }
                                } else {
                                    const errorText = await doctorResponse.text();
                                    console.warn('⚠️ 获取医生信息失败，状态码:', doctorResponse.status, '响应:', errorText);
                                }
                            } catch (err) {
                                console.error('❌ 获取医生信息异常:', err);
                            }
                        } else {
                            console.warn('⚠️ 没有doctor_id，无法获取医生信息');
                        }

                        // 2. 获取分诊视图数据
                        const response = await fetch(
                            `${apiBaseUrl}/api/diagnosis-system/triage-view/by-task?task_id=${taskId}&user_id=${encodeURIComponent(userId)}&scenario_id=${encodeURIComponent(scenarioId)}`
                        );

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const result = await response.json();

                        if (!result.success) {
                            throw new Error(result.error || '获取数据失败');
                        }

                        setData(result.data);

                        // 保存triage_id和数据路径
                        const triageId = result.data.triage_id || null;
                        const paths = result.data.data_paths || {};
                        setTriageId(triageId);
                        setDataPaths(paths);

                        // 保存系统原始值
                        if (result.data.triage) {
                            const triage = result.data.triage;
                            const rawNextOp = triage.next_operation || '';
                            const mappedNextOp = mapNextOperation(rawNextOp);  // 使用映射函数

                            const original = {
                                urgency_level: triage.urgency_level || '',
                                next_operation: mappedNextOp,
                                rationale: triage.rationale || '',
                                likely_causes: triage.likely_causes || [],
                                path: triage.path || 'home',
                                esi_level: triage.esi_level || null
                            };
                            setOriginalTriage(original);
                            setDoctorTriage({ ...original });
                        }

                        // 提取对话历史（从API返回的dialogue_messages中）
                        const extractedMessages = result.data.dialogue_messages || [];

                        // 如果没有对话历史，使用signals.summary_text作为备选
                        if (extractedMessages.length === 0 && result.data.signals?.summary_text) {
                            extractedMessages.push({
                                type: 'ai',
                                content: result.data.signals.summary_text,
                                time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
                            });
                        }

                        // 转换为前端需要的格式，保留target_path等定位信息
                        const formattedMessages = extractedMessages.map(msg => ({
                            role: msg.type === 'patient' ? 'patient' : 'ai',
                            text: msg.content || msg.text || '',
                            time: msg.time || '',
                            target_path: msg.target_path || '',  // 保留路径信息
                            turn_index: msg.turn_index,  // 保留turn_index
                            question_id: msg.question_id || msg.symptom_id || '',  // 保留ID
                            question_index: msg.question_index || msg.symptom_index,
                            reason: msg.reason || ''  // AI决策理由
                        }));

                        setDialogueMessages(formattedMessages);
                    } catch (err) {
                        console.error(t.loadTriageViewFailed, err);
                        setError(`${t.loadTriageViewFailed} ${err.message}`);
                    } finally {
                        setLoading(false);
                    }
                };

                loadData();
            }, [taskId]);

            // 批注处理函数
            const handleAnnotationSave = (targetPath, targetId, targetKind, originalValue, modifiedValue, annotationText) => {
                const existing = annotations.find(a => a.target_path === targetPath);
                const annotationType = modifiedValue !== null ? (annotationText ? "both" : "selection") : "annotation";

                const annotation = {
                    target_path: targetPath,
                    target_id: targetId || triageId,
                    target_kind: targetKind || "triage_result",
                    annotation_type: annotationType,
                    original_value: originalValue,
                    modified_value: modifiedValue,
                    annotation_text: annotationText || null,
                    annotated_at: new Date().toISOString()
                };

                setAnnotations(prev => {
                    const filtered = prev.filter(a => a.target_path !== targetPath);
                    return [...filtered, annotation];
                });
            };

            const handleAnnotationDelete = (targetPath) => {
                setAnnotations(prev => prev.filter(a => a.target_path !== targetPath));
            };

            // 提交审核
            const handleSubmit = async () => {
                if (!taskId || !data) {
                    alert('数据未加载完成，请稍候再试');
                    return;
                }

                setSubmitting(true);
                setSubmitMessage(null);

                // 获取端口号，如果没有则使用默认值5001
                const portNumber = window.location.port || (window.location.protocol === 'https:' ? '443' : '5001');
                // 构建API基础URL
                const apiBaseUrl = `${window.location.protocol}//${window.location.hostname}:${portNumber}`;

                try {
                    // 确保所有字段修改都记录到annotations中
                    const finalAnnotations = [...annotations];

                    // 检查triage字段的修改，如果还没有记录到annotations，则添加
                    if (originalTriage) {
                        // urgency_level
                        if (doctorTriage.urgency_level !== originalTriage.urgency_level) {
                            const targetPath = dataPaths.urgency_level || 'bundle.data.triage.output_json.urgency_level';
                            const existing = finalAnnotations.find(a => a.target_path === targetPath);
                            if (!existing) {
                                finalAnnotations.push({
                                    target_path: targetPath,
                                    target_id: triageId,
                                    target_kind: "triage_result",
                                    annotation_type: "selection",
                                    original_value: originalTriage.urgency_level || '',
                                    modified_value: doctorTriage.urgency_level || '',
                                    annotation_text: null,
                                    annotated_at: new Date().toISOString()
                                });
                            } else if (existing.modified_value !== doctorTriage.urgency_level) {
                                // 更新已存在的记录
                                existing.modified_value = doctorTriage.urgency_level;
                                existing.annotation_type = existing.annotation_text ? "both" : "selection";
                            }
                        }

                        // next_operation
                        if (doctorTriage.next_operation !== originalTriage.next_operation) {
                            const targetPath = dataPaths.next_operation || 'bundle.data.triage.output_json.next_operation';
                            const existing = finalAnnotations.find(a => a.target_path === targetPath);
                            if (!existing) {
                                finalAnnotations.push({
                                    target_path: targetPath,
                                    target_id: triageId,
                                    target_kind: "triage_result",
                                    annotation_type: "selection",
                                    original_value: originalTriage.next_operation || '',
                                    modified_value: doctorTriage.next_operation || '',
                                    annotation_text: null,
                                    annotated_at: new Date().toISOString()
                                });
                            } else if (existing.modified_value !== doctorTriage.next_operation) {
                                existing.modified_value = doctorTriage.next_operation;
                                existing.annotation_type = existing.annotation_text ? "both" : "selection";
                            }
                        }

                        // rationale
                        if (doctorTriage.rationale !== originalTriage.rationale) {
                            const targetPath = dataPaths.rationale || 'bundle.data.triage.output_json.rationale';
                            const existing = finalAnnotations.find(a => a.target_path === targetPath);
                            if (!existing) {
                                finalAnnotations.push({
                                    target_path: targetPath,
                                    target_id: triageId,
                                    target_kind: "triage_result",
                                    annotation_type: "selection",
                                    original_value: originalTriage.rationale || '',
                                    modified_value: doctorTriage.rationale || '',
                                    annotation_text: null,
                                    annotated_at: new Date().toISOString()
                                });
                            } else if (existing.modified_value !== doctorTriage.rationale) {
                                existing.modified_value = doctorTriage.rationale;
                                existing.annotation_type = existing.annotation_text ? "both" : "selection";
                            }
                        }

                        // likely_causes
                        const originalCauses = JSON.stringify(originalTriage.likely_causes || []);
                        const revisedCauses = JSON.stringify(doctorTriage.likely_causes || []);
                        if (originalCauses !== revisedCauses) {
                            const targetPath = dataPaths.likely_causes || 'bundle.data.triage.output_json.likely_causes';
                            const existing = finalAnnotations.find(a => a.target_path === targetPath);
                            if (!existing) {
                                finalAnnotations.push({
                                    target_path: targetPath,
                                    target_id: triageId,
                                    target_kind: "triage_result",
                                    annotation_type: "selection",
                                    original_value: originalTriage.likely_causes || [],
                                    modified_value: doctorTriage.likely_causes || [],
                                    annotation_text: null,
                                    annotated_at: new Date().toISOString()
                                });
                            } else if (JSON.stringify(existing.modified_value) !== revisedCauses) {
                                existing.modified_value = doctorTriage.likely_causes || [];
                                existing.annotation_type = existing.annotation_text ? "both" : "selection";
                            }
                        }
                    }

                    // 构建decision对象
                    const decision = {
                        final_path: doctorTriage.path || data.triage?.path || 'home',
                        final_esi_level: doctorTriage.esi_level !== null ? doctorTriage.esi_level : (data.triage?.esi_level || null),
                        urgency_level: doctorTriage.urgency_level || data.triage?.urgency_level || '',
                        next_operation: doctorTriage.next_operation || data.triage?.next_operation || '',
                        doctor_agree_with_system: doctorAgree === 'true',
                        doctor_comment: doctorComment || '无'
                    };

                    const response = await fetch(`${apiBaseUrl}/api/diagnosis-system/triage-review/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            user_id: userId || data.scenario?.user_id || '',  // 优先使用URL参数，否则从已加载的数据中获取
                            scenario_id: scenarioId || data.scenario?.scenario_id || '',  // 优先使用URL参数，否则从已加载的数据中获取
                            decision: decision,
                            modifications: finalAnnotations  // 使用annotations格式，改名为modifications
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        setSubmitMessage({ type: 'success', text: t.submitSuccess });
                        // 禁用表单
                        document.getElementById('doctorComment').disabled = true;
                        document.getElementById('doctorAgree').disabled = true;
                    } else {
                        throw new Error(result.error || t.submitError);
                    }
                } catch (err) {
                    console.error(t.submitReviewFailed, err);
                    setSubmitMessage({ type: 'error', text: `${t.submitError} ${err.message}` });
                } finally {
                    setSubmitting(false);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-slate-50/50">
                        <Header taskId={taskId} doctorInfo={doctorInfo} />
                        <div className="flex items-center justify-center h-[calc(100vh-4rem)]">
                            <div className="text-center">
                                <div className="w-12 h-12 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                                <p className="text-slate-600">{t.loadingTriageData}</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-slate-50/50">
                        <Header taskId={taskId} doctorInfo={doctorInfo} />
                        <div className="flex items-center justify-center h-[calc(100vh-4rem)]">
                            <div className="bg-rose-50 border border-rose-200 rounded-lg p-6 max-w-md">
                                <div className="flex items-center gap-3 mb-2">
                                    <AlertCircle size={20} className="text-rose-600" />
                                    <h3 className="font-bold text-rose-800">加载失败</h3>
                                </div>
                                <p className="text-rose-700">{error}</p>
                            </div>
                        </div>
                    </div>
                );
            }

            const triage = data.triage || {};
            const patient = data.patient || {};
            const signals = data.signals || {};
            const suggestions = data.suggestions || {};

            const urgencyLevel = triage.urgency_level || '';
            const esiLevel = triage.esi_level;
            const path = triage.path || 'home';
            const isUrgent = path === 'immediate' || (esiLevel !== null && esiLevel <= 3);

            const demographics = patient.demographics || {};
            // 优先使用 signals.vital_signs（包含触发时刻值、范围、基线值），回退到 baseline_vitals
            const vitals = signals?.vital_signs || patient.baseline_vitals || {};

            // 获取紧急徽章颜色
            const getUrgencyBadgeClass = (level) => {
                const l = (level || '').toLowerCase();
                if (l.includes('紧急') || l.includes('urgent') || l.includes('emergent')) {
                    return 'bg-rose-600';
                } else if (l.includes('关注')) {
                    return 'bg-amber-500';
                } else {
                    return 'bg-emerald-600';
                }
            };

            // 提取患者建议内容
            const getPatientRecommendations = () => {
                const recs = [];
                const patientSuggestions = suggestions.patient || [];
                patientSuggestions.forEach(suggestion => {
                    const outputJson = suggestion.output_json || '';
                    if (Array.isArray(outputJson)) {
                        outputJson.forEach(item => {
                            if (item.advice && Array.isArray(item.advice)) {
                                item.advice.forEach(advice => {
                                    recs.push(advice);
                                });
                            }
                        });
                    } else if (typeof outputJson === 'string') {
                        recs.push(outputJson);
                    }
                });
                return recs;
            };

            // 兼容旧名称
            const getRecommendations = getPatientRecommendations;

            // 提取医生建议内容
            const getDoctorRecommendations = () => {
                const recs = [];
                const doctorSuggestions = suggestions.doctor || [];
                doctorSuggestions.forEach(suggestion => {
                    const outputJson = suggestion.output_json || '';
                    if (Array.isArray(outputJson)) {
                        outputJson.forEach(item => {
                            if (item.advice && Array.isArray(item.advice)) {
                                item.advice.forEach(advice => {
                                    recs.push(advice);
                                });
                            }
                        });
                    } else if (typeof outputJson === 'string') {
                        recs.push(outputJson);
                    }
                });
                return recs;
            };

            // 获取紧急程度文本
            const getUrgencyLevelText = () => {
                const currentLang = getLanguage();
                const t = LANGUAGE_CONFIG[currentLang];
                if (esiLevel !== null && esiLevel !== undefined) {
                    if (esiLevel <= 2) return t.urgencyLevels.critical;
                    if (esiLevel === 3) return t.urgencyLevels.urgent;
                    if (esiLevel === 4) return t.urgencyLevels.subUrgent;
                    return t.urgencyLevels.nonUrgent;
                }
                if (urgencyLevel) {
                    return urgencyLevel;
                }
                return t.urgencyLevels.normal;
            };

            const recommendations = getRecommendations();
            const doctorRecommendations = getDoctorRecommendations();

            // 格式化血压显示
            const formatBloodPressure = (bp) => {
                if (typeof bp === 'object' && bp !== null) {
                    const systolic = bp['收缩压'] || bp['systolic'] || bp['收缩'];
                    const diastolic = bp['舒张压'] || bp['diastolic'] || bp['舒张'];
                    if (systolic && diastolic) {
                        return `${systolic}/${diastolic}`;
                    }
                }
                return bp;
            };

            // ===== 触发方式映射 =====
            const TRIGGER_TYPE_MAP = {
                'model_inquiry': { label: '模型触发', icon: '🤖', color: 'blue' },
                'user_report': { label: '用户主动触发', icon: '👤', color: 'green' },
                'unknown': { label: '未知', icon: '❓', color: 'gray' }
            };

            // ===== 智能匹配规则系统 =====
            const VITAL_SIGN_MATCHING_RULES = {
                blood_pressure: {
                    keywords: [
                        /\bblood\s*pressure\b/i,
                        /\b(systolic|diastolic)\s*pressure\b/i,
                        /\bbp\b/i,
                        /\b[\d]+\s*\/\s*[\d]+\s*mmhg/i,
                        /血压/i,
                        /收缩压/i,
                        /舒张压/i,
                        /高压|低压/i
                    ],
                    extractValue: (detectionSummary, overallSummary) => {
                        const bp = detectionSummary?.血压 || detectionSummary?.blood_pressure;
                        if (bp) {
                            const sbp = bp.收缩压 || bp.systolic || bp.收缩;
                            const dbp = bp.舒张压 || bp.diastolic || bp.舒张;
                            if (sbp && dbp) {
                                const sbpVal = sbp.mean || sbp;
                                const dbpVal = dbp.mean || dbp;
                                if (sbpVal && dbpVal) return `${Math.round(sbpVal)}/${Math.round(dbpVal)} mmHg`;
                            }
                        }
                        const bpOverall = overallSummary?.血压 || overallSummary?.blood_pressure;
                        if (bpOverall) {
                            const sbp = bpOverall.收缩压 || bpOverall.systolic;
                            const dbp = bpOverall.舒张压 || bpOverall.diastolic;
                            if (sbp && dbp) {
                                const sbpVal = sbp.mean || sbp;
                                const dbpVal = dbp.mean || dbp;
                                if (sbpVal && dbpVal) return `${Math.round(sbpVal)}/${Math.round(dbpVal)} mmHg`;
                            }
                        }
                        return null;
                    },
                    formatAnomaly: (value) => `${value} ↓`
                },
                heart_rate: {
                    keywords: [
                        /\bheart\s*rate\b/i,
                        /\bhr\b/i,
                        /\bheartbeat\b/i,
                        /\bpulse\s*rate\b/i,
                        /心率/i,
                        /心跳/i,
                        /脉搏/i
                    ],
                    extractValue: (detectionSummary, overallSummary) => {
                        const hr = detectionSummary?.心率 || detectionSummary?.heart_rate || detectionSummary?.hr;
                        if (hr) {
                            const mean = hr.mean || hr;
                            const unit = hr.unit || 'bpm';
                            if (mean) return `${Math.round(mean)} ${unit}`;
                        }
                        const hrOverall = overallSummary?.心率 || overallSummary?.heart_rate;
                        if (hrOverall) {
                            const mean = hrOverall.mean || hrOverall;
                            const unit = hrOverall.unit || 'bpm';
                            if (mean) return `${Math.round(mean)} ${unit}`;
                        }
                        return null;
                    },
                    formatAnomaly: (value) => `${value} ↓`
                }
            };

            // ===== 智能匹配函数：从 rationale 提取相关异常数值 =====
            const extractVitalSignFromRationale = (rationale, anomalies, detectionSummary, overallSummary) => {
                if (!rationale) return [];
                
                const matchedVitals = [];
                const rationaleLower = rationale.toLowerCase();
                
                for (const [vitalType, rule] of Object.entries(VITAL_SIGN_MATCHING_RULES)) {
                    const hasKeyword = rule.keywords.some(keyword => keyword.test(rationale));
                    
                    if (hasKeyword) {
                        const value = rule.extractValue(detectionSummary, overallSummary);
                        if (value) {
                            const anomaly = anomalies.find(a => {
                                const aLower = (a || '').toLowerCase();
                                return (
                                    (vitalType === 'blood_pressure' && (aLower.includes('blood') || aLower.includes('血压') || aLower.includes('pressure'))) ||
                                    (vitalType === 'heart_rate' && (aLower.includes('heart') || aLower.includes('心率') || aLower.includes('心跳')))
                                );
                            }) || (vitalType === 'blood_pressure' ? 'Blood Pressure Decrease' : 'Heart Rate Decrease');
                            
                            matchedVitals.push({
                                type: vitalType,
                                anomaly: anomaly,
                                value: rule.formatAnomaly(value),
                                priority: vitalType === 'blood_pressure' ? 1 : 2
                            });
                        }
                    }
                }
                
                return matchedVitals.sort((a, b) => a.priority - b.priority);
            };

            // ===== 提取 anomalies 和 detection_summary/overall_summary =====
            const firstSignal = signals?.data?.[0] || signals?.signals?.[0] || {};
            const metricsJson = firstSignal?.metrics_json || {};
            const anomalies = metricsJson?.anomalies || [];
            const detectionSummary = metricsJson?.detection_summary || {};
            const overallSummary = metricsJson?.overall_summary || {};
            
            // 提取患者反馈
            const patientFeedback = dialogueMessages?.find(m => m.role === 'patient' || m.type === 'patient')?.text || 
                                   dialogueMessages?.find(m => m.role === 'patient' || m.type === 'patient')?.content || 
                                   data?.symptoms?.patient_feedback?.[0]?.text ||
                                   data?.symptoms?.patient_feedback?.[0]?.symptom_name ||
                                   'No obvious symptoms';

            // 提取触发方式
            const triggerType = data?.scenario?.trigger_type || context?.trigger_type || 'unknown';
            const triggerInfo = TRIGGER_TYPE_MAP[triggerType] || TRIGGER_TYPE_MAP['unknown'];

            // 智能匹配异常数值
            const matchedVitals = extractVitalSignFromRationale(
                triage.rationale || '',
                anomalies,
                detectionSummary,
                overallSummary
            );

            // 获取患者姓名（可能在不同字段）
            // 注意：currentLang 和 t 已经在函数开始处声明，这里直接使用
            const patientName = demographics['姓名'] || demographics['name'] || demographics['患者姓名'] || t.patient;
            const patientAge = demographics['年龄'] || demographics['age'];
            const patientSexRaw = demographics['性别'] || demographics['sex'];
            // 将性别转换为多语言显示
            let patientSex = patientSexRaw;
            if (patientSexRaw === '男' || patientSexRaw === 'male' || patientSexRaw === 'Male' || patientSexRaw === 'M') {
                patientSex = t.male;
            } else if (patientSexRaw === '女' || patientSexRaw === 'female' || patientSexRaw === 'Female' || patientSexRaw === 'F') {
                patientSex = t.female;
            }

            // 使用从API提取的对话历史
            const chatHistory = dialogueMessages;

            // 提取过敏信息（支持多种数据格式）
            const getAllergyInfo = () => {
                // 尝试从多个可能的位置提取过敏信息
                const allergyHistory = patient.allergy_history ||
                    data.patient?.allergy_history ||
                    data.patient?.ehr?.allergy_history ||
                    patient.ehr?.allergy_history;

                if (!allergyHistory) return null;

                const allergyList = [];

                // 如果是对象格式（包含药物、食物、环境等）
                if (typeof allergyHistory === 'object' && !Array.isArray(allergyHistory)) {
                    if (allergyHistory['药物'] && Array.isArray(allergyHistory['药物']) && allergyHistory['药物'].length > 0) {
                        allergyList.push(...allergyHistory['药物']);
                    }
                    if (allergyHistory['食物'] && Array.isArray(allergyHistory['食物']) && allergyHistory['食物'].length > 0) {
                        allergyList.push(...allergyHistory['食物']);
                    }
                    if (allergyHistory['环境'] && Array.isArray(allergyHistory['环境']) && allergyHistory['环境'].length > 0) {
                        allergyList.push(...allergyHistory['环境']);
                    }
                    if (allergyHistory['其他'] && Array.isArray(allergyHistory['其他']) && allergyHistory['其他'].length > 0) {
                        allergyList.push(...allergyHistory['其他']);
                    }
                } else if (Array.isArray(allergyHistory)) {
                    // 如果是数组格式，直接使用
                    allergyList.push(...allergyHistory);
                }

                return allergyList.length > 0 ? allergyList : null;
            };

            const allergyList = getAllergyInfo();

            return (
                <div className="min-h-screen bg-slate-50/50 font-sans text-slate-800">
                    <Header taskId={taskId} viewMode={viewMode} onViewModeChange={setViewMode} doctorInfo={doctorInfo} />

                    <main className={`max-w-[1600px] mx-auto p-4 ${viewMode === 'full' ? 'min-h-[calc(100vh-4rem)]' : 'h-[calc(100vh-4rem)]'}`}>
                        {viewMode === 'full' ? (
                            // 完整模式 - 可滚动
                            <div className="flex flex-col lg:flex-row gap-4">
                                {/* --- 左侧主要区域 (占宽) --- */}
                                <div className={`flex flex-col min-w-0 gap-3 transition-all duration-300 ${sidebarCollapsed ? 'flex-1' : 'flex-1'
                                    }`}>

                                    {/* 1. 患者信息头 */}
                                    <div className="bg-white px-4 py-3 rounded-xl border border-slate-200 shadow-sm shrink-0 flex flex-col xl:flex-row justify-between xl:items-center gap-4">
                                        <div className="flex items-start gap-3">
                                            <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 border-2 border-slate-50 shadow-inner shrink-0">
                                                <User size={24} />
                                            </div>
                                            <div className="min-w-0">
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <h2 className="text-xl font-bold text-slate-900">{patientName}</h2>
                                                    <div className="flex items-center gap-1.5 text-xs">
                                                        {patientSex && (
                                                            <span className="px-1.5 py-0.5 bg-slate-100 rounded font-semibold text-slate-600">{patientSex}</span>
                                                        )}
                                                        {patientAge && (
                                                            <span className="px-1.5 py-0.5 bg-slate-100 rounded font-semibold text-slate-600">{patientAge} {t.yearsOld}</span>
                                                        )}
                                                    </div>
                                                    {esiLevel !== null && esiLevel !== undefined && (
                                                        <span className="px-1.5 py-0.5 bg-slate-100 rounded text-slate-600 font-mono text-xs">
                                                            ESI {esiLevel}
                                                        </span>
                                                    )}
                                                </div>
                                                {/* 病史信息 */}
                                                <div className="mt-2 pt-2 border-t border-slate-100">
                                                    <div className="text-[10px] font-semibold text-slate-400 uppercase tracking-wider mb-1">{t.medicalHistory}</div>
                                                    <div className="text-xs text-slate-600 space-y-0.5">
                                                        {patient.medical_history && (patient.medical_history.diagnoses_str || (patient.medical_history.diagnoses && patient.medical_history.diagnoses.length > 0)) ? (
                                                            <div>
                                                                <span className="font-medium">{t.diseases}</span>
                                                                <span>{patient.medical_history.diagnoses_str || patient.medical_history.diagnoses.join('、')}</span>
                                                            </div>
                                                        ) : (
                                                            <div>
                                                                <span className="font-medium">{t.diseases}</span>
                                                                <span>无</span>
                                                            </div>
                                                        )}
                                                        {patient.meds && patient.meds.length > 0 && (
                                                            <div>
                                                                <span className="font-medium">{t.currentMedications}</span>
                                                                <span>{patient.meds.join('、')}</span>
                                                            </div>
                                                        )}
                                                        {allergyList && allergyList.length > 0 && (
                                                            <div>
                                                                <span className="font-medium">{t.allergies}</span>
                                                                <span>{allergyList.join('、')}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="w-full max-w-md">
                                            <VitalSignsTable vitals={vitals} signals={signals} isUrgent={isUrgent} />
                                        </div>
                                    </div>

                                    {/* 1.5 触发上下文信息 (Full Mode) */}
                                    <TriggerInfoBlock data={data} t={t} fullMode={true} />

                                    {/* 2. Signal 检测可视化 */}
                                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm group">
                                        <div className="px-4 py-2.5 border-b border-slate-100 flex justify-between items-center bg-slate-50/30">
                                            <div className="flex items-center gap-2">
                                                <div className="bg-emerald-100 p-1 rounded text-emerald-600"><TrendingUp size={16} /></div>
                                                <h3 className="font-bold text-slate-800 text-sm">{t.signalDetectionVisualization}</h3>
                                            </div>
                                        </div>

                                        {/* Tab 切换 */}
                                        <div className="border-b border-slate-200">
                                            <div className="flex">
                                                <button
                                                    className={`px-4 py-2 text-xs font-semibold transition-colors ${signalTab === 'event'
                                                        ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50'
                                                        : 'text-slate-500 hover:text-slate-700'
                                                        }`}
                                                    onClick={() => setSignalTab('event')}
                                                >
                                                    {t.eventDetails}
                                                </button>
                                                <button
                                                    className={`px-4 py-2 text-xs font-semibold transition-colors ${signalTab === 'trend'
                                                        ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50'
                                                        : 'text-slate-500 hover:text-slate-700'
                                                        }`}
                                                    onClick={() => setSignalTab('trend')}
                                                >
                                                    {t.longTermTrend}
                                                </button>
                                            </div>
                                        </div>

                                        {/* Tab 内容 */}
                                        <div className="p-4">
                                            {signalTab === 'event' ? (
                                                <RawSignalVisualization
                                                    rawSignals={data?.raw_signals}
                                                    data={data}
                                                    viewMode={viewMode}
                                                />
                                            ) : (
                                                <SignalVisualization
                                                    signals={signals}
                                                    data={data}
                                                    viewMode={viewMode}
                                                />
                                            )}
                                        </div>
                                        <div className="px-4 pb-4">
                                            <AnnotationInput
                                                targetPath={dataPaths.signals_summary}
                                                targetId={triageId}
                                                targetKind="signal"
                                                originalValue={signals.summary_text || ''}
                                                existingAnnotation={annotations.find(a => a.target_path === dataPaths.signals_summary)}
                                                onSave={(text) => handleAnnotationSave(dataPaths.signals_summary, triageId, "signal", signals.summary_text || '', null, text)}
                                                onDelete={() => handleAnnotationDelete(dataPaths.signals_summary)}
                                            />
                                        </div>
                                    </div>

                                    {/* 3. AI 临床分析报告 */}
                                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col">
                                        <div className="px-4 py-2.5 border-b border-slate-100 flex justify-between items-center bg-slate-50/30">
                                            <div className="flex items-center gap-2">
                                                <div className="bg-blue-100 p-1 rounded text-blue-600"><FileText size={16} /></div>
                                                <h3 className="font-bold text-slate-800 text-sm">{t.aiClinicalAnalysisReport}</h3>
                                            </div>
                                            <span className="text-[10px] font-mono text-slate-400">{new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
                                        </div>

                                        <div className="p-4 space-y-4">
                                            
                                            {/* TRIGGERING BASIS */}
                                            <div>
                                                <div className="flex items-center gap-2 mb-2">
                                                    <label className="text-xs font-bold text-slate-700 uppercase tracking-wider">&gt; TRIGGERING BASIS (原 Anomaly Info)</label>
                                                    {triggerInfo && (
                                                        <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${
                                                            triggerInfo.color === 'blue' ? 'bg-blue-100 text-blue-700' :
                                                            triggerInfo.color === 'green' ? 'bg-green-100 text-green-700' :
                                                            'bg-gray-100 text-gray-700'
                                                        }`}>
                                                            {triggerInfo.icon} {triggerInfo.label}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="p-3 bg-amber-50 rounded-lg border-l-4 border-amber-400">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <AlertCircle size={14} className="text-amber-600" />
                                                        <span className="text-xs font-semibold text-amber-800">系统检测到：</span>
                                                    </div>
                                                    {matchedVitals.length > 0 ? (
                                                        <div className="space-y-1.5">
                                                            {matchedVitals.map((vital, idx) => (
                                                                <div key={idx} className="flex items-center gap-2">
                                                                    <span className="text-slate-600">●</span>
                                                                    <span className="text-xs font-medium text-slate-700">{vital.anomaly}</span>
                                                                    <span className="px-2 py-0.5 bg-rose-100 text-rose-700 rounded text-[10px] font-bold">{vital.value}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className="text-xs text-slate-600">暂无异常数据</div>
                                                    )}
                                                    <div className="mt-3 pt-2 border-t border-amber-200">
                                                        <span className="text-xs font-medium text-slate-700">患者反馈: </span>
                                                        <span className="text-xs text-slate-600 italic">"{patientFeedback}"</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* CHIEF COMPLAINT SUMMARY */}
                                            <div>
                                                <label className="text-xs font-bold text-slate-700 uppercase tracking-wider mb-2 block">
                                                    CHIEF COMPLAINT SUMMARY (基于上述异常推断的症状)
                                                </label>
                                                <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                                    {data?.symptoms?.system_identified && data.symptoms.system_identified.length > 0 ? (
                                                        <div className="flex flex-wrap gap-2">
                                                            {data.symptoms.system_identified.map((symptom, idx) => (
                                                                <span
                                                                    key={idx}
                                                                    className="px-2.5 py-1 bg-blue-100 border border-blue-200 text-blue-700 text-xs rounded-md font-medium"
                                                                >
                                                                    [{symptom}]
                                                                </span>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <span className="text-xs text-slate-400">暂无症状标签</span>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Likely Causes 和 Rationale 并排显示 */}
                                            <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                                                {/* 左列: Likely Causes */}
                                                <div className="bg-slate-50 rounded-lg border border-slate-200 p-3">
                                                    <label className="text-xs font-bold text-slate-700 uppercase tracking-wider mb-2 block">
                                                        Likely Causes (疑似病因)
                                                    </label>
                                                    {triage.likely_causes && triage.likely_causes.length > 0 ? (
                                                        <div className="space-y-1.5">
                                                            {triage.likely_causes.map((cause, idx) => (
                                                                <div key={idx} className="flex items-start gap-1.5 pb-1.5 border-b border-slate-200 last:border-0">
                                                                    <span className="text-slate-600 mt-0.5">●</span>
                                                                    <span className="text-xs text-slate-700">{cause}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <p className="text-xs text-slate-400">暂无可能病因</p>
                                                    )}
                                                </div>

                                                {/* 右列: Rationale */}
                                                <div className="bg-slate-50 rounded-lg border border-slate-200 p-3">
                                                    <label className="text-xs font-bold text-slate-700 uppercase tracking-wider mb-2 block">
                                                        Rationale (诊断逻辑)
                                                    </label>
                                                    <div className="text-xs text-slate-700 leading-relaxed">
                                                        {triage.rationale || t.noRationale}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* TRIAGE RECOMMENDATION 独立显示 */}
                                            <div>
                                                <label className="text-xs font-bold text-slate-700 uppercase tracking-wider mb-2 block">
                                                    TRIAGE RECOMMENDATION
                                                </label>
                                                <div className="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                                                    <div className="space-y-3">
                                                        <div className="flex flex-wrap items-center gap-4">
                                                            <div>
                                                                <strong className="text-xs font-semibold text-emerald-800 mr-2">Urgency:</strong>
                                                                <select
                                                                    value={doctorTriage.urgency_level !== undefined && doctorTriage.urgency_level !== null ? doctorTriage.urgency_level : (originalTriage?.urgency_level || '')}
                                                                    onChange={(e) => {
                                                                        const newValue = e.target.value;
                                                                        setDoctorTriage({ ...doctorTriage, urgency_level: newValue });
                                                                        if (newValue !== originalTriage?.urgency_level) {
                                                                            handleAnnotationSave(dataPaths.urgency_level, triageId, "triage_result", originalTriage?.urgency_level || '', newValue, null);
                                                                        } else {
                                                                            handleAnnotationDelete(dataPaths.urgency_level);
                                                                        }
                                                                    }}
                                                                    className="px-2.5 py-1 bg-emerald-200 text-emerald-800 rounded text-xs font-bold border border-emerald-300 focus:outline-none focus:ring-1 focus:ring-emerald-400"
                                                                >
                                                                    {!originalTriage?.urgency_level && <option value="">{t.urgencyPlaceholder}</option>}
                                                                    {Object.entries(t.urgencyOptions).map(([value, label]) => (
                                                                        <option key={value} value={value}>{label}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <strong className="text-xs font-semibold text-emerald-800 mr-2">Action:</strong>
                                                                <select
                                                                    value={doctorTriage.next_operation || ''}
                                                                    onChange={(e) => {
                                                                        const newValue = e.target.value;
                                                                        setDoctorTriage({ ...doctorTriage, next_operation: newValue });
                                                                        if (newValue !== originalTriage?.next_operation) {
                                                                            handleAnnotationSave(dataPaths.next_operation, triageId, "triage_result", originalTriage?.next_operation || '', newValue, null);
                                                                        } else {
                                                                            handleAnnotationDelete(dataPaths.next_operation);
                                                                        }
                                                                    }}
                                                                    className="px-2.5 py-1 bg-emerald-200 text-emerald-800 rounded text-xs font-bold border border-emerald-300 focus:outline-none focus:ring-1 focus:ring-emerald-400"
                                                                >
                                                                    <option value="">{t.nextOperationPlaceholder}</option>
                                                                    {Object.entries(t.nextOperationOptions).map(([value, label]) => (
                                                                        <option key={value} value={value}>{label}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                                    <AITaskBlock
                                                        title={t.patientRecommendations}
                                                        targetPath={dataPaths.patient_recommendations || "bundle.data.suggestions.patient"}
                                                        targetId={triageId}
                                                        targetKind="triage_result"
                                                        originalValue={recommendations.join('; ')}
                                                        annotations={annotations}
                                                        onAnnotationSave={handleAnnotationSave}
                                                        onAnnotationDelete={handleAnnotationDelete}
                                                    >
                                                        {recommendations.length > 0 ? (
                                                            <div>
                                                                <div className="text-xs font-medium text-slate-600 mb-1">{t.recommendedAction}</div>
                                                                <ol className="list-decimal list-inside space-y-1 marker:text-slate-400 marker:font-medium">
                                                                    {recommendations.map((rec, idx) => (
                                                                        <li key={idx} className="pl-0.5 text-xs">{rec}</li>
                                                                    ))}
                                                                </ol>
                                                            </div>
                                                        ) : (
                                                            <p className="text-slate-400 text-xs">{t.noPatientRecommendations}</p>
                                                        )}
                                                    </AITaskBlock>

                                                    {/* 医生建议（始终显示） */}
                                                    <AITaskBlock
                                                        title={t.doctorRecommendations}
                                                        targetPath={dataPaths.doctor_recommendations || "bundle.data.suggestions.doctor"}
                                                        targetId={triageId}
                                                        targetKind="triage_result"
                                                        originalValue={doctorRecommendations.join('; ')}
                                                        annotations={annotations}
                                                        onAnnotationSave={handleAnnotationSave}
                                                        onAnnotationDelete={handleAnnotationDelete}
                                                    >
                                                        {doctorRecommendations.length > 0 ? (
                                                            <div>
                                                                <div className="text-xs font-medium text-slate-600 mb-1">{t.recommendedAction}</div>
                                                                <ol className="list-decimal list-inside space-y-1 marker:text-slate-400 marker:font-medium">
                                                                    {doctorRecommendations.map((rec, idx) => (
                                                                        <li key={idx} className="pl-0.5 text-xs">{rec}</li>
                                                                    ))}
                                                                </ol>
                                                            </div>
                                                        ) : (
                                                            <p className="text-slate-400 text-xs">{t.noDoctorRecommendations}</p>
                                                        )}
                                                    </AITaskBlock>
                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                    {/* 4. 医生审核区域 */}
                                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col">
                                        {/* 审核表单 */}
                                        <div className="px-4 py-3 border-t border-slate-100 bg-white">
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-xs font-semibold text-slate-700 mb-1.5">
                                                        {t.reviewComment}
                                                    </label>
                                                    <textarea
                                                        id="doctorComment"
                                                        value={doctorComment}
                                                        onChange={(e) => setDoctorComment(e.target.value)}
                                                        placeholder={t.reviewCommentPlaceholder}
                                                        className="w-full min-h-[60px] p-2.5 border-2 border-slate-200 rounded-lg text-xs font-sans resize-y focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100"
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-xs font-semibold text-slate-700 mb-1.5">
                                                        {t.agreeWithTriage}
                                                    </label>
                                                    <select
                                                        id="doctorAgree"
                                                        value={doctorAgree}
                                                        onChange={(e) => setDoctorAgree(e.target.value)}
                                                        className="w-full p-2.5 border-2 border-slate-200 rounded-lg text-xs focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100"
                                                    >
                                                        <option value="true">{t.agree}</option>
                                                        <option value="false">{t.disagree}</option>
                                                    </select>
                                                </div>

                                                {submitMessage && (
                                                    <div className={`p-2 rounded-lg text-xs ${submitMessage.type === 'success'
                                                        ? 'bg-emerald-50 text-emerald-800 border border-emerald-200'
                                                        : 'bg-rose-50 text-rose-800 border border-rose-200'
                                                        }`}>
                                                        {submitMessage.text}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* 底部提交栏 */}
                                        <div className="p-3 border-t border-slate-100 bg-slate-50 flex items-center justify-between shrink-0">
                                            <div className="flex items-center gap-2 pl-1">
                                                <div className="p-1.5 bg-white rounded-full border border-slate-200 text-slate-400">
                                                    <Stethoscope size={16} />
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">{t.headerReviewer}</span>
                                                    <span className="text-xs font-bold text-slate-800 font-handwriting italic">
                                                        {doctorInfo?.name ? `${doctorInfo.name} (${doctorInfo.occupation || ''})` : 'Dr. Reviewer'} / {new Date().toLocaleDateString(t.dateLocale, t.dateFormat)}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        setDoctorComment('');
                                                        setDoctorAgree('true');
                                                    }}
                                                    className="px-4 py-1.5 bg-white border border-slate-300 text-slate-600 rounded-lg shadow-sm hover:bg-slate-50 hover:text-slate-800 text-xs font-medium transition-all"
                                                >
                                                    {t.reset}
                                                </button>
                                                <button
                                                    onClick={handleSubmit}
                                                    disabled={submitting}
                                                    className="px-4 py-1.5 bg-slate-900 text-white rounded-lg shadow-lg shadow-slate-900/20 hover:bg-slate-800 hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-1.5 text-xs font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    {submitting ? (
                                                        <>
                                                            <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                            <span>{t.submitting}</span>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <CheckCircle2 size={14} />
                                                            <span>{t.confirmSubmit}</span>
                                                        </>
                                                    )}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* --- 右侧：对话记录 (可折叠) --- */}
                                {!sidebarCollapsed && (
                                    <div className="w-[380px] shrink-0 flex flex-col bg-white border border-slate-200 rounded-2xl shadow-sm max-h-[calc(100vh-8rem)] overflow-hidden transition-all duration-300 ease-in-out animate-in slide-in-from-right">
                                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                            <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                                <MessageSquare size={18} className="text-blue-600" />
                                                {t.dialogueHistory}
                                            </h3>
                                            <div className="flex gap-1">
                                                <button
                                                    onClick={() => setSidebarCollapsed(true)}
                                                    className="p-1.5 hover:bg-slate-100 rounded text-slate-400 transition-colors"
                                                    title="折叠侧边栏"
                                                >
                                                    <Maximize2 size={14} />
                                                </button>
                                            </div>
                                        </div>

                                        <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-white custom-scrollbar">
                                            {chatHistory.length > 0 ? (
                                                chatHistory.map((msg, idx) => {
                                                    const messageText = msg.text || msg.content || '';
                                                    const messageRole = msg.role || (msg.type === 'patient' ? 'patient' : 'ai');
                                                    const messageTime = msg.time || '';
                                                    const targetPath = msg.target_path || '';

                                                    // 查找该消息的批注
                                                    const messageAnnotation = annotations?.find(a => a.target_path === targetPath);
                                                    const isEditing = editingAnnotations[targetPath] || false;
                                                    const inputText = annotationInputs[targetPath] || (messageAnnotation?.annotation_text || messageAnnotation?.comment || '');

                                                    const handleStartEdit = () => {
                                                        setEditingAnnotations(prev => ({ ...prev, [targetPath]: true }));
                                                        setAnnotationInputs(prev => ({ ...prev, [targetPath]: messageAnnotation?.annotation_text || messageAnnotation?.comment || '' }));
                                                    };

                                                    const handleSaveAnnotation = () => {
                                                        const text = inputText.trim();
                                                        if (text) {
                                                            const newAnnotation = {
                                                                target_path: targetPath,
                                                                target_id: msg.question_id || triageId || '',
                                                                target_kind: "question_step",
                                                                annotation_type: "annotation",
                                                                original_value: messageText,
                                                                modified_value: null,
                                                                annotation_text: text,
                                                                annotated_at: new Date().toISOString()
                                                            };
                                                            setAnnotations(prev => {
                                                                const updated = [...(prev || [])];
                                                                const existingIndex = updated.findIndex(a => a.target_path === targetPath);
                                                                if (existingIndex >= 0) {
                                                                    updated[existingIndex] = newAnnotation;
                                                                } else {
                                                                    updated.push(newAnnotation);
                                                                }
                                                                return updated;
                                                            });
                                                        }
                                                        setEditingAnnotations(prev => ({ ...prev, [targetPath]: false }));
                                                    };

                                                    const handleCancelEdit = () => {
                                                        setEditingAnnotations(prev => ({ ...prev, [targetPath]: false }));
                                                        setAnnotationInputs(prev => ({ ...prev, [targetPath]: messageAnnotation?.annotation_text || messageAnnotation?.comment || '' }));
                                                    };

                                                    const handleDeleteAnnotation = () => {
                                                        setAnnotations(prev => prev.filter(a => a.target_path !== targetPath));
                                                        setEditingAnnotations(prev => ({ ...prev, [targetPath]: false }));
                                                        setAnnotationInputs(prev => {
                                                            const newInputs = { ...prev };
                                                            delete newInputs[targetPath];
                                                            return newInputs;
                                                        });
                                                    };

                                                    return (
                                                        <div key={idx} className={`flex flex-col ${messageRole === 'ai' ? 'items-start' : 'items-end'} group relative`}>
                                                            <div className={`flex items-end gap-2 max-w-[92%] ${messageRole === 'patient' ? 'flex-row-reverse' : ''}`}>
                                                                <div className={`w-7 h-7 rounded-full flex items-center justify-center shrink-0 text-[10px] font-bold border shadow-sm ${messageRole === 'ai'
                                                                    ? 'bg-white text-blue-600 border-blue-100'
                                                                    : 'bg-slate-800 text-white border-slate-800'
                                                                    }`}>
                                                                    {messageRole === 'ai' ? 'AI' : t.patientIcon}
                                                                </div>
                                                                <div className={`px-3.5 py-2.5 rounded-2xl text-sm leading-relaxed whitespace-pre-line relative group/message ${messageRole === 'ai'
                                                                    ? 'bg-slate-50 text-slate-700 border border-slate-100 rounded-bl-none'
                                                                    : 'bg-blue-600 text-white shadow-md shadow-blue-600/10 rounded-br-none'
                                                                    }`}>
                                                                    {formatMessageText(messageText)}
                                                                    {/* AI Reasoning 图标 - 仅在AI消息且有reason时显示 */}
                                                                    {messageRole === 'ai' && msg.reason && (
                                                                        <button
                                                                            onClick={() => setExpandedReason(prev => prev === idx ? null : idx)}
                                                                            className={`absolute -top-2 right-2 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-md transition-colors ${expandedReason === idx
                                                                                ? 'bg-amber-600 text-white'
                                                                                : 'bg-amber-400 text-white hover:bg-amber-500'
                                                                                }`}
                                                                            title={expandedReason === idx ? "Hide AI Reasoning" : "View AI Reasoning"}
                                                                        >
                                                                            💡
                                                                        </button>
                                                                    )}
                                                                    {/* 批注按钮 - 鼠标悬停时显示 */}
                                                                    {targetPath && !messageAnnotation && !isEditing && (
                                                                        <button
                                                                            onClick={handleStartEdit}
                                                                            className={`absolute -top-1 ${msg.reason ? '-right-7' : '-right-1'} w-5 h-5 bg-blue-600 text-white rounded-full flex items-center justify-center text-[10px] opacity-0 group-hover/message:opacity-100 transition-opacity shadow-md hover:bg-blue-700`}
                                                                            title={t.addAnnotationTitle}
                                                                        >
                                                                            <MessageSquare size={12} />
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            {/* AI Reasoning 展开区域 */}
                                                            {messageRole === 'ai' && msg.reason && expandedReason === idx && (
                                                                <div className="mt-2 ml-9 max-w-[85%] p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs animate-fadeIn">
                                                                    <div className="text-[10px] font-semibold text-amber-700 mb-1.5 flex items-center gap-1">
                                                                        <span>💡</span> AI Reasoning
                                                                    </div>
                                                                    <div className="text-xs text-amber-900 leading-relaxed">{msg.reason}</div>
                                                                </div>
                                                            )}
                                                            {/* 批注编辑/显示区域 - 使用与AnnotationInput相同的格式 */}
                                                            {(isEditing || messageAnnotation) && (
                                                                <div className={`mt-2 max-w-[92%] ${messageRole === 'ai' ? 'ml-9' : 'mr-9'}`}>
                                                                    {isEditing ? (
                                                                        <div className="p-2 bg-slate-50 border border-slate-200 rounded text-xs">
                                                                            <textarea
                                                                                value={inputText}
                                                                                onChange={(e) => setAnnotationInputs(prev => ({ ...prev, [targetPath]: e.target.value }))}
                                                                                className="w-full text-xs p-2 bg-white border border-slate-200 rounded shadow-sm focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-100"
                                                                                rows="2"
                                                                                placeholder={t.inputAnnotation}
                                                                                autoFocus
                                                                            />
                                                                            <div className="flex justify-end mt-2 gap-2">
                                                                                <button onClick={handleCancelEdit} className="text-xs px-2 py-1 text-slate-500 hover:text-slate-700">取消</button>
                                                                                {messageAnnotation && (
                                                                                    <button onClick={handleDeleteAnnotation} className="text-xs px-2 py-1 text-red-600 hover:text-red-700">删除</button>
                                                                                )}
                                                                                <button onClick={handleSaveAnnotation} className="text-xs bg-blue-600 text-white px-2.5 py-1 rounded hover:bg-blue-700 shadow-sm">保存</button>
                                                                            </div>
                                                                        </div>
                                                                    ) : messageAnnotation && (messageAnnotation.annotation_text || messageAnnotation.comment) && (
                                                                        <div className="p-2 bg-blue-50 border border-blue-200 rounded text-xs">
                                                                            <div className="text-[10px] font-semibold text-blue-700 mb-1">{t.doctorAnnotation}</div>
                                                                            <div className="text-xs text-blue-900">{messageAnnotation.annotation_text || messageAnnotation.comment}</div>
                                                                            <div className="flex justify-end mt-1 gap-2">
                                                                                <button
                                                                                    onClick={handleStartEdit}
                                                                                    className="text-[10px] text-blue-600 hover:text-blue-700"
                                                                                >
                                                                                    {t.editAnnotationTitle}
                                                                                </button>
                                                                                <button
                                                                                    onClick={handleDeleteAnnotation}
                                                                                    className="text-[10px] text-red-600 hover:text-red-700"
                                                                                >
                                                                                    {t.deleteAnnotationTitle}
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                            {messageTime && (
                                                                <span className={`text-[10px] text-slate-300 mt-1 px-10 opacity-0 group-hover:opacity-100 transition-opacity`}>
                                                                    {messageTime}
                                                                </span>
                                                            )}
                                                        </div>
                                                    );
                                                })
                                            ) : (
                                                <div className="text-center text-slate-400 py-8">
                                                    <p>{t.noDialogue}</p>
                                                    {signals.summary_text && (
                                                        <p className="text-xs mt-2 text-slate-500 whitespace-pre-line">{signals.summary_text}</p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {/* 折叠按钮（当侧边栏折叠时显示） */}
                                {sidebarCollapsed && (
                                    <button
                                        onClick={() => setSidebarCollapsed(false)}
                                        className="fixed right-6 top-1/2 -translate-y-1/2 w-10 h-20 bg-blue-600 text-white rounded-l-lg shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center z-20 group"
                                        title="展开对话记录"
                                    >
                                        <MessageSquare size={20} className="group-hover:scale-110 transition-transform" />
                                    </button>
                                )}
                            </div>
                        ) : (
                            // 速记模式 - 保持原样，不可滚动
                            <div className="flex flex-col lg:flex-row h-full gap-4">

                                {/* --- 左侧主要区域 (占宽) --- */}
                                <div className={`flex flex-col min-w-0 gap-3 h-full overflow-hidden transition-all duration-300 ${sidebarCollapsed ? 'flex-1' : 'flex-1'
                                    }`}>

                                    {/* 1. 患者信息头 */}
                                    <div className="bg-white px-4 py-3 rounded-xl border border-slate-200 shadow-sm shrink-0 flex flex-col xl:flex-row justify-between xl:items-center gap-4">
                                        <div className="flex items-start gap-3">
                                            <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 border-2 border-slate-50 shadow-inner shrink-0">
                                                <User size={24} />
                                            </div>
                                            <div className="min-w-0">
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <h2 className="text-xl font-bold text-slate-900">{patientName}</h2>
                                                    <div className="flex items-center gap-1.5 text-xs">
                                                        {patientSex && (
                                                            <span className="px-1.5 py-0.5 bg-slate-100 rounded font-semibold text-slate-600">{patientSex}</span>
                                                        )}
                                                        {patientAge && (
                                                            <span className="px-1.5 py-0.5 bg-slate-100 rounded font-semibold text-slate-600">{patientAge} {t.yearsOld}</span>
                                                        )}
                                                    </div>
                                                    {esiLevel !== null && esiLevel !== undefined && (
                                                        <span className="px-1.5 py-0.5 bg-slate-100 rounded text-slate-600 font-mono text-xs">
                                                            ESI {esiLevel}
                                                        </span>
                                                    )}
                                                </div>
                                                {/* 病史信息 */}
                                                <div className="mt-2 pt-2 border-t border-slate-100">
                                                    <div className="text-[10px] font-semibold text-slate-400 uppercase tracking-wider mb-1">{t.medicalHistory}</div>
                                                    <div className="text-xs text-slate-600 space-y-0.5">
                                                        {patient.medical_history && (patient.medical_history.diagnoses_str || (patient.medical_history.diagnoses && patient.medical_history.diagnoses.length > 0)) ? (
                                                            <div>
                                                                <span className="font-medium">{t.diseases}</span>
                                                                <span>{patient.medical_history.diagnoses_str || patient.medical_history.diagnoses.join('、')}</span>
                                                            </div>
                                                        ) : (
                                                            <div>
                                                                <span className="font-medium">{t.diseases}</span>
                                                                <span>无</span>
                                                            </div>
                                                        )}
                                                        {patient.meds && patient.meds.length > 0 && (
                                                            <div>
                                                                <span className="font-medium">{t.currentMedications}</span>
                                                                <span>{patient.meds.join('、')}</span>
                                                            </div>
                                                        )}
                                                        {allergyList && allergyList.length > 0 && (
                                                            <div>
                                                                <span className="font-medium">{t.allergies}</span>
                                                                <span>{allergyList.join('、')}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="w-full max-w-md">
                                            <VitalSignsTable vitals={vitals} signals={signals} isUrgent={isUrgent} />
                                        </div>
                                    </div>

                                    {/* 1.5 触发上下文信息 (Shorthand Mode) */}
                                    <TriggerInfoBlock data={data} t={t} fullMode={false} />

                                    {/* 2. AI 临床分析报告 */}
                                    <div className="flex-1 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                                        <div className="px-4 py-2.5 border-b border-slate-100 flex justify-between items-center bg-slate-50/30">
                                            <div className="flex items-center gap-2">
                                                <div className="bg-blue-100 p-1 rounded text-blue-600"><FileText size={16} /></div>
                                                <h3 className="font-bold text-slate-800 text-sm">{t.aiClinicalAnalysisReport}</h3>
                                            </div>
                                            <span className="text-[10px] font-mono text-slate-400">{new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
                                        </div>

                                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                            <div className="grid grid-cols-1 xl:grid-cols-2 gap-4 max-w-6xl">

                                                {/* 主诉 */}
                                                <div className="xl:col-span-2">
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">{t.chiefComplaintSummary}</label>

                                                    <div className="space-y-3">
                                                        {/* 系统识别的症状 */}
                                                        {data?.symptoms?.system_identified && data.symptoms.system_identified.length > 0 && (
                                                            <div className="p-3 bg-blue-50 rounded-lg border border-blue-100">
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <span className="text-xs font-semibold text-blue-700">{t.systemIdentifiedSymptoms}</span>
                                                                    <span className="px-1.5 py-0.5 bg-blue-200 text-blue-700 text-[10px] rounded">
                                                                        {data.symptoms.system_identified.length} {t.items}
                                                                    </span>
                                                                </div>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {data.symptoms.system_identified.map((symptom, idx) => (
                                                                        <span
                                                                            key={idx}
                                                                            className="px-2.5 py-1 bg-white border border-blue-200 text-blue-700 text-xs rounded-md font-medium"
                                                                        >
                                                                            {symptom}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* 患者自述 */}
                                                        {data?.symptoms?.patient_feedback && data.symptoms.patient_feedback.length > 0 && (
                                                            <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <span className="text-xs font-semibold text-gray-700">{t.patientSelfReport}</span>
                                                                </div>
                                                                <div className="text-gray-700 text-sm">
                                                                    {data.symptoms.patient_feedback.join('、')}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* 如果没有症状数据，显示原来的内容 */}
                                                        {(!data?.symptoms?.system_identified?.length && !data?.symptoms?.patient_feedback?.length) && (
                                                            <div className="p-3 bg-slate-50 rounded-lg border border-slate-100 text-slate-700 text-sm leading-relaxed">
                                                                {patient?.chief_complaint || dialogueMessages?.find(m => m.type === 'patient')?.content || triage.rationale?.substring(0, 200) || '暂无主诉信息'}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* 左栏分析 */}
                                                <div className="space-y-3">
                                                    <AITaskBlock
                                                        title={t.symptomRecognition}
                                                        targetPath={dataPaths.likely_causes}
                                                        targetId={triageId}
                                                        targetKind="triage_result"
                                                        originalValue={triage.likely_causes || []}
                                                        annotations={annotations}
                                                        onAnnotationSave={handleAnnotationSave}
                                                        onAnnotationDelete={handleAnnotationDelete}
                                                    >
                                                        {triage.likely_causes && triage.likely_causes.length > 0 ? (
                                                            <ul className="space-y-1">
                                                                {triage.likely_causes.map((cause, idx) => (
                                                                    <li key={idx} className="flex items-center gap-1.5">
                                                                        <CheckCircle2 size={12} className="text-blue-500 shrink-0" />
                                                                        <span>{cause}</span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        ) : (
                                                            <p className="text-slate-400">暂无症状识别信息</p>
                                                        )}
                                                    </AITaskBlock>

                                                    <div className={`relative rounded-lg p-3 transition-all group ${isUrgent ? 'bg-rose-50/50 border border-rose-100' : 'bg-white border border-slate-200 hover:border-blue-300'}`}>
                                                        <div className="flex justify-between items-center mb-1.5">
                                                            <h4 className={`text-xs font-bold flex items-center gap-1.5 ${isUrgent ? 'text-rose-700' : 'text-slate-700'}`}>
                                                                {isUrgent && <AlertCircle size={12} className="text-rose-500" />}
                                                                {t.triageTitle}
                                                                {(annotations.find(a => a.target_path === dataPaths.urgency_level) || annotations.find(a => a.target_path === dataPaths.next_operation)) && (
                                                                    <span className="ml-2 px-1.5 py-0.5 bg-blue-100 text-blue-700 text-[10px] rounded">已批注</span>
                                                                )}
                                                            </h4>
                                                        </div>

                                                        <div className="space-y-2">
                                                            {/* 紧急程度选择 */}
                                                            <div>
                                                                <label className="text-xs font-medium text-slate-600 mb-1 block">
                                                                    {t.urgencyLabel}
                                                                    <span className="text-slate-400 ml-2 font-normal text-[10px]">
                                                                        {t.urgencySystemPrefix} {originalTriage?.urgency_level || t.urgencyNotSet}）
                                                                    </span>
                                                                </label>
                                                                <select
                                                                    value={doctorTriage.urgency_level !== undefined && doctorTriage.urgency_level !== null ? doctorTriage.urgency_level : (originalTriage?.urgency_level || '')}
                                                                    onChange={(e) => {
                                                                        const newValue = e.target.value;
                                                                        setDoctorTriage({ ...doctorTriage, urgency_level: newValue });

                                                                        // 更新annotation
                                                                        if (newValue !== originalTriage?.urgency_level) {
                                                                            handleAnnotationSave(
                                                                                dataPaths.urgency_level,
                                                                                triageId,
                                                                                "triage_result",
                                                                                originalTriage?.urgency_level || '',
                                                                                newValue,
                                                                                null
                                                                            );
                                                                        } else {
                                                                            handleAnnotationDelete(dataPaths.urgency_level);
                                                                        }
                                                                    }}
                                                                    className="w-full p-2 border border-slate-200 rounded text-xs focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-100"
                                                                >
                                                                    {!originalTriage?.urgency_level && <option value="">{t.urgencyPlaceholder}</option>}
                                                                    {Object.entries(t.urgencyOptions).map(([value, label]) => (
                                                                        <option key={value} value={value}>{label}</option>
                                                                    ))}
                                                                </select>
                                                                <div className="mt-1">
                                                                    <AnnotationInput
                                                                        targetPath={dataPaths.urgency_level}
                                                                        targetId={triageId}
                                                                        targetKind="triage_result"
                                                                        originalValue={originalTriage?.urgency_level || ''}
                                                                        existingAnnotation={annotations.find(a => a.target_path === dataPaths.urgency_level)}
                                                                        onSave={(text) => {
                                                                            const existing = annotations.find(a => a.target_path === dataPaths.urgency_level);
                                                                            handleAnnotationSave(
                                                                                dataPaths.urgency_level,
                                                                                triageId,
                                                                                "triage_result",
                                                                                originalTriage?.urgency_level || '',
                                                                                existing?.modified_value || doctorTriage.urgency_level || null,
                                                                                text
                                                                            );
                                                                        }}
                                                                        onDelete={() => {
                                                                            const existing = annotations.find(a => a.target_path === dataPaths.urgency_level);
                                                                            if (existing?.modified_value) {
                                                                                handleAnnotationSave(
                                                                                    dataPaths.urgency_level,
                                                                                    triageId,
                                                                                    "triage_result",
                                                                                    originalTriage?.urgency_level || '',
                                                                                    existing.modified_value,
                                                                                    null
                                                                                );
                                                                            } else {
                                                                                handleAnnotationDelete(dataPaths.urgency_level);
                                                                            }
                                                                        }}
                                                                        showButton={true}
                                                                    />
                                                                </div>
                                                            </div>

                                                            {/* 建议措施选择 */}
                                                            <div>
                                                                <label className="text-xs font-medium text-slate-600 mb-1 block">
                                                                    {t.nextOperationLabel}
                                                                    <span className="text-slate-400 ml-2 font-normal text-[10px]">
                                                                        {t.nextOperationSystemPrefix} {originalTriage?.next_operation || t.nextOperationNotSet}）
                                                                    </span>
                                                                </label>
                                                                <select
                                                                    value={doctorTriage.next_operation || ''}
                                                                    onChange={(e) => {
                                                                        const newValue = e.target.value;
                                                                        setDoctorTriage({ ...doctorTriage, next_operation: newValue });

                                                                        // 更新annotation
                                                                        if (newValue !== originalTriage?.next_operation) {
                                                                            handleAnnotationSave(
                                                                                dataPaths.next_operation,
                                                                                triageId,
                                                                                "triage_result",
                                                                                originalTriage?.next_operation || '',
                                                                                newValue,
                                                                                null
                                                                            );
                                                                        } else {
                                                                            handleAnnotationDelete(dataPaths.next_operation);
                                                                        }
                                                                    }}
                                                                    className="w-full p-2 border border-slate-200 rounded text-xs focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-100"
                                                                >
                                                                    <option value="">{t.nextOperationPlaceholder}</option>
                                                                    {Object.entries(t.nextOperationOptions).map(([value, label]) => (
                                                                        <option key={value} value={value}>{label}</option>
                                                                    ))}
                                                                </select>
                                                                <div className="mt-1">
                                                                    <AnnotationInput
                                                                        targetPath={dataPaths.next_operation}
                                                                        targetId={triageId}
                                                                        targetKind="triage_result"
                                                                        originalValue={originalTriage?.next_operation || ''}
                                                                        existingAnnotation={annotations.find(a => a.target_path === dataPaths.next_operation)}
                                                                        onSave={(text) => {
                                                                            const existing = annotations.find(a => a.target_path === dataPaths.next_operation);
                                                                            handleAnnotationSave(
                                                                                dataPaths.next_operation,
                                                                                triageId,
                                                                                "triage_result",
                                                                                originalTriage?.next_operation || '',
                                                                                existing?.modified_value || doctorTriage.next_operation || null,
                                                                                text
                                                                            );
                                                                        }}
                                                                        onDelete={() => {
                                                                            const existing = annotations.find(a => a.target_path === dataPaths.next_operation);
                                                                            if (existing?.modified_value) {
                                                                                handleAnnotationSave(
                                                                                    dataPaths.next_operation,
                                                                                    triageId,
                                                                                    "triage_result",
                                                                                    originalTriage?.next_operation || '',
                                                                                    existing.modified_value,
                                                                                    null
                                                                                );
                                                                            } else {
                                                                                handleAnnotationDelete(dataPaths.next_operation);
                                                                            }
                                                                        }}
                                                                        showButton={true}
                                                                    />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* 右栏分析 */}
                                                <div className="space-y-3">
                                                    <AITaskBlock
                                                        title={t.rationale}
                                                        targetPath={dataPaths.rationale}
                                                        targetId={triageId}
                                                        targetKind="triage_result"
                                                        originalValue={triage.rationale || ''}
                                                        annotations={annotations}
                                                        onAnnotationSave={handleAnnotationSave}
                                                        onAnnotationDelete={handleAnnotationDelete}
                                                    >
                                                        <div className="space-y-2">
                                                            <div className="p-2 bg-white rounded border border-slate-100">
                                                                <span className="text-xs text-slate-700">{triage.rationale || t.noRationale}</span>
                                                            </div>
                                                        </div>
                                                    </AITaskBlock>

                                                    <AITaskBlock
                                                        title={t.patientRecommendations}
                                                        targetPath={dataPaths.patient_recommendations || "bundle.data.suggestions.patient"}
                                                        targetId={triageId}
                                                        targetKind="triage_result"
                                                        originalValue={recommendations.join('; ')}
                                                        annotations={annotations}
                                                        onAnnotationSave={handleAnnotationSave}
                                                        onAnnotationDelete={handleAnnotationDelete}
                                                    >
                                                        {recommendations.length > 0 ? (
                                                            <div>
                                                                <div className="text-xs font-medium text-slate-600 mb-1">{t.recommendedAction}</div>
                                                                <ol className="list-decimal list-inside space-y-1 marker:text-slate-400 marker:font-medium">
                                                                    {recommendations.map((rec, idx) => (
                                                                        <li key={idx} className="pl-0.5 text-xs">{rec}</li>
                                                                    ))}
                                                                </ol>
                                                            </div>
                                                        ) : (
                                                            <p className="text-slate-400 text-xs">{t.noPatientRecommendations}</p>
                                                        )}
                                                    </AITaskBlock>

                                                    {/* 医生建议（始终显示） */}
                                                    <AITaskBlock
                                                        title={t.doctorRecommendations}
                                                        targetPath={dataPaths.doctor_recommendations || "bundle.data.suggestions.doctor"}
                                                        targetId={triageId}
                                                        targetKind="triage_result"
                                                        originalValue={doctorRecommendations.join('; ')}
                                                        annotations={annotations}
                                                        onAnnotationSave={handleAnnotationSave}
                                                        onAnnotationDelete={handleAnnotationDelete}
                                                    >
                                                        {doctorRecommendations.length > 0 ? (
                                                            <div>
                                                                <div className="text-xs font-medium text-slate-600 mb-1">{t.recommendedAction}</div>
                                                                <ol className="list-decimal list-inside space-y-1 marker:text-slate-400 marker:font-medium">
                                                                    {doctorRecommendations.map((rec, idx) => (
                                                                        <li key={idx} className="pl-0.5 text-xs">{rec}</li>
                                                                    ))}
                                                                </ol>
                                                            </div>
                                                        ) : (
                                                            <p className="text-slate-400 text-xs">{t.noDoctorRecommendations}</p>
                                                        )}
                                                    </AITaskBlock>
                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                    {/* 3. 医生审核区域 */}
                                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col overflow-hidden shrink-0">
                                        {/* 审核表单 */}
                                        <div className="px-4 py-3 border-t border-slate-100 bg-white">
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-xs font-semibold text-slate-700 mb-1.5">
                                                        {t.reviewComment}
                                                    </label>
                                                    <textarea
                                                        id="doctorComment"
                                                        value={doctorComment}
                                                        onChange={(e) => setDoctorComment(e.target.value)}
                                                        placeholder={t.reviewCommentPlaceholder}
                                                        className="w-full min-h-[60px] p-2.5 border-2 border-slate-200 rounded-lg text-xs font-sans resize-y focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100"
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-xs font-semibold text-slate-700 mb-1.5">
                                                        {t.agreeWithTriage}
                                                    </label>
                                                    <select
                                                        id="doctorAgree"
                                                        value={doctorAgree}
                                                        onChange={(e) => setDoctorAgree(e.target.value)}
                                                        className="w-full p-2.5 border-2 border-slate-200 rounded-lg text-xs focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100"
                                                    >
                                                        <option value="true">{t.agree}</option>
                                                        <option value="false">{t.disagree}</option>
                                                    </select>
                                                </div>

                                                {submitMessage && (
                                                    <div className={`p-2 rounded-lg text-xs ${submitMessage.type === 'success'
                                                        ? 'bg-emerald-50 text-emerald-800 border border-emerald-200'
                                                        : 'bg-rose-50 text-rose-800 border border-rose-200'
                                                        }`}>
                                                        {submitMessage.text}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* 底部提交栏 */}
                                        <div className="p-3 border-t border-slate-100 bg-slate-50 flex items-center justify-between shrink-0">
                                            <div className="flex items-center gap-2 pl-1">
                                                <div className="p-1.5 bg-white rounded-full border border-slate-200 text-slate-400">
                                                    <Stethoscope size={16} />
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">{t.headerReviewer}</span>
                                                    <span className="text-xs font-bold text-slate-800 font-handwriting italic">
                                                        {doctorInfo?.name ? `${doctorInfo.name} (${doctorInfo.occupation || ''})` : 'Dr. Reviewer'} / {new Date().toLocaleDateString(t.dateLocale, t.dateFormat)}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        setDoctorComment('');
                                                        setDoctorAgree('true');
                                                    }}
                                                    className="px-4 py-1.5 bg-white border border-slate-300 text-slate-600 rounded-lg shadow-sm hover:bg-slate-50 hover:text-slate-800 text-xs font-medium transition-all"
                                                >
                                                    {t.reset}
                                                </button>
                                                <button
                                                    onClick={handleSubmit}
                                                    disabled={submitting}
                                                    className="px-4 py-1.5 bg-slate-900 text-white rounded-lg shadow-lg shadow-slate-900/20 hover:bg-slate-800 hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-1.5 text-xs font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    {submitting ? (
                                                        <>
                                                            <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                            <span>{t.submitting}</span>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <CheckCircle2 size={14} />
                                                            <span>{t.confirmSubmit}</span>
                                                        </>
                                                    )}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* --- 右侧：对话记录 (可折叠) --- */}
                                {!sidebarCollapsed && (
                                    <div className="w-[380px] shrink-0 flex flex-col bg-white border border-slate-200 rounded-2xl shadow-sm h-full overflow-hidden transition-all duration-300 ease-in-out animate-in slide-in-from-right">
                                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                            <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                                <MessageSquare size={18} className="text-blue-600" />
                                                {t.dialogueHistory}
                                            </h3>
                                            <div className="flex gap-1">
                                                <button
                                                    onClick={() => setSidebarCollapsed(true)}
                                                    className="p-1.5 hover:bg-slate-100 rounded text-slate-400 transition-colors"
                                                    title="折叠侧边栏"
                                                >
                                                    <Maximize2 size={14} />
                                                </button>
                                            </div>
                                        </div>

                                        <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-white custom-scrollbar">
                                            {chatHistory.length > 0 ? (
                                                chatHistory.map((msg, idx) => {
                                                    const messageText = msg.text || msg.content || '';
                                                    const messageRole = msg.role || (msg.type === 'patient' ? 'patient' : 'ai');
                                                    const messageTime = msg.time || '';
                                                    const targetPath = msg.target_path || '';

                                                    // 查找该消息的批注
                                                    const messageAnnotation = annotations?.find(a => a.target_path === targetPath);
                                                    const isEditing = editingAnnotations[targetPath] || false;
                                                    const inputText = annotationInputs[targetPath] || (messageAnnotation?.annotation_text || messageAnnotation?.comment || '');

                                                    const handleStartEdit = () => {
                                                        setEditingAnnotations(prev => ({ ...prev, [targetPath]: true }));
                                                        setAnnotationInputs(prev => ({ ...prev, [targetPath]: messageAnnotation?.annotation_text || messageAnnotation?.comment || '' }));
                                                    };

                                                    const handleSaveAnnotation = () => {
                                                        const text = inputText.trim();
                                                        if (text) {
                                                            const newAnnotation = {
                                                                target_path: targetPath,
                                                                target_id: msg.question_id || triageId || '',
                                                                target_kind: "question_step",
                                                                annotation_type: "annotation",
                                                                original_value: messageText,
                                                                modified_value: null,
                                                                annotation_text: text,
                                                                annotated_at: new Date().toISOString()
                                                            };
                                                            setAnnotations(prev => {
                                                                const updated = [...(prev || [])];
                                                                const existingIndex = updated.findIndex(a => a.target_path === targetPath);
                                                                if (existingIndex >= 0) {
                                                                    updated[existingIndex] = newAnnotation;
                                                                } else {
                                                                    updated.push(newAnnotation);
                                                                }
                                                                return updated;
                                                            });
                                                        }
                                                        setEditingAnnotations(prev => ({ ...prev, [targetPath]: false }));
                                                    };

                                                    const handleCancelEdit = () => {
                                                        setEditingAnnotations(prev => ({ ...prev, [targetPath]: false }));
                                                        setAnnotationInputs(prev => ({ ...prev, [targetPath]: messageAnnotation?.annotation_text || messageAnnotation?.comment || '' }));
                                                    };

                                                    const handleDeleteAnnotation = () => {
                                                        setAnnotations(prev => prev.filter(a => a.target_path !== targetPath));
                                                        setEditingAnnotations(prev => ({ ...prev, [targetPath]: false }));
                                                        setAnnotationInputs(prev => {
                                                            const newInputs = { ...prev };
                                                            delete newInputs[targetPath];
                                                            return newInputs;
                                                        });
                                                    };

                                                    return (
                                                        <div key={idx} className={`flex flex-col ${messageRole === 'ai' ? 'items-start' : 'items-end'} group relative`}>
                                                            <div className={`flex items-end gap-2 max-w-[92%] ${messageRole === 'patient' ? 'flex-row-reverse' : ''}`}>
                                                                <div className={`w-7 h-7 rounded-full flex items-center justify-center shrink-0 text-[10px] font-bold border shadow-sm ${messageRole === 'ai'
                                                                    ? 'bg-white text-blue-600 border-blue-100'
                                                                    : 'bg-slate-800 text-white border-slate-800'
                                                                    }`}>
                                                                    {messageRole === 'ai' ? 'AI' : t.patientIcon}
                                                                </div>
                                                                <div className={`px-3.5 py-2.5 rounded-2xl text-sm leading-relaxed whitespace-pre-line relative group/message ${messageRole === 'ai'
                                                                    ? 'bg-slate-50 text-slate-700 border border-slate-100 rounded-bl-none'
                                                                    : 'bg-blue-600 text-white shadow-md shadow-blue-600/10 rounded-br-none'
                                                                    }`}>
                                                                    {formatMessageText(messageText)}
                                                                    {/* AI Reasoning 图标 - 仅在AI消息且有reason时显示 */}
                                                                    {messageRole === 'ai' && msg.reason && (
                                                                        <button
                                                                            onClick={() => setExpandedReason(prev => prev === idx ? null : idx)}
                                                                            className={`absolute -top-2 right-2 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-md transition-colors ${expandedReason === idx
                                                                                ? 'bg-amber-600 text-white'
                                                                                : 'bg-amber-400 text-white hover:bg-amber-500'
                                                                                }`}
                                                                            title={expandedReason === idx ? "Hide AI Reasoning" : "View AI Reasoning"}
                                                                        >
                                                                            💡
                                                                        </button>
                                                                    )}
                                                                    {/* 批注按钮 - 鼠标悬停时显示 */}
                                                                    {targetPath && !messageAnnotation && !isEditing && (
                                                                        <button
                                                                            onClick={handleStartEdit}
                                                                            className={`absolute -top-1 ${msg.reason ? '-right-7' : '-right-1'} w-5 h-5 bg-blue-600 text-white rounded-full flex items-center justify-center text-[10px] opacity-0 group-hover/message:opacity-100 transition-opacity shadow-md hover:bg-blue-700`}
                                                                            title={t.addAnnotationTitle}
                                                                        >
                                                                            <MessageSquare size={12} />
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            {/* AI Reasoning 展开区域 */}
                                                            {messageRole === 'ai' && msg.reason && expandedReason === idx && (
                                                                <div className="mt-2 ml-9 max-w-[85%] p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs animate-fadeIn">
                                                                    <div className="text-[10px] font-semibold text-amber-700 mb-1.5 flex items-center gap-1">
                                                                        <span>💡</span> AI Reasoning
                                                                    </div>
                                                                    <div className="text-xs text-amber-900 leading-relaxed">{msg.reason}</div>
                                                                </div>
                                                            )}
                                                            {/* 批注编辑/显示区域 - 使用与AnnotationInput相同的格式 */}
                                                            {(isEditing || messageAnnotation) && (
                                                                <div className={`mt-2 max-w-[92%] ${messageRole === 'ai' ? 'ml-9' : 'mr-9'}`}>
                                                                    {isEditing ? (
                                                                        <div className="p-2 bg-slate-50 border border-slate-200 rounded text-xs">
                                                                            <textarea
                                                                                value={inputText}
                                                                                onChange={(e) => setAnnotationInputs(prev => ({ ...prev, [targetPath]: e.target.value }))}
                                                                                className="w-full text-xs p-2 bg-white border border-slate-200 rounded shadow-sm focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-100"
                                                                                rows="2"
                                                                                placeholder={t.inputAnnotation}
                                                                                autoFocus
                                                                            />
                                                                            <div className="flex justify-end mt-2 gap-2">
                                                                                <button onClick={handleCancelEdit} className="text-xs px-2 py-1 text-slate-500 hover:text-slate-700">取消</button>
                                                                                {messageAnnotation && (
                                                                                    <button onClick={handleDeleteAnnotation} className="text-xs px-2 py-1 text-red-600 hover:text-red-700">删除</button>
                                                                                )}
                                                                                <button onClick={handleSaveAnnotation} className="text-xs bg-blue-600 text-white px-2.5 py-1 rounded hover:bg-blue-700 shadow-sm">保存</button>
                                                                            </div>
                                                                        </div>
                                                                    ) : messageAnnotation && (messageAnnotation.annotation_text || messageAnnotation.comment) && (
                                                                        <div className="p-2 bg-blue-50 border border-blue-200 rounded text-xs">
                                                                            <div className="text-[10px] font-semibold text-blue-700 mb-1">{t.doctorAnnotation}</div>
                                                                            <div className="text-xs text-blue-900">{messageAnnotation.annotation_text || messageAnnotation.comment}</div>
                                                                            <div className="flex justify-end mt-1 gap-2">
                                                                                <button
                                                                                    onClick={handleStartEdit}
                                                                                    className="text-[10px] text-blue-600 hover:text-blue-700"
                                                                                >
                                                                                    {t.editAnnotationTitle}
                                                                                </button>
                                                                                <button
                                                                                    onClick={handleDeleteAnnotation}
                                                                                    className="text-[10px] text-red-600 hover:text-red-700"
                                                                                >
                                                                                    {t.deleteAnnotationTitle}
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                            {messageTime && (
                                                                <span className={`text-[10px] text-slate-300 mt-1 px-10 opacity-0 group-hover:opacity-100 transition-opacity`}>
                                                                    {messageTime}
                                                                </span>
                                                            )}
                                                        </div>
                                                    );
                                                })
                                            ) : (
                                                <div className="text-center text-slate-400 py-8">
                                                    <p>{t.noDialogue}</p>
                                                    {signals.summary_text && (
                                                        <p className="text-xs mt-2 text-slate-500 whitespace-pre-line">{signals.summary_text}</p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {/* 折叠按钮（当侧边栏折叠时显示） */}
                                {sidebarCollapsed && (
                                    <button
                                        onClick={() => setSidebarCollapsed(false)}
                                        className="fixed right-6 top-1/2 -translate-y-1/2 w-10 h-20 bg-blue-600 text-white rounded-l-lg shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center z-20 group"
                                        title="展开对话记录"
                                    >
                                        <MessageSquare size={20} className="group-hover:scale-110 transition-transform" />
                                    </button>
                                )}

                            </div>
                        )
                        }
                    </main >
                </div >
            );
        }

        // 等待 DOM 加载完成后再渲染
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const rootElement = document.getElementById('root');
                    if (rootElement) {
                        const root = ReactDOM.createRoot(rootElement);
                        root.render(<TriageReviewApp />);
                    } else {
                        console.error('Root element not found');
                    }
                } catch (error) {
                    console.error('React render error:', error);
                    document.getElementById('root').innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <h2 style="color: red;">页面加载错误</h2>
                            <p>${error.message}</p>
                            <p style="color: #666; font-size: 12px;">请检查浏览器控制台获取更多信息</p>
                        </div>
                    `;
                }
            });
        } else {
            try {
                const rootElement = document.getElementById('root');
                if (rootElement) {
                    const root = ReactDOM.createRoot(rootElement);
                    root.render(<TriageReviewApp />);
                } else {
                    console.error('Root element not found');
                }
            } catch (error) {
                console.error('React render error:', error);
                document.getElementById('root').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h2 style="color: red;">页面加载错误</h2>
                        <p>${error.message}</p>
                        <p style="color: #666; font-size: 12px;">请检查浏览器控制台获取更多信息</p>
                    </div>
                `;
            }
        }
    </script>
</body>

</html>