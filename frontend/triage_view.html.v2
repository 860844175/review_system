<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†è¯Šå®¡æ ¸ - MediAssist</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- å¼•å…¥ Babel ç”¨äºè§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- å­—ä½“é…ç½® -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        /* æ¨¡æ‹Ÿæ‰‹å†™ç­¾å */
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');
        .font-handwriting {
            font-family: 'Dancing Script', cursive;
        }
    </style>
</head>
<body class="bg-slate-50/50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- å›¾æ ‡ç»„ä»¶å®šä¹‰ (Lucide Icons) ---
        const IconWrapper = ({ size = 24, className, children, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Activity = (props) => <IconWrapper {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const User = (props) => <IconWrapper {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>;
        const FileText = (props) => <IconWrapper {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconWrapper>;
        const MessageSquare = (props) => <IconWrapper {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconWrapper>;
        const AlertCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>;
        const CheckCircle2 = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconWrapper>;
        const Edit3 = (props) => <IconWrapper {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconWrapper>;
        const Stethoscope = (props) => <IconWrapper {...props}><path d="M4.8 2.3A.3.3 0 0 0 5 2.5h3.5a.3.3 0 0 0 .2-.2l.1-1a.3.3 0 0 0-.3-.3H5.1a.3.3 0 0 0-.3.3l0 1ZM6.5 2.5V7a5.5 5.5 0 0 0 10.8 2l.2-1a.3.3 0 0 0-.3-.3h-3.5a.3.3 0 0 0-.3.3l.1 1a3.5 3.5 0 0 1-6.8 0V2.5"/><path d="M12 19.5v-7"/><path d="M9 19.5a3 3 0 1 0 6 0"/></IconWrapper>;
        const ChevronRight = (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>;
        const Clock = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>;
        const Heart = (props) => <IconWrapper {...props}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></IconWrapper>;
        const Pill = (props) => <IconWrapper {...props}><rect x="8" y="2" width="8" height="20" rx="4"/><path d="M8 12h8"/></IconWrapper>;
        const TrendingUp = (props) => <IconWrapper {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;

        // --- é¡¶éƒ¨å¯¼èˆªæ  ---
        const Header = ({ taskId }) => (
            <header className="h-16 bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                <div className="max-w-[1600px] mx-auto h-full px-6 flex items-center justify-between">
                    {/* å·¦ä¾§ï¼šLogo ä¸ é¢åŒ…å±‘ */}
                    <div className="flex items-center gap-6">
                        <div className="flex items-center gap-2.5">
                            <div className="bg-blue-600 p-1.5 rounded-lg text-white shadow-md shadow-blue-600/20">
                                <Activity size={20} />
                            </div>
                            <span className="font-bold text-slate-800 text-lg tracking-tight">MediAssist</span>
                        </div>

                        <div className="h-6 w-px bg-slate-200"></div>

                        <div className="flex items-center gap-2 text-sm text-slate-500">
                            <span className="px-2 py-1 bg-slate-100 rounded text-slate-600 font-medium">åˆ†è¯Šå®¡æ ¸</span>
                            {taskId && (
                                <>
                                    <ChevronRight size={14} className="text-slate-300" />
                                    <span className="font-mono text-slate-400">{taskId}</span>
                                </>
                            )}
                        </div>
                    </div>

                    {/* å³ä¾§ï¼šç”¨æˆ·ä¿¡æ¯ */}
                    <div className="flex items-center gap-3 pl-2">
                        <div className="text-right hidden sm:block">
                            <p className="text-xs font-bold text-slate-700">å®¡æ ¸åŒ»å¸ˆ</p>
                            <p className="text-[10px] text-slate-400 uppercase">Reviewer</p>
                        </div>
                        <div className="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center text-xs font-bold">
                            DR
                        </div>
                    </div>
                </div>
            </header>
        );

        // --- ç”Ÿç†æŒ‡æ ‡è¡¨æ ¼ç»„ä»¶ï¼ˆç´§å‡‘ç‰ˆï¼‰ ---
        const VitalSignsTable = ({ vitals, signals, isUrgent }) => {
            // æ ¼å¼åŒ–è¡€å‹
            const formatBloodPressure = (bp) => {
                if (typeof bp === 'object' && bp !== null) {
                    const systolic = bp['æ”¶ç¼©å‹'] || bp['systolic'] || bp['æ”¶ç¼©'];
                    const diastolic = bp['èˆ’å¼ å‹'] || bp['diastolic'] || bp['èˆ’å¼ '];
                    if (systolic && diastolic) {
                        return `${systolic}/${diastolic}`;
                    }
                }
                return bp || '--';
            };

            // è·å–å½“å‰å€¼å’ŒåŸºçº¿å€¼
            const getCurrentValue = (key, signalsKey) => {
                if (signalsKey && signals.metrics && signals.metrics[signalsKey]) {
                    const val = signals.metrics[signalsKey].mean || signals.metrics[signalsKey];
                    return typeof val === 'number' ? Math.round(val * 10) / 10 : val;
                }
                return vitals[key] || vitals[signalsKey] || '--';
            };

            // è®¡ç®—è¶‹åŠ¿
            const getTrend = (current, baseline) => {
                if (!current || !baseline || current === '--' || baseline === '--') return null;
                const curr = typeof current === 'number' ? current : parseFloat(current);
                const base = typeof baseline === 'number' ? baseline : parseFloat(baseline);
                if (isNaN(curr) || isNaN(base)) return null;
                const change = Math.abs((curr - base) / base);
                if (change < 0.05) return 'stable';
                return curr > base ? 'up' : 'down';
            };

            const indicators = [
                {
                    label: 'è¡€å‹',
                    current: signals.metrics?.blood_pressure 
                        ? `${Math.round(signals.metrics.blood_pressure.systolic?.mean || signals.metrics.blood_pressure.systolic)}/${Math.round(signals.metrics.blood_pressure.diastolic?.mean || signals.metrics.blood_pressure.diastolic)}`
                        : formatBloodPressure(vitals['è¡€å‹'] || vitals['blood_pressure']),
                    baseline: formatBloodPressure(vitals['è¡€å‹'] || vitals['blood_pressure']),
                    unit: 'mmHg',
                    trend: getTrend(
                        signals.metrics?.blood_pressure?.systolic?.mean || signals.metrics?.blood_pressure?.systolic,
                        vitals['è¡€å‹']?.['æ”¶ç¼©å‹'] || vitals['è¡€å‹']?.['systolic'] || vitals['blood_pressure']?.['systolic']
                    )
                },
                {
                    label: 'å¿ƒç‡',
                    current: getCurrentValue('å¿ƒç‡', 'heart_rate') || getCurrentValue('heart_rate', null) || getCurrentValue('å¿ƒç‡(æ¬¡/åˆ†)', null),
                    baseline: vitals['å¿ƒç‡'] || vitals['heart_rate'] || vitals['å¿ƒç‡(æ¬¡/åˆ†)'] || '--',
                    unit: 'bpm',
                    trend: getTrend(
                        signals.metrics?.heart_rate?.mean || signals.metrics?.heart_rate,
                        vitals['å¿ƒç‡'] || vitals['heart_rate'] || vitals['å¿ƒç‡(æ¬¡/åˆ†)']
                    )
                },
                {
                    label: 'è¡€æ°§',
                    current: signals.metrics?.spo2?.mean || vitals['è¡€æ°§'] || vitals['spo2'] || vitals['è¡€æ°§é¥±å’Œåº¦'] || '--',
                    baseline: vitals['è¡€æ°§'] || vitals['spo2'] || vitals['è¡€æ°§é¥±å’Œåº¦'] || '--',
                    unit: '%',
                    trend: getTrend(
                        signals.metrics?.spo2?.mean,
                        vitals['è¡€æ°§'] || vitals['spo2'] || vitals['è¡€æ°§é¥±å’Œåº¦']
                    )
                },
                {
                    label: 'ä½“æ¸©',
                    current: signals.metrics?.temperature?.mean 
                        ? (Math.round(signals.metrics.temperature.mean * 10) / 10)
                        : (vitals['ä½“æ¸©'] || vitals['temperature'] || vitals['ä½“æ¸©(â„ƒ)'] || '--'),
                    baseline: vitals['ä½“æ¸©'] || vitals['temperature'] || vitals['ä½“æ¸©(â„ƒ)'] || '--',
                    unit: 'â„ƒ',
                    trend: getTrend(
                        signals.metrics?.temperature?.mean,
                        vitals['ä½“æ¸©'] || vitals['temperature'] || vitals['ä½“æ¸©(â„ƒ)']
                    )
                }
            ].filter(ind => ind.current !== '--' || ind.baseline !== '--');

            return (
                <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <table className="w-full text-xs">
                        <thead className="bg-slate-50">
                            <tr>
                                <th className="px-3 py-1.5 text-left font-semibold text-slate-600 text-[10px] uppercase">æŒ‡æ ‡</th>
                                <th className="px-3 py-1.5 text-right font-semibold text-slate-600 text-[10px] uppercase">å½“å‰å€¼</th>
                                <th className="px-3 py-1.5 text-right font-semibold text-slate-600 text-[10px] uppercase">åŸºçº¿å€¼</th>
                                <th className="px-3 py-1.5 text-center font-semibold text-slate-600 text-[10px] uppercase">è¶‹åŠ¿</th>
                            </tr>
                        </thead>
                        <tbody>
                            {indicators.map((ind, idx) => {
                                const trendIcon = ind.trend === 'up' ? 'â†‘' : ind.trend === 'down' ? 'â†“' : 'â†’';
                                const trendColor = ind.trend === 'up' ? 'text-red-500' : ind.trend === 'down' ? 'text-blue-500' : 'text-slate-400';
                                return (
                                    <tr key={idx} className="border-t border-slate-100 hover:bg-slate-50/50">
                                        <td className="px-3 py-2 font-medium text-slate-700">{ind.label}</td>
                                        <td className="px-3 py-2 text-right font-semibold text-slate-900">
                                            {ind.current}{ind.unit}
                                        </td>
                                        <td className="px-3 py-2 text-right text-slate-500">
                                            {ind.baseline}{ind.unit}
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            {ind.trend && (
                                                <span className={`font-bold ${trendColor}`} title={ind.trend === 'up' ? 'ä¸Šå‡' : ind.trend === 'down' ? 'ä¸‹é™' : 'ç¨³å®š'}>
                                                    {trendIcon}
                                                </span>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- ä¿¡æ¯å¡ç‰‡ç»„ä»¶ ---
        const InfoCard = ({ title, icon: Icon, children, urgent = false }) => (
            <div className={`rounded-lg p-4 transition-all ${urgent ? 'bg-rose-50/50 border border-rose-100' : 'bg-white border border-slate-200'}`}>
                <div className="flex items-center gap-2 mb-3">
                    {Icon && <Icon size={18} className={urgent ? 'text-rose-600' : 'text-blue-600'} />}
                    <h4 className={`text-sm font-bold ${urgent ? 'text-rose-700' : 'text-slate-700'}`}>
                        {title}
                    </h4>
                </div>
                <div className="text-sm text-slate-600 leading-relaxed">
                    {children}
                </div>
            </div>
        );

        // --- ä¸»åº”ç”¨ç»„ä»¶ ---
        function TriageReviewApp() {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);
            const [doctorComment, setDoctorComment] = useState('');
            const [doctorAgree, setDoctorAgree] = useState('true');
            const [submitting, setSubmitting] = useState(false);
            const [submitMessage, setSubmitMessage] = useState(null);

            // ä»URLè·å–task_id
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('task_id');

            // åŠ è½½æ•°æ®
            useEffect(() => {
                if (!taskId) {
                    setError('ç¼ºå°‘task_idå‚æ•°');
                    setLoading(false);
                    return;
                }

                // è·å–ç«¯å£å·ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼5001
                const portNumber = window.location.port || (window.location.protocol === 'https:' ? '443' : '5001');
                // æ„å»ºAPIåŸºç¡€URL
                const apiBaseUrl = `${window.location.protocol}//${window.location.hostname}:${portNumber}`;

                const loadData = async () => {
                    try {
                        const response = await fetch(
                            `${apiBaseUrl}/api/diagnosis-system/triage-view/by-task?task_id=${taskId}`
                        );

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const result = await response.json();

                        if (!result.success) {
                            throw new Error(result.error || 'è·å–æ•°æ®å¤±è´¥');
                        }

                        setData(result.data);
                    } catch (err) {
                        console.error('åŠ è½½åˆ†è¯Šè§†å›¾å¤±è´¥:', err);
                        setError(`åŠ è½½å¤±è´¥: ${err.message}`);
                    } finally {
                        setLoading(false);
                    }
                };

                loadData();
            }, [taskId]);

            // æäº¤å®¡æ ¸
            const handleSubmit = async () => {
                if (!taskId || !data) {
                    alert('æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™å†è¯•');
                    return;
                }

                setSubmitting(true);
                setSubmitMessage(null);

                // è·å–ç«¯å£å·ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼5001
                const portNumber = window.location.port || (window.location.protocol === 'https:' ? '443' : '5001');
                // æ„å»ºAPIåŸºç¡€URL
                const apiBaseUrl = `${window.location.protocol}//${window.location.hostname}:${portNumber}`;

                try {
                    const response = await fetch(`${apiBaseUrl}/api/diagnosis-system/triage-review/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            decision: {
                                final_path: data.triage?.path || 'home',
                                final_esi_level: data.triage?.esi_level || null,
                                doctor_agree_with_system: doctorAgree === 'true',
                                doctor_comment: doctorComment || 'æ— '
                            },
                            annotations: []
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        setSubmitMessage({ type: 'success', text: 'âœ… å®¡æ ¸æäº¤æˆåŠŸï¼' });
                        // ç¦ç”¨è¡¨å•
                        document.getElementById('doctorComment').disabled = true;
                        document.getElementById('doctorAgree').disabled = true;
                    } else {
                        throw new Error(result.error || 'æäº¤å¤±è´¥');
                    }
                } catch (err) {
                    console.error('æäº¤å®¡æ ¸å¤±è´¥:', err);
                    setSubmitMessage({ type: 'error', text: `âŒ æäº¤å¤±è´¥: ${err.message}` });
                } finally {
                    setSubmitting(false);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-slate-50/50">
                        <Header taskId={taskId} />
                        <div className="flex items-center justify-center h-[calc(100vh-4rem)]">
                            <div className="text-center">
                                <div className="w-12 h-12 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                                <p className="text-slate-600">æ­£åœ¨åŠ è½½åˆ†è¯Šæ•°æ®...</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-slate-50/50">
                        <Header taskId={taskId} />
                        <div className="flex items-center justify-center h-[calc(100vh-4rem)]">
                            <div className="bg-rose-50 border border-rose-200 rounded-lg p-6 max-w-md">
                                <div className="flex items-center gap-3 mb-2">
                                    <AlertCircle size={20} className="text-rose-600" />
                                    <h3 className="font-bold text-rose-800">åŠ è½½å¤±è´¥</h3>
                                </div>
                                <p className="text-rose-700">{error}</p>
                            </div>
                        </div>
                    </div>
                );
            }

            const triage = data.triage || {};
            const patient = data.patient || {};
            const signals = data.signals || {};
            const suggestions = data.suggestions || {};

            const urgencyLevel = triage.urgency_level || '';
            const esiLevel = triage.esi_level;
            const path = triage.path || 'home';
            const isUrgent = path === 'immediate' || (esiLevel !== null && esiLevel <= 3);

            const demographics = patient.demographics || {};
            const vitals = patient.baseline_vitals || {};

            // è·å–ç´§æ€¥å¾½ç« é¢œè‰²
            const getUrgencyBadgeClass = (level) => {
                const l = (level || '').toLowerCase();
                if (l.includes('ç´§æ€¥') || l.includes('urgent') || l.includes('emergent')) {
                    return 'bg-rose-600';
                } else if (l.includes('å…³æ³¨')) {
                    return 'bg-amber-500';
                } else {
                    return 'bg-emerald-600';
                }
            };

            // æ ¹æ®pathå†³å®šæ˜¾ç¤ºå“ªä¸ªå»ºè®®
            const suggestionsToShow = path === 'immediate' 
                ? (suggestions.doctor || [])
                : (suggestions.patient || []);

            // æ ¼å¼åŒ–è¡€å‹æ˜¾ç¤º
            const formatBloodPressure = (bp) => {
                if (typeof bp === 'object' && bp !== null) {
                    const systolic = bp['æ”¶ç¼©å‹'] || bp['systolic'] || bp['æ”¶ç¼©'];
                    const diastolic = bp['èˆ’å¼ å‹'] || bp['diastolic'] || bp['èˆ’å¼ '];
                    if (systolic && diastolic) {
                        return `${systolic}/${diastolic}`;
                    }
                }
                return bp;
            };

            // è·å–æ‚£è€…å§“åï¼ˆå¯èƒ½åœ¨ä¸åŒå­—æ®µï¼‰
            const patientName = demographics['å§“å'] || demographics['name'] || demographics['æ‚£è€…å§“å'] || 'æ‚£è€…';
            const patientAge = demographics['å¹´é¾„'] || demographics['age'];
            const patientSex = demographics['æ€§åˆ«'] || demographics['sex'];

            return (
                <div className="min-h-screen bg-slate-50/50 font-sans text-slate-800">
                    <Header taskId={taskId} />

                    <main className="max-w-[1600px] mx-auto p-6">
                        <div className="flex flex-col lg:flex-row gap-6">
                            
                            {/* --- å·¦ä¾§ä¸»è¦åŒºåŸŸ --- */}
                            <div className="flex-1 flex flex-col min-w-0 gap-5">
                                
                                {/* 1. æ‚£è€…ä¿¡æ¯å¤´ */}
                                <div className="bg-white px-6 py-5 rounded-2xl border border-slate-200 shadow-sm shrink-0 flex flex-col xl:flex-row justify-between xl:items-center gap-6">
                                    <div className="flex items-start gap-5">
                                        <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 border-4 border-slate-50 shadow-inner">
                                            <User size={32} />
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-3">
                                                <h2 className="text-2xl font-bold text-slate-900">
                                                    {patientName}
                                                </h2>
                                                <div className="flex items-center gap-2 text-sm">
                                                    {patientSex && (
                                                        <span className="px-2 py-0.5 bg-slate-100 rounded-md font-semibold text-slate-600">
                                                            {patientSex}
                                                        </span>
                                                    )}
                                                    {patientAge && (
                                                        <span className="px-2 py-0.5 bg-slate-100 rounded-md font-semibold text-slate-600">
                                                            {patientAge}å²
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="mt-2 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-slate-500">
                                                {urgencyLevel && (
                                                    <span className={`inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded text-white font-semibold ${getUrgencyBadgeClass(urgencyLevel)}`}>
                                                        <AlertCircle size={14} />
                                                        <span>{urgencyLevel}</span>
                                                    </span>
                                                )}
                                                {esiLevel !== null && esiLevel !== undefined && (
                                                    <span className="px-2 py-0.5 bg-slate-100 rounded text-slate-600 font-mono">
                                                        ESI {esiLevel}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="w-full max-w-md">
                                        <VitalSignsTable vitals={vitals} signals={signals} isUrgent={isUrgent} />
                                    </div>
                                </div>

                                {/* 2. è·¯å¾„åˆ†æ”¯æŒ‡ç¤º */}
                                {path && (
                                    <div className={`px-4 py-3 rounded-xl font-semibold ${
                                        path === 'immediate' 
                                            ? 'bg-rose-50 text-rose-800 border border-rose-200' 
                                            : 'bg-emerald-50 text-emerald-800 border border-emerald-200'
                                    }`}>
                                        {path === 'immediate' ? 'ğŸš¨ å»ºè®®ç«‹å³å°±åŒ»/æ€¥è¯Šå¤„ç†' : 'ğŸ  å±…å®¶è§‚å¯Ÿ/å¤æŸ¥å»ºè®®'}
                                    </div>
                                )}

                                {/* 3. åˆ†è¯Šç»“è®º */}
                                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                    <div className="flex items-center gap-2 mb-4">
                                        <div className="bg-blue-100 p-1.5 rounded text-blue-600">
                                            <FileText size={18} />
                                        </div>
                                        <h3 className="font-bold text-slate-800">åˆ†è¯Šç»“è®º</h3>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <InfoCard title="ä¸‹ä¸€æ­¥æ“ä½œ">
                                            <p className="font-medium text-slate-800">
                                                {triage.next_operation || 'æš‚æ— '}
                                            </p>
                                        </InfoCard>

                                        <InfoCard title="åˆ¤æ–­ç†ç”±">
                                            <p>{triage.rationale || 'æš‚æ— '}</p>
                                        </InfoCard>

                                        {triage.likely_causes && triage.likely_causes.length > 0 && (
                                            <InfoCard title="å¯èƒ½åŸå› ">
                                                <ul className="space-y-2">
                                                    {triage.likely_causes.map((cause, idx) => (
                                                        <li key={idx} className="flex items-center gap-2">
                                                            <CheckCircle2 size={14} className="text-blue-500 shrink-0" />
                                                            <span>{cause}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </InfoCard>
                                        )}
                                    </div>
                                </div>

                                {/* 4. æ‚£è€…è¯¦ç»†ä¿¡æ¯ */}
                                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                    <div className="flex items-center gap-2 mb-4">
                                        <User size={18} className="text-blue-600" />
                                        <h3 className="font-bold text-slate-800">æ‚£è€…ä¿¡æ¯</h3>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        {/* ç”¨è¯åˆ—è¡¨ */}
                                        {patient.meds && patient.meds.length > 0 && (
                                            <div>
                                                <h4 className="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                                    <Pill size={16} className="text-slate-500" />
                                                    å½“å‰ç”¨è¯
                                                </h4>
                                                <ul className="space-y-2">
                                                    {patient.meds.map((med, idx) => {
                                                        // å¤„ç†medå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å¯¹è±¡çš„æƒ…å†µ
                                                        const medName = typeof med === 'string' 
                                                            ? med 
                                                            : (med.name || med.drug_name || med['è¯å“åç§°'] || '');
                                                        const medDose = typeof med === 'object' && med.dose ? med.dose : null;
                                                        return (
                                                            <li key={idx} className="px-3 py-2 bg-slate-50 rounded-lg border border-slate-200 text-sm">
                                                                <span className="font-medium">{medName}</span>
                                                                {medDose && <span className="text-slate-500 ml-2">- {medDose}</span>}
                                                            </li>
                                                        );
                                                    })}
                                                </ul>
                                            </div>
                                        )}

                                        {/* ä¿¡å·æ‘˜è¦ */}
                                        {signals.summary_text && (
                                            <div>
                                                <h4 className="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                                    <TrendingUp size={16} className="text-slate-500" />
                                                    ä¿¡å·æ‘˜è¦
                                                </h4>
                                                <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-200">
                                                    {signals.summary_text}
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* 5. å»ºè®® */}
                                {suggestionsToShow.length > 0 && (
                                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                        <div className="flex items-center gap-2 mb-4">
                                            <Heart size={18} className="text-blue-600" />
                                            <h3 className="font-bold text-slate-800">å»ºè®®</h3>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {suggestionsToShow.map((suggestion, index) => {
                                                const outputJson = suggestion.output_json || '';
                                                let content = '';
                                                
                                                if (typeof outputJson === 'string') {
                                                    content = outputJson;
                                                } else if (Array.isArray(outputJson)) {
                                                    content = outputJson.map(item => {
                                                        if (typeof item === 'string') {
                                                            return item;
                                                        } else if (item.advice) {
                                                            return item.advice.map(advice => 
                                                                `${item.category || ''}: ${advice}`
                                                            ).join('\n');
                                                        }
                                                        return '';
                                                    }).join('\n');
                                                }
                                                
                                                return (
                                                    <div key={index} className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                                        <div className="text-xs font-semibold text-blue-600 mb-2">
                                                            {path === 'immediate' ? `åŒ»ç”Ÿå»ºè®® ${index + 1}` : `æ‚£è€…å»ºè®® ${index + 1}`}
                                                        </div>
                                                        <div className="text-sm text-slate-700 whitespace-pre-line">
                                                            {content || 'æš‚æ— å†…å®¹'}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                {/* 6. åŒ»ç”Ÿå®¡æ ¸åŒºåŸŸ */}
                                <div className="bg-white rounded-2xl border-2 border-emerald-200 shadow-sm p-6">
                                    <div className="flex items-center gap-2 mb-4">
                                        <Stethoscope size={18} className="text-emerald-600" />
                                        <h3 className="font-bold text-slate-800">åŒ»ç”Ÿå®¡æ ¸</h3>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                                                å®¡æ ¸æ„è§ï¼š
                                            </label>
                                            <textarea 
                                                id="doctorComment"
                                                value={doctorComment}
                                                onChange={(e) => setDoctorComment(e.target.value)}
                                                placeholder="è¯·è¾“å…¥å®¡æ ¸æ„è§..."
                                                className="w-full min-h-[100px] p-3 border-2 border-slate-200 rounded-lg text-sm font-sans resize-y focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100"
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                                                æ˜¯å¦åŒæ„ç³»ç»Ÿåˆ†è¯Šç»“è®ºï¼š
                                            </label>
                                            <select 
                                                id="doctorAgree"
                                                value={doctorAgree}
                                                onChange={(e) => setDoctorAgree(e.target.value)}
                                                className="w-full p-3 border-2 border-slate-200 rounded-lg text-sm focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100"
                                            >
                                                <option value="true">åŒæ„</option>
                                                <option value="false">ä¸åŒæ„</option>
                                            </select>
                                        </div>
                                        
                                        <button 
                                            onClick={handleSubmit}
                                            disabled={submitting}
                                            className="w-full px-6 py-3 bg-slate-900 text-white rounded-lg shadow-lg shadow-slate-900/20 hover:bg-slate-800 hover:shadow-xl hover:-translate-y-0.5 flex items-center justify-center gap-2 text-sm font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {submitting ? (
                                                <>
                                                    <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                    <span>æäº¤ä¸­...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <CheckCircle2 size={16} />
                                                    <span>ç¡®è®¤å¹¶æäº¤</span>
                                                </>
                                            )}
                                        </button>
                                        
                                        {submitMessage && (
                                            <div className={`p-3 rounded-lg text-sm ${
                                                submitMessage.type === 'success' 
                                                    ? 'bg-emerald-50 text-emerald-800 border border-emerald-200' 
                                                    : 'bg-rose-50 text-rose-800 border border-rose-200'
                                            }`}>
                                                {submitMessage.text}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        // ç­‰å¾… DOM åŠ è½½å®Œæˆåå†æ¸²æŸ“
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const rootElement = document.getElementById('root');
                    if (rootElement) {
                        const root = ReactDOM.createRoot(rootElement);
                        root.render(<TriageReviewApp />);
                    } else {
                        console.error('Root element not found');
                    }
                } catch (error) {
                    console.error('React render error:', error);
                    document.getElementById('root').innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <h2 style="color: red;">é¡µé¢åŠ è½½é”™è¯¯</h2>
                            <p>${error.message}</p>
                            <p style="color: #666; font-size: 12px;">è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯</p>
                        </div>
                    `;
                }
            });
        } else {
            try {
                const rootElement = document.getElementById('root');
                if (rootElement) {
                    const root = ReactDOM.createRoot(rootElement);
                    root.render(<TriageReviewApp />);
                } else {
                    console.error('Root element not found');
                }
            } catch (error) {
                console.error('React render error:', error);
                document.getElementById('root').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h2 style="color: red;">é¡µé¢åŠ è½½é”™è¯¯</h2>
                        <p>${error.message}</p>
                        <p style="color: #666; font-size: 12px;">è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
